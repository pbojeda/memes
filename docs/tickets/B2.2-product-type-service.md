# B2.2: Implement product type service

**Sprint:** 2
**Type:** Backend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint2-B2.2-product-type-service
**Created:** 2026-02-09
**Dependencies:** B2.1 (ProductType model + migration + domain errors) ✅

---

## Description

Implement the application service and validator for ProductType CRUD operations. This follows the established functional service pattern (like `authService.ts`) and validator pattern (like `authValidator.ts`), using Prisma directly (no repository layer per project architecture).

The service manages product type categories (t-shirt, mug, hoodie, etc.) with localized names (JSON), unique slugs, size support flags, active status, and sort ordering.

---

## Acceptance Criteria

- [x] `productTypeValidator.ts` validates all CRUD inputs with typed input/output interfaces
- [x] `productTypeService.ts` implements create, getById, getAll, update, delete operations
- [x] Create operation validates input and checks for slug uniqueness
- [x] GetById throws `ProductTypeNotFoundError` when not found
- [x] GetAll is role-aware: TARGET/public callers only see active product types; ADMIN/staff callers see all (with `isActive` field included)
- [x] GetAll supports explicit `isActive` filter override and orders by `sortOrder`
- [x] Update validates input, checks slug uniqueness (excluding self), throws not found
- [x] Delete throws `ProductTypeNotFoundError` when not found
- [x] Delete does NOT check for associated products (deferred to Sprint 3 per ADR-002)
- [x] Validator throws `InvalidProductTypeDataError` for invalid inputs
- [x] `api-spec.yaml` updated with role-based behavior description on `GET /product-types`
- [x] Unit tests for `productTypeValidator.ts` cover valid inputs, edge cases, and all validation rules
- [x] Unit tests for `productTypeService.ts` cover all operations, error cases, and Prisma interactions
- [x] All tests pass (89 new tests, 330 total)
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/application/validators/productTypeValidator.ts` | Input validation for ProductType CRUD |
| `backend/src/application/validators/productTypeValidator.test.ts` | Validator unit tests |
| `backend/src/application/services/productTypeService.ts` | ProductType CRUD service |
| `backend/src/application/services/productTypeService.test.ts` | Service unit tests |
| `ai-specs/specs/api-spec.yaml` | Add role-based description to GET /product-types |

---

## Implementation Steps

### Step 1: Create ProductType Validator

Define input/output types and validation functions:

**Types:**
- `CreateProductTypeInput` / `ValidatedCreateProductTypeInput` — name (JSON with at least `es` key), slug (required, URL-friendly), hasSizes (optional boolean), isActive (optional boolean), sortOrder (optional integer)
- `UpdateProductTypeInput` / `ValidatedUpdateProductTypeInput` — all fields optional
- `GetAllProductTypesInput` / `ValidatedGetAllProductTypesInput` — isActive filter (optional boolean), callerRole (required, from `UserRole | 'PUBLIC'`)

**Validation rules:**
- `name`: Must be a non-null object with at least an `es` key; each value must be a non-empty string; max 100 chars per value
- `slug`: Required, non-empty, lowercase alphanumeric + hyphens only, max 100 chars, auto-trim
- `hasSizes`: Optional, must be boolean if provided
- `isActive`: Optional, must be boolean if provided
- `sortOrder`: Optional, must be non-negative integer if provided
- Throw `InvalidProductTypeDataError` with appropriate field name for failures

### Step 2: Write Validator Tests (TDD - Red)

Test all validation functions:
- Valid inputs return validated output
- Name validation: missing name, missing `es` key, empty string values, non-string values, too long values
- Slug validation: missing, empty, invalid characters, too long, trimming, uppercase rejection
- Boolean fields: valid true/false, non-boolean rejected
- SortOrder: valid integer, negative rejected, non-integer rejected
- Update: partial updates allowed, empty update allowed

### Step 3: Implement Validator (TDD - Green)

Implement validation functions to pass all tests.

### Step 4: Create ProductType Service

Define service functions following `authService.ts` pattern:

```typescript
export async function createProductType(input: CreateProductTypeInput): Promise<ProductType>
export async function getProductTypeById(id: string): Promise<ProductType>
export async function getAllProductTypes(input: GetAllProductTypesInput): Promise<ProductType[]>
export async function updateProductType(id: string, input: UpdateProductTypeInput): Promise<ProductType>
export async function deleteProductType(id: string): Promise<void>
```

**Business logic:**
- `create`: Validate input → check slug uniqueness → prisma.productType.create
- `getById`: Validate UUID → prisma.productType.findUnique → throw not found if null
- `getAll`: Validate input → determine isActive filter:
  - If `callerRole` is `TARGET` or `PUBLIC`: force `isActive: true` (ignore any explicit filter)
  - If `callerRole` is `ADMIN`/`MANAGER`/`MARKETING`: use explicit `isActive` filter if provided, otherwise return all
  - Always orderBy `sortOrder` asc
- `update`: Validate input → find existing → if slug changed, check uniqueness → prisma.productType.update
- `delete`: Find existing → throw not found if null → prisma.productType.delete (no associated products check until Sprint 3)

### Step 5: Write Service Tests (TDD - Red)

Mock `prisma` and validator. Test:
- `createProductType`: success, slug already exists error, validation delegation
- `getProductTypeById`: success, not found error
- `getAllProductTypes`: TARGET/PUBLIC forces isActive=true, ADMIN sees all, explicit isActive filter for staff, orders by sortOrder
- `updateProductType`: success, not found error, slug conflict with different record, slug unchanged (no conflict check)
- `deleteProductType`: success, not found error

### Step 6: Implement Service (TDD - Green)

Implement service functions to pass all tests.

### Step 7: Refactor

Review for DRY violations, type safety, and consistency with existing patterns.

---

## Technical Notes

- **Pattern to follow:** Functional services (`authService.ts`), validators with input/output types (`authValidator.ts`)
- **Prisma direct:** No repository layer (per project architecture - pragmatic DDD)
- **Domain errors:** Already defined in `backend/src/domain/errors/ProductTypeError.ts`
- **Name field:** JSON type in Prisma, stored as `{"es": "Camiseta", "en": "T-Shirt"}`. Minimum `es` key required.
- **Slug format:** lowercase, alphanumeric + hyphens, e.g. `t-shirt`, `hoodie`, `mug`
- **No soft delete:** ProductType has no `deletedAt` — uses hard delete
- **ADR-002:** No Product relation on ProductType until Sprint 3
- **Delete 409 deferred:** API spec defines 409 "has associated products" on delete, but Product model doesn't exist yet. Skip this check; add in Sprint 3 when Product model is created.
- **`productCount` deferred:** API response schema includes `productCount` but this is a controller/response-mapping concern for B2.3, not for the service layer.
- **Role-aware getAll:** The service receives `callerRole` to enforce visibility rules. TARGET/PUBLIC users only see active product types. Staff roles can filter or see all.
- **No `getBySlug`:** Not in the API spec. Can be added later if needed.
- **Return type:** Use Prisma's `ProductType` type from generated client for return values
- **UUID validation:** Use same regex pattern as authValidator for ID validation

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (89 tests)
- [x] Code follows project standards (functional services, typed validators)
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-09*
