# F1.7: Implement Protected Route HOC

**Sprint:** 1
**Type:** Frontend - Component
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-F1.7-protected-route
**Created:** 2026-02-09
**Dependencies:** F1.1 (authStore) âœ…

---

## Description

Implement a `ProtectedRoute` component that guards pages requiring authentication. The component checks the auth state from Zustand's `useAuthStore`, handles the hydration loading state (since tokens are persisted with `skipHydration: true`), supports role-based access control using the `UserRole` type (`TARGET`, `MANAGER`, `ADMIN`, `MARKETING`), and redirects unauthenticated users to `/login` with a `returnTo` query parameter so they can return after login.

This completes the "Role-based route protection" deliverable for Sprint 1.

---

## Acceptance Criteria

- [x] `ProtectedRoute` component renders children when user is authenticated
- [x] Redirects to `/login` when user is not authenticated
- [x] Passes `returnTo` query parameter with the current path on redirect
- [x] Supports optional `allowedRoles` prop for role-based access control
- [x] Shows loading state while auth store hydrates from localStorage
- [x] Shows "access denied" state when authenticated but role is not allowed
- [x] Works with Next.js App Router (`useRouter` from `next/navigation`)
- [x] Fully typed with TypeScript (no `any`)
- [x] Unit tests for all scenarios (authenticated, unauthenticated, loading, role allowed, role denied)
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `frontend/components/auth/ProtectedRoute.tsx` | Protected route wrapper component |
| `frontend/components/auth/ProtectedRoute.test.tsx` | Unit tests for ProtectedRoute |
| `frontend/app/login/page.tsx` | Update to consume `returnTo` param after login (modify LoginForm) |
| `frontend/components/auth/LoginForm.tsx` | Read `returnTo` from URL and redirect there after login |

---

## Implementation Steps

### Step 1: Write Tests for ProtectedRoute
1. Test that authenticated users see children content
2. Test that unauthenticated users are redirected to `/login`
3. Test that `returnTo` query param is set to current pathname
4. Test loading state shows while store hydrates
5. Test role-based access: allowed role shows content
6. Test role-based access: denied role shows access denied message
7. Test no `allowedRoles` prop means any authenticated user can access

### Step 2: Implement ProtectedRoute Component
1. Create `ProtectedRoute` component with props: `children`, `allowedRoles?`
2. Use `useAuthStore` to get `isAuthenticated`, `user`, `isLoading`
3. Handle hydration: use `useEffect` + `useAuthStore.persist.rehydrate()` on mount
4. Track hydration state with local `isHydrated` state
5. While hydrating: show loading spinner/skeleton
6. If not authenticated after hydration: redirect to `/login?returnTo={currentPath}`
7. If authenticated but role not in `allowedRoles`: show access denied
8. If authenticated and role allowed (or no role restriction): render children

### Step 3: Update LoginForm to Support returnTo
1. Read `returnTo` from search params in LoginForm
2. After successful login, redirect to `returnTo` if present, otherwise use existing role-based redirect logic

### Step 4: Verify All Tests Pass
1. Run `npm test` in frontend/
2. Run `npm run lint` in frontend/
3. Run `npm run build` in frontend/

---

## Technical Notes

- **Hydration Pattern**: The authStore uses `skipHydration: true`, so `ProtectedRoute` must call `useAuthStore.persist.rehydrate()` on mount and track hydration state. This prevents flash of unauthenticated content on page load.
- **UserRole Type**: Use `components['schemas']['UserRole']` from `@/lib/api/types` for type safety. Values: `"TARGET" | "MANAGER" | "ADMIN" | "MARKETING"`.
- **Next.js App Router**: Use `useRouter()` from `next/navigation` for redirects, `usePathname()` for current path.
- **Component Pattern**: This is a wrapper component (not a HOC), following React best practices for composition over inheritance. Named "ProtectedRoute" for clarity.
- **SSR Safety**: Check `typeof window !== 'undefined'` where needed, though Next.js client components handle this mostly.
- **Accessibility**: Loading state should have `aria-label`, access denied should be clearly communicated.

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards (TypeScript, English only, no `any`)
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-09*
