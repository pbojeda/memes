# B0.2: Configure Prisma with PostgreSQL

**Sprint:** 0
**Type:** Backend - Setup
**Priority:** High
**Status:** Ready for Review
**Branch:** feature/sprint0-B0.2-prisma-setup
**Created:** 2026-02-03
**Dependencies:** B0.1 (Express + TypeScript) âœ…

---

## Description

Configure Prisma ORM with PostgreSQL database connection. This establishes the data access layer for all backend services, including schema management and type-safe database queries.

---

## Acceptance Criteria

- [x] Prisma CLI installed and configured
- [x] Database connection string uses environment variables
- [x] Prisma schema file created with PostgreSQL provider
- [x] Prisma Client generates without errors
- [x] Basic connection test passes
- [x] Migrations workflow documented
- [x] Environment variables validated

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/prisma/schema.prisma` | Prisma schema with PostgreSQL provider |
| `backend/src/lib/prisma.ts` | Prisma client singleton |
| `backend/src/lib/prisma.test.ts` | Tests for Prisma client |
| `backend/.env.example` | Update with DATABASE_URL |
| `backend/package.json` | Add Prisma scripts |

---

## Dependencies

### Production
```json
{
  "@prisma/client": "^5.x"
}
```

### Development
```json
{
  "prisma": "^5.x"
}
```

---

## Test Specifications (TDD)

```typescript
// backend/src/lib/prisma.test.ts

describe('Prisma Client', () => {
  describe('Client Initialization', () => {
    it('should export a Prisma client instance', () => {
      expect(prisma).toBeDefined();
      expect(prisma.$connect).toBeDefined();
    });

    it('should be a singleton', () => {
      const prisma1 = require('./prisma').default;
      const prisma2 = require('./prisma').default;
      expect(prisma1).toBe(prisma2);
    });
  });

  describe('Connection', () => {
    it('should connect to database when DATABASE_URL is valid', async () => {
      // Test with actual connection or mock
    });
  });
});
```

---

## Implementation Steps (TDD)

### Step 1: Install Prisma dependencies
```bash
cd backend
npm install @prisma/client
npm install -D prisma
```

### Step 2: Initialize Prisma
```bash
npx prisma init --datasource-provider postgresql
```

### Step 3: TDD Cycle - Prisma Client Singleton
1. **RED**: Write test for Prisma client export
2. **GREEN**: Create minimal prisma.ts
3. **REFACTOR**: Add singleton pattern for development

### Step 4: Configure environment
- Update `.env.example` with `DATABASE_URL`
- Add Prisma scripts to `package.json`

### Step 5: Add npm scripts
```json
{
  "scripts": {
    "db:generate": "prisma generate",
    "db:push": "prisma db push",
    "db:migrate": "prisma migrate dev",
    "db:studio": "prisma studio"
  }
}
```

---

## Environment Variables

```env
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/memestore?schema=public"
```

---

## Definition of Done

- [x] All tests pass (6 tests)
- [x] TypeScript compiles without errors
- [x] Prisma client generates successfully
- [x] Code validated by production-code-validator
- [x] No hardcoded database credentials

---

## Notes

### Implementation Notes (2026-02-03)
- Used Prisma 7.3.0 with `@prisma/adapter-pg` for PostgreSQL connection
- Node.js upgraded from 22.1.0 to 25.5.0 (required by Prisma 7)
- Singleton pattern implemented to prevent connection pool exhaustion during hot-reload
- Generated client output: `src/generated/prisma`

### Validation Results
- **CRITICAL:** 0
- **HIGH:** 0
- **MEDIUM:** 0 (fixed)
- **LOW:** 0 (fixed)

---

*Ticket created: 2026-02-03*
