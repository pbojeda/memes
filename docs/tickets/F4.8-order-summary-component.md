# F4.8: Create Order Summary Component

**Sprint:** 4
**Type:** Frontend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint4-F4.8-order-summary-component
**Created:** 2026-02-19
**Dependencies:** F4.1 (cartStore) ✅

---

## Description

Create a reusable `OrderSummary` component that displays a detailed breakdown of order costs: subtotal, discount (from promo codes), shipping, tax, and total. This component will replace the inline summary currently hardcoded in `CartPageContent` and will be reused on the checkout page (F4.5).

Additionally, create a `checkoutService` to call the backend `POST /cart/calculate` endpoint, which validates cart items and calculates the full order total including promo code discounts.

The OrderSummary is a **presentational component** — it receives calculated totals as props and displays them. The parent component (CartPageContent, checkout page) is responsible for calling the checkout service and managing state.

---

## Acceptance Criteria

- [x] `checkoutService.calculateTotals(items, promoCode?)` calls `POST /cart/calculate` and returns `OrderTotalResponse`
- [x] `OrderSummary` component displays: subtotal, discount amount, shipping cost, tax, and total
- [x] Discount line only appears when a promo code is applied (discountAmount > 0)
- [x] Shipping and tax lines show "Free" / "0,00 €" respectively for MVP
- [x] Applied promo code displays badge with code name and discount details
- [x] Cart validation errors are displayed as alerts
- [x] Loading state shows skeleton/spinner while totals are being calculated
- [x] All monetary values use `formatPrice()` utility
- [x] `CartPageContent` integrates `OrderSummary` replacing the current inline summary
- [x] Accessible: uses semantic HTML, proper ARIA attributes
- [x] Unit tests for checkoutService
- [x] Unit tests for OrderSummary (all display states)
- [x] Unit tests for CartPageContent integration
- [x] All tests pass
- [x] Lint passes
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `frontend/lib/services/checkoutService.ts` | Service to call `POST /cart/calculate` |
| `frontend/lib/services/checkoutService.test.ts` | Tests for checkout service |
| `frontend/components/checkout/OrderSummary.tsx` | Presentational order summary component |
| `frontend/components/checkout/OrderSummary.test.tsx` | Tests for OrderSummary |
| `frontend/components/checkout/testing/fixtures.ts` | Test fixtures for order summary data |
| `frontend/components/cart/CartPageContent.tsx` | Replace inline summary with OrderSummary |
| `frontend/components/cart/__tests__/CartPageContent.test.tsx` | Update tests for new OrderSummary integration |

---

## Technical Notes

### API Endpoint

`POST /cart/calculate` — Request:
```typescript
interface OrderTotalRequest {
  items: { productId: string; quantity: number; size?: string }[];
  promoCode?: string;
}
```

Response (within `{ success: boolean; data: OrderTotalResponse }`):
```typescript
interface OrderTotalResponse {
  valid: boolean;
  subtotal: number;
  discountAmount: number;
  shippingCost: number;
  taxAmount: number;
  total: number;
  currency: string;
  itemCount: number;
  validatedItems: CartValidatedItem[];
  appliedPromoCode: AppliedPromoCodeDetail | null;
  promoCodeMessage?: string;
  cartErrors: CartValidationError[];
}
```

### Component Props

```typescript
interface OrderSummaryProps {
  subtotal: number;
  discountAmount: number;
  shippingCost: number;
  taxAmount: number;
  total: number;
  itemCount: number;
  appliedPromoCode: AppliedPromoCodeDetail | null;
  cartErrors: CartValidationError[];
  isLoading: boolean;
}
```

### Key Patterns
- **Presentational**: OrderSummary receives props, no internal state or service calls
- **formatPrice()**: From `@/lib/utils` — formats as EUR (e.g., "24,99 €")
- **UI primitives**: Use Card, Badge, Alert from `@/components/ui/`
- **Service pattern**: Follow `promoCodeService.ts` pattern — fetch wrapper, unwrap envelope, throw `ApiException` on error
- **API types**: Import from `@/lib/api/types` (auto-generated from spec)
- **Test mocking**: Mock `@/components/ui/*` portals with relative paths in `jest.mock()`

### CartPageContent Integration
The current inline summary (Card with Items count + Subtotal at lines 76-104 of CartPageContent.tsx) will be replaced by an `OrderSummary` component. For the cart page, we pass the **local cart subtotal** directly (no backend call needed on the cart page — the full calculation happens at checkout). The OrderSummary on the cart page shows:
- Subtotal from cartStore
- Discount/shipping/tax as 0 (no promo code applied on cart page)
- Total = subtotal

This keeps the cart page fast (no API call) while reusing the same visual component on checkout where full calculation will happen.

---

## Implementation Plan

### Step 1: Test Fixtures for Checkout Data

**File:** `frontend/components/checkout/testing/fixtures.ts`

Create factory functions following the pattern in `promo-code/testing/fixtures.ts` and `cart/testing/fixtures.ts`:

1. `createOrderTotalResponse(overrides?)` — Returns valid `OrderTotalResponse` with defaults: `valid: true`, `subtotal: 79.98`, `discountAmount: 0`, `shippingCost: 0`, `taxAmount: 0`, `total: 79.98`, `currency: 'EUR'`, `itemCount: 2`, `validatedItems: []`, `appliedPromoCode: null`, `cartErrors: []`
2. `createAppliedPromoCode(overrides?)` — Returns `AppliedPromoCodeDetail`: `code: 'SUMMER20'`, `discountType: 'PERCENTAGE'`, `discountValue: 20`, `calculatedDiscount: 15.99`
3. `createCartValidationError(overrides?)` — Returns `CartValidationError`: `productId: 'prod-invalid'`, `code: 'PRODUCT_NOT_FOUND'`, `message: 'Product not found'`

Type imports from `components['schemas'][...]` in `@/lib/api/types`.

**Expected tests:** 0 (validated transitively)

---

### Step 2: checkoutService

**Files:** `frontend/lib/services/checkoutService.test.ts` + `frontend/lib/services/checkoutService.ts`

**TDD — write tests FIRST (6 tests):**

Mock `apiClient` using relative path `jest.mock('../api/client', ...)` (same as promoCodeService pattern).

1. "should call POST /cart/calculate with items and promoCode"
2. "should call POST /cart/calculate without promoCode when not provided"
3. "should return unwrapped OrderTotalResponse data"
4. "should return response with applied promo code when discount is present"
5. "should throw ApiException for HTTP 400 (input validation error)"
6. "should propagate network errors"

**Implementation:** Follow `promoCodeService.ts` pattern — `apiClient.post`, unwrap envelope `response.data.data`, export types `OrderTotalResponse` and `OrderTotalRequest`.

**Expected tests:** 6

---

### Step 3: OrderSummary Component

**Files:** `frontend/components/checkout/OrderSummary.test.tsx` + `frontend/components/checkout/OrderSummary.tsx`

**TDD — write tests FIRST (12 tests):**

Purely presentational — no service mocks needed. Card, Badge, Alert don't use portals (no mocking needed).

```
describe('OrderSummary')
  describe('Loading State')
    1. "renders loading indicator when isLoading is true"
    2. "does not render price lines when loading"

  describe('Basic Display')
    3. "renders 'Order Summary' heading"
    4. "displays item count"
    5. "displays formatted subtotal"
    6. "displays formatted total"
    7. "displays shipping as 'Free' when shippingCost is 0"
    8. "displays formatted tax amount"

  describe('Discount Display')
    9. "does not render discount line when discountAmount is 0"
    10. "renders discount line with formatted amount when discountAmount > 0"
    11. "renders promo code badge when appliedPromoCode is present"

  describe('Cart Errors')
    12. "renders alert for each cart validation error"
```

**Implementation:** Card wrapper (self-contained for reuse), line items for each cost row, conditional discount line, Badge for promo code, Alert for errors, `formatPrice()` for all monetary values, `aria-busy="true"` when loading.

**Expected tests:** 12

---

### Step 4: CartPageContent Integration

**Files:** `frontend/components/cart/CartPageContent.test.tsx` (modify) + `frontend/components/cart/CartPageContent.tsx` (modify)

**TDD — update existing tests FIRST:**

Mock OrderSummary: `jest.mock('../checkout/OrderSummary', ...)` with a div rendering props as data attributes.

1. **Modify** subtotal test → verify `data-subtotal` prop on mock
2. **Modify** item count test → verify `data-item-count` prop on mock
3. **Modify** empty cart test → verify no `order-summary` rendered
4. **Add** "passes isLoading=false to OrderSummary"

**Implementation:** Replace inline Card summary (lines 76-104) with `<OrderSummary>` receiving local cart data. Keep sticky wrapper + checkout/continue-shopping links in CartPageContent.

**Expected tests:** ~5 modified/new

---

### Summary

| Step | Focus | Tests |
|------|-------|-------|
| 1 | Fixtures | 0 |
| 2 | checkoutService | 6 |
| 3 | OrderSummary component | 12 |
| 4 | CartPageContent integration | ~5 |
| **Total** | | **~23** |

### Key Implementation Notes

- `jest.mock()` paths must be **relative** (not `@/` aliases)
- Card, Badge, Alert do **NOT** need mocking (no Radix portals)
- `formatPrice()` for all monetary display
- OrderSummary is **purely presentational** — no hooks, no service calls
- CartPageContent on cart page passes **zeros** for discount/shipping/tax, `isLoading=false`
- Export `OrderTotalResponse` and `OrderTotalRequest` types from checkoutService for F4.5 reuse

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-19*
