# B1.10: Write Auth Integration Tests

**Sprint:** 1
**Type:** Backend - Test
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-B1.10-auth-integration-tests
**Created:** 2026-02-09
**Dependencies:** B1.6 (Auth controller), B1.7 (Password reset), B1.9 (RBAC) - All Completed

---

## Description

Write comprehensive integration tests for all authentication endpoints using supertest. These tests should verify the full request/response cycle through the Express app, testing the integration of controllers, services, validators, and middleware.

**Endpoints to Test:**
- `POST /api/auth/register`
- `POST /api/auth/login`
- `POST /api/auth/logout`
- `POST /api/auth/refresh`
- `POST /api/auth/forgot-password`
- `POST /api/auth/reset-password`

**RBAC Tests:**
- Create a test-only protected route with `requireRole()`
- Verify 403 Forbidden when user has wrong role
- Verify 401 Unauthorized when no token provided
- Verify success when user has correct role

**Testing Approach:**
- Mock Prisma at the database layer
- Test full HTTP request/response cycle
- Verify response formats, status codes, and error handling

---

## Acceptance Criteria

- [x] Integration tests for register endpoint (success, validation, duplicate email)
- [x] Integration tests for login endpoint (success, invalid credentials, inactive user)
- [x] Integration tests for logout endpoint (success, unauthorized)
- [x] Integration tests for refresh endpoint (success, invalid token)
- [x] Integration tests for forgot-password endpoint (success, validation)
- [x] Integration tests for reset-password endpoint (success, invalid/expired token)
- [x] Integration tests for RBAC (correct role, wrong role, no token)
- [x] All tests use supertest with mocked Prisma
- [x] Response format verification (success/error envelope)
- [x] All tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `backend/src/routes/authRoutes.integration.test.ts` | Create | Integration tests |

---

## Implementation Steps

### Step 1: Create Test File Structure

Create `backend/src/routes/authRoutes.integration.test.ts` with:

```typescript
import request from 'supertest';
import app from '../app';
import prisma from '../lib/prisma';
import bcrypt from 'bcrypt';
import * as tokenService from '../application/services/tokenService';

jest.mock('../lib/prisma');
jest.mock('../application/services/tokenService');
```

### Step 2: Test Register Endpoint

**Scenarios:**
- Success: Returns 201 with user data
- Validation Error: Returns 400 for invalid email/password
- Duplicate Email: Returns 409

### Step 3: Test Login Endpoint

**Scenarios:**
- Success: Returns 200 with user and tokens
- Invalid Credentials: Returns 401
- Inactive User: Returns 401
- Validation Error: Returns 400

### Step 4: Test Logout Endpoint

**Scenarios:**
- Success: Returns 200 (requires auth header)
- Unauthorized: Returns 401 (no token)

### Step 5: Test Refresh Endpoint

**Scenarios:**
- Success: Returns 200 with new tokens
- Invalid Token: Returns 401
- Validation Error: Returns 400

### Step 6: Test Password Reset Endpoints

**forgot-password:**
- Success: Returns 200 (always, for security)
- Validation Error: Returns 400

**reset-password:**
- Success: Returns 200
- Invalid Token: Returns 400
- Expired Token: Returns 400
- Validation Error: Returns 400

### Step 7: Test RBAC (Role-Based Access Control)

Create a test-only route in the test file to verify RBAC:

**Scenarios:**
- Success: Returns 200 when user has required role (ADMIN)
- Forbidden: Returns 403 when user has wrong role (TARGET accessing ADMIN route)
- Unauthorized: Returns 401 when no token provided

```typescript
// In test setup, add a test route
app.get('/test-admin', authMiddleware, requireRole(UserRole.ADMIN), (req, res) => {
  res.json({ success: true, data: { message: 'Admin access granted' } });
});
```

---

## Test Structure

```typescript
describe('Auth Routes Integration', () => {
  describe('POST /api/auth/register', () => {
    it('should return 201 with user data on successful registration', async () => {});
    it('should return 400 for invalid email format', async () => {});
    it('should return 409 when email already exists', async () => {});
  });

  describe('POST /api/auth/login', () => {
    it('should return 200 with tokens on successful login', async () => {});
    it('should return 401 for invalid credentials', async () => {});
    it('should return 401 for inactive user', async () => {});
  });

  // ... other endpoints

  describe('Role-Based Access Control', () => {
    it('should return 200 when user has required role', async () => {});
    it('should return 403 when user has wrong role', async () => {});
    it('should return 401 when no token provided', async () => {});
  });
});
```

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Integration tests cover all auth endpoints
- [ ] Tests verify response format consistency
- [ ] No linting errors
- [ ] Build succeeds
- [ ] All tests pass (existing + new)

---

*Ticket created: 2026-02-09*
