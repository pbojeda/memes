# F4.6: Create Shipping Address Form

**Sprint:** 4
**Type:** Frontend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint4-F4.6-shipping-address-form
**Created:** 2026-02-19
**Dependencies:** B4.2 (Address service CRUD) ✅

---

## Description

Create a reusable shipping address form component with client-side validation, address service layer, and create/edit mode support. This form will be consumed by the checkout page (F4.5) and potentially an account addresses page. The backend address API (B4.2) is already implemented with full CRUD at `/api/v1/users/me/addresses`.

---

## Acceptance Criteria

- [x] `addressService` with `list()`, `create()`, `update()`, `delete()` methods following existing service patterns
- [x] Address validation module (`lib/validations/address.ts`) mirroring backend rules:
  - Required: firstName, lastName, streetLine1, city, postalCode, countryCode
  - Optional: label (max 50), streetLine2 (max 255), state (max 100), phone (max 20)
  - countryCode: exactly 2 uppercase characters (ISO 3166-1 alpha-2)
  - Max lengths enforced: firstName/lastName/city/state (100), streetLine1/streetLine2 (255), postalCode (20)
- [x] `AddressForm` component with:
  - All address fields rendered with proper labels and accessibility attributes
  - Create mode (empty form) and edit mode (pre-populated from `initialData` prop)
  - Blur-triggered field validation with inline error messages
  - Submit button disabled when form is invalid or submitting
  - Loading state during submission ("Saving..." button text)
  - API error display (Alert banner for 409 ADDRESS_LIMIT_EXCEEDED, generic errors)
  - `onSuccess` callback with returned address data
  - `isDefault` checkbox
- [x] Unit tests for validation module
- [x] Unit tests for address service
- [x] Unit tests for AddressForm component (rendering, validation, submission, error handling)
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `frontend/lib/validations/address.ts` | Address field validation functions + constants |
| `frontend/lib/validations/address.test.ts` | Validation unit tests |
| `frontend/lib/services/addressService.ts` | Address API service layer |
| `frontend/lib/services/addressService.test.ts` | Service unit tests |
| `frontend/lib/services/index.ts` | Add addressService export |
| `frontend/components/address/AddressForm.tsx` | Shipping address form component |
| `frontend/components/address/AddressForm.test.tsx` | Component tests |

---

## Technical Notes

### API Contract (from B4.2)

**Base path:** `/api/v1/users/me/addresses` (all endpoints require auth)

| Method | Path | Body | Response | Error Codes |
|--------|------|------|----------|-------------|
| GET | `/` | — | `{ data: Address[] }` | 401 |
| POST | `/` | `CreateAddressRequest` | `{ data: Address }` (201) | 400 `INVALID_ADDRESS_DATA`, 409 `ADDRESS_LIMIT_EXCEEDED` |
| GET | `/:addressId` | — | `{ data: Address }` | 404 `ADDRESS_NOT_FOUND` |
| PATCH | `/:addressId` | `UpdateAddressRequest` | `{ data: Address }` | 400, 404 |
| DELETE | `/:addressId` | — | 204 | 404, 409 `DEFAULT_ADDRESS_CANNOT_BE_DELETED` |

**Business rules:**
- First address created is always `isDefault: true` regardless of field value
- Setting `isDefault: true` atomically unsets previous default
- Max 10 addresses per user
- Backend trims all string fields before validation

### Types (auto-generated)

```typescript
import type { components } from '@/lib/api/types';
type Address = components['schemas']['Address'];
type CreateAddressRequest = components['schemas']['CreateAddressRequest'];
type UpdateAddressRequest = components['schemas']['UpdateAddressRequest'];
```

### Patterns to Follow

- **Validation:** Mirror `lib/validations/auth.ts` — individual `validateXxx()` functions returning `{ isValid: boolean; error?: string }`
- **Service:** Mirror `lib/services/authService.ts` — use `apiClient` from `lib/api/client`
- **Form:** Mirror `components/auth/RegisterForm.tsx` — field-level errors, blur validation, touched tracking, API error banner
- **Accessibility:** `aria-invalid`, `aria-describedby` on inputs with errors, `htmlFor` on labels
- **Testing:** `jest.mock()` with relative paths, mock Radix Select if used for countryCode

### Country Code Field

Use a plain `Input` (text field, maxLength 2, uppercase transform) rather than a Radix Select dropdown. This avoids the JSDOM portal mocking complexity and is simpler for an MVP. A country dropdown can be added later as an enhancement.

---

## Implementation Plan

### Phase 1: Address Validation Module (TDD)

**Files:**
- `frontend/lib/validations/address.ts` (create)
- `frontend/lib/validations/address.test.ts` (create)

**Pattern:** Follow `frontend/lib/validations/auth.ts` — individual `validate*()` functions returning `{ isValid: boolean; error?: string }`.

#### 1a. Constants

```typescript
export const ADDRESS_FIELD_LIMITS = {
  label: 50, firstName: 100, lastName: 100,
  streetLine1: 255, streetLine2: 255,
  city: 100, state: 100, postalCode: 20,
  countryCode: 2, phone: 20,
} as const;
```

#### 1b. Validation functions

| Function | Required | Rules |
|----------|----------|-------|
| `validateFirstName(value)` | Yes | Non-empty after trim, max 100 chars |
| `validateLastName(value)` | Yes | Non-empty after trim, max 100 chars |
| `validateStreetLine1(value)` | Yes | Non-empty after trim, max 255 chars |
| `validateStreetLine2(value)` | No | If non-empty, max 255 chars |
| `validateCity(value)` | Yes | Non-empty after trim, max 100 chars |
| `validateState(value)` | No | If non-empty, max 100 chars |
| `validatePostalCode(value)` | Yes | Non-empty after trim, max 20 chars |
| `validateCountryCode(value)` | Yes | Non-empty after trim, exactly 2 chars |
| `validatePhone(value)` | No | If non-empty, max 20 chars |
| `validateLabel(value)` | No | If non-empty, max 50 chars |
| `validateAddressForm(fields)` | — | Calls all validators, returns `{ isValid, errors }` |

#### 1c. Test cases (`address.test.ts`)

- `describe('ADDRESS_FIELD_LIMITS')` — assert all values match backend
- `describe('validateFirstName')` — valid name, empty string, whitespace-only, exceeds 100 chars, exactly 100 chars
- `describe('validateLastName')` — same pattern as firstName
- `describe('validateStreetLine1')` — valid, empty, exceeds 255 chars, exactly 255 chars
- `describe('validateStreetLine2')` — empty = valid (optional), non-empty valid, exceeds 255 chars
- `describe('validateCity')` — valid, empty, exceeds 100 chars
- `describe('validateState')` — empty = valid (optional), non-empty valid, exceeds 100 chars
- `describe('validatePostalCode')` — valid, empty, exceeds 20 chars
- `describe('validateCountryCode')` — valid (2 chars), empty, 1 char, 3 chars, lowercase 2 chars = valid
- `describe('validatePhone')` — empty = valid (optional), non-empty valid, exceeds 20 chars
- `describe('validateLabel')` — empty = valid (optional), non-empty valid, exceeds 50 chars
- `describe('validateAddressForm')` — all valid, required field empty, multiple errors, optional fields empty

### Phase 2: Address Service (TDD)

**Files:**
- `frontend/lib/services/addressService.ts` (create)
- `frontend/lib/services/addressService.test.ts` (create)
- `frontend/lib/services/index.ts` (modify — add export)

**Pattern:** Follow `frontend/lib/services/adminProductService.ts` — stateless service object using `apiClient`.

#### 2a. Service methods

| Method | HTTP | Path | Returns |
|--------|------|------|---------|
| `list()` | GET | `/users/me/addresses` | `Address[]` |
| `create(data)` | POST | `/users/me/addresses` | `Address` |
| `update(addressId, data)` | PATCH | `/users/me/addresses/${addressId}` | `Address` |
| `delete(addressId)` | DELETE | `/users/me/addresses/${addressId}` | `void` |

#### 2b. Test cases (`addressService.test.ts`)

- `describe('list')` — calls GET, returns Address[], returns empty array, propagates 401
- `describe('create')` — calls POST with body, returns Address, propagates 400, propagates 409 ADDRESS_LIMIT_EXCEEDED
- `describe('update')` — calls PATCH with addressId and body, returns Address, propagates 400, propagates 404
- `describe('delete')` — calls DELETE with addressId, returns void, propagates 404, propagates 409 DEFAULT_ADDRESS_CANNOT_BE_DELETED

### Phase 3: AddressForm Component (TDD)

**Files:**
- `frontend/components/address/AddressForm.tsx` (create)
- `frontend/components/address/AddressForm.test.tsx` (create)

**Pattern:** Follow `frontend/components/auth/RegisterForm.tsx` — field-level errors, blur validation, touched tracking, API error Alert banner.

#### 3a. Props interface

```typescript
export interface AddressFormProps {
  initialData?: Address;          // omit for create mode, provide for edit mode
  onSuccess: (address: Address) => void;
  onCancel?: () => void;
}
```

#### 3b. State: `formData` object, `errors` record, `apiError`, `isSubmitting`, `touched` record

#### 3c. Handlers

- `handleChange(field, value)` — update formData; auto-uppercase countryCode
- `handleBlur(field)` — mark touched, run validator, set error
- `handleCheckboxChange(checked)` — update formData.isDefault
- `isFormValid()` — call `validateAddressForm(formData).isValid`
- `handleSubmit(e)` — guard invalid, call create or update based on initialData, handle errors by code, call onSuccess

#### 3d. JSX layout

- `<form>` with `space-y-4`
- API error Alert banner at top
- Label (optional) field
- First Name + Last Name side by side (`grid grid-cols-2 gap-4`)
- Street Address field
- Apartment/suite (optional) field
- City + State/Province side by side
- Postal Code + Country Code side by side (countryCode: `maxLength={2}`)
- Phone (optional) field
- isDefault Checkbox
- Action buttons: Submit + optional Cancel (variant="outline")
- All fields: `aria-invalid`, `aria-describedby`, Label with `htmlFor`

#### 3e. Test cases (`AddressForm.test.tsx`)

Mock setup: `jest.mock('../../lib/services/addressService')`, mock Checkbox with native `<input type="checkbox">`.

**`describe('rendering')`**
- Renders all address fields with labels
- Renders isDefault checkbox
- Renders "Save Address" in create mode, "Update Address" in edit mode
- Renders cancel button when onCancel provided, hides when not
- Submit button disabled on empty form

**`describe('edit mode')`**
- Pre-populates fields from initialData
- Submit button enabled when initialData is valid
- isDefault checkbox checked when initialData.isDefault is true

**`describe('validation')`**
- Shows error for each required field on blur (firstName, lastName, streetLine1, city, postalCode, countryCode)
- Shows error for invalid countryCode length
- No errors for optional fields when empty
- Sets aria-invalid on fields with errors
- Clears field error when valid value entered
- Auto-uppercases country code input

**`describe('submission - create mode')`**
- Calls addressService.create with form data
- Calls onSuccess with returned address
- Shows "Saving..." during submission
- Disables submit during submission
- Does not submit when form invalid

**`describe('submission - edit mode')`**
- Calls addressService.update with addressId and data
- Calls onSuccess with returned address

**`describe('error handling')`**
- Displays 409 ADDRESS_LIMIT_EXCEEDED message
- Displays generic error for other failures
- Clears API error on resubmit
- Re-enables submit button after error

### Execution Order

1. **Phase 1:** `address.test.ts` (red) → `address.ts` (green) → verify
2. **Phase 2:** `addressService.test.ts` (red) → `addressService.ts` (green) → update `index.ts` → verify
3. **Phase 3:** `AddressForm.test.tsx` (red) → `AddressForm.tsx` (green) → verify
4. **Final:** `npm test` (all), `npm run lint`, `npm run build`

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards (form patterns, validation patterns, service patterns)
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-19*
