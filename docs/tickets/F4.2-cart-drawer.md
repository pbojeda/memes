# F4.2: Implement CartDrawer Component

**Sprint:** 4
**Type:** Frontend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint4-F4.2-cart-drawer
**Created:** 2026-02-19
**Dependencies:** F4.1 (cartStore) ✅, F4.3 (CartItem) ✅

---

## Description

Implement a slide-out cart drawer that displays the user's cart contents in a side panel. The drawer slides in from the right, shows a list of cart items (using the CartItem component), a subtotal, and action buttons (view cart page, continue shopping). It connects to the cartStore for state and provides the trigger button (cart icon with badge) to open the drawer from the site header.

This is the primary quick-access cart UI — users can review and modify their cart without navigating away from their current page.

---

## Acceptance Criteria

- [x] Sheet/Drawer UI primitive created (based on Radix Dialog, slides from right)
- [x] CartDrawer component renders a trigger button with shopping cart icon
- [x] Trigger button shows item count badge when cart has items
- [x] Drawer displays list of CartItem components connected to cartStore
- [x] Drawer shows subtotal using formatPrice()
- [x] Drawer shows "Your cart is empty" state when no items
- [x] "View Cart" button links to /cart
- [x] "Continue Shopping" or close button dismisses the drawer
- [x] Drawer has accessible title and close button
- [x] Cart store hydration (rehydrate) handled on mount
- [x] Unit tests for CartDrawer component
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `frontend/components/ui/sheet.tsx` | Sheet UI primitive (Radix Dialog-based side panel) |
| `frontend/components/cart/CartDrawer.tsx` | Cart drawer component with store integration |
| `frontend/components/cart/CartDrawer.test.tsx` | Tests for CartDrawer |

---

## Technical Notes

- **Sheet primitive**: Use Radix Dialog primitive (already available in `radix-ui` package v1.4.3). Sheet is essentially a Dialog with content positioned to the side instead of centered. Follow the same pattern as `dialog.tsx` — import from `"radix-ui"` as `DialogPrimitive`.
- **Cart store**: Uses `skipHydration: true` — CartDrawer must call `useCartStore.persist.rehydrate()` on mount.
- **CartItem**: Presentational component. CartDrawer wires `onUpdateQuantity` and `onRemove` to `cartStore.updateQuantity` and `cartStore.removeItem`.
- **Badge count**: Use `cartStore.itemCount` (total quantity, not distinct items).
- **Formatting**: Use `formatPrice()` from `@/lib/utils` for subtotal display.
- **Radix portals in JSDOM**: Same limitation as Dialog — may need to mock for tests. Follow existing Dialog test patterns if any, or mock the sheet primitives.
- **Icons**: Use `ShoppingCart` from `lucide-react` for trigger button.
- **Accessibility**: Sheet needs `DialogTitle` (visible or sr-only), overlay for backdrop, close button.

---

## Implementation Plan

### Step 1: Create Sheet UI Primitive (`frontend/components/ui/sheet.tsx`)

**What**: A reusable Sheet component built on top of Radix Dialog, following the exact same coding pattern as `frontend/components/ui/dialog.tsx`. Sheet is a Dialog whose content slides in from the right edge instead of being centered.

**Pattern to follow**: `dialog.tsx` — import from `"radix-ui"` as `DialogPrimitive`, wrap each sub-component in a thin function with `data-slot`, pass `className` via `cn()`.

**Key exports** (named functions, same pattern as Dialog):
- `Sheet` — wraps `DialogPrimitive.Root`
- `SheetTrigger` — wraps `DialogPrimitive.Trigger`
- `SheetPortal` — wraps `DialogPrimitive.Portal`
- `SheetClose` — wraps `DialogPrimitive.Close`
- `SheetOverlay` — same as `DialogOverlay` (fixed inset-0, z-50, bg-black/50, fade animations)
- `SheetContent` — fixed right panel: `fixed inset-y-0 right-0 w-full sm:max-w-sm border-l shadow-lg` with slide-in-from-right / slide-out-to-right animations. Includes close button (X icon). Renders `SheetPortal > SheetOverlay + DialogPrimitive.Content`.
- `SheetHeader`, `SheetFooter` — layout divs
- `SheetTitle` — wraps `DialogPrimitive.Title`
- `SheetDescription` — wraps `DialogPrimitive.Description`

`SheetContent` accepts `showCloseButton?: boolean` (default `true`), same as `DialogContent`.

**No tests needed** for this file — it is a UI primitive (thin wrapper with styling). Same convention as `dialog.tsx`, `select.tsx`.

---

### Step 2: Write CartDrawer Tests — TDD RED (`frontend/components/cart/CartDrawer.test.tsx`)

**Mocking strategy**:
1. **Mock `@/components/ui/sheet`** — render Sheet sub-components as simple HTML elements (no portals). This isolates CartDrawer from Sheet internals.
2. **Mock `next/link`** and **`next/image`** — same pattern as `CartItem.test.tsx`.
3. **Mock `lucide-react`** — `ShoppingCart` icon as identifiable SVG.
4. **Mock `@/stores/cartStore`** — control `useCartStore` return values. Mock `useCartStore.persist.rehydrate` spy.
5. **Mock `@/components/cart/CartItem`** — render a simple div with item title, capturing `onUpdateQuantity` and `onRemove` props for verification.

**Test groups**:

| Group | Tests |
|-------|-------|
| A: Trigger button | Renders ShoppingCart icon; shows no badge when itemCount=0; shows badge with count when itemCount>0 |
| B: Empty cart | Shows "Your cart is empty" message; hides subtotal; still shows title |
| C: Cart with items | Renders one CartItem per item; displays formatted subtotal; shows "View Cart" link to /cart |
| D: Store wiring | onUpdateQuantity calls store.updateQuantity; onRemove calls store.removeItem |
| E: Hydration | Calls `useCartStore.persist.rehydrate()` on mount |
| F: Accessibility | Sheet has title "Shopping Cart"; close button exists |

---

### Step 3: Implement CartDrawer Component — TDD GREEN (`frontend/components/cart/CartDrawer.tsx`)

**Directive**: `'use client'`

**Structure**:
```
CartDrawer (no props, reads from store)
├── Sheet (controlled: open/onOpenChange via useState)
│   ├── SheetTrigger (asChild)
│   │   └── Button (variant="ghost", size="icon", relative wrapper)
│   │       ├── ShoppingCart icon
│   │       └── <span> badge (absolute, rounded-full, bg-primary) when itemCount > 0
│   └── SheetContent
│       ├── SheetHeader
│       │   └── SheetTitle: "Shopping Cart"
│       │   └── SheetDescription (sr-only): "Cart contents"
│       ├── Scrollable items area (flex-1 overflow-y-auto, dividers between items)
│       │   ├── Empty: "Your cart is empty" centered message
│       │   └── items.map → <CartItem key={productId-size} ... />
│       ├── Subtotal bar (border-t, when items.length > 0)
│       │   ├── "Subtotal" label
│       │   └── formatPrice(subtotal)
│       └── SheetFooter (when items.length > 0)
│           ├── SheetClose asChild → Link href="/cart": "View Cart" button
│           └── SheetClose asChild → Button variant="outline": "Continue Shopping"
```

**Hydration**: `useEffect(() => { useCartStore.persist.rehydrate(); }, [])`

**Store selectors**: Individual selectors for `items`, `itemCount`, `subtotal`, `updateQuantity`, `removeItem`.

**CartItem key**: `${item.productId}-${item.size ?? 'no-size'}`

---

### Step 4: Run Tests — GREEN Verification

`cd frontend && npx jest --testPathPatterns CartDrawer`

---

### Step 5: Lint and Build Verification

```bash
cd frontend && npm run lint
cd frontend && npm run build
```

---

### TDD Execution Order

| Order | Action | File |
|-------|--------|------|
| 1 | Create Sheet primitive (no tests — styling wrapper) | `components/ui/sheet.tsx` |
| 2 | Write CartDrawer tests (RED) | `components/cart/CartDrawer.test.tsx` |
| 3 | Implement CartDrawer (GREEN) | `components/cart/CartDrawer.tsx` |
| 4 | Refactor if needed | Both files |
| 5 | Verify lint + build | — |

### Dependencies

- `radix-ui` v1.4.3 (already installed) — Dialog primitive
- `lucide-react` (already installed) — `ShoppingCart` icon
- `@/components/cart/CartItem` (F4.3 ✅)
- `@/stores/cartStore` (F4.1 ✅)
- `@/lib/utils` — `formatPrice`, `cn`
- No new npm dependencies needed.

### Notes

- Header integration (replacing the current cart link with `<CartDrawer />`) is NOT in F4.2 scope — will be a separate task.
- `SheetDescription` rendered with `className="sr-only"` to suppress Radix console warning about missing description.

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-19*
