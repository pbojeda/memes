# F1.1: Create authStore (Zustand)

**Sprint:** 1
**Type:** Frontend - State
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-F1.1-auth-store
**Created:** 2026-02-09
**Dependencies:** None (first frontend task)

---

## Description

Create a Zustand store for authentication state management. The store will manage user authentication state, tokens, and provide actions for login, register, logout, and token refresh. This is the foundation for all auth-related frontend functionality.

**Backend API Reference:**
- `POST /api/auth/register` - Returns user object
- `POST /api/auth/login` - Returns `{ user, accessToken, refreshToken }`
- `POST /api/auth/logout` - Clears session (requires auth header)
- `POST /api/auth/refresh` - Returns `{ accessToken, refreshToken }`

**Note:** This ticket creates the store only. API calls will be implemented in F1.5 (auth service).

---

## Acceptance Criteria

- [x] `authStore` created with Zustand
- [x] User type defined matching backend `AuthUser`
- [x] Auth state includes: user, accessToken, refreshToken, isAuthenticated, isLoading, error
- [x] Actions defined: setAuth, clearAuth, setLoading, setError, setTokens
- [x] Store uses persist middleware for localStorage (tokens only, not user)
- [x] Type-safe store with full TypeScript types
- [x] Unit tests for all store actions
- [x] Hydration handled for SSR (Next.js compatibility)
- [x] All tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `frontend/stores/authStore.ts` | Create | Zustand auth store |
| `frontend/stores/authStore.test.ts` | Create | Store unit tests |
| `frontend/types/auth.ts` | Create | Auth type definitions |

---

## Implementation Steps

### Step 1: Create Auth Types

Create `frontend/types/auth.ts`:

```typescript
export type UserRole = 'TARGET' | 'MANAGER' | 'ADMIN' | 'MARKETING';

export interface User {
  id: string;
  email: string;
  firstName: string | null;
  lastName: string | null;
  role: UserRole;
  isActive: boolean;
  emailVerifiedAt: string | null;
  lastLoginAt: string | null;
  createdAt: string;
}

export interface AuthTokens {
  accessToken: string;
  refreshToken: string;
}

export interface AuthState {
  user: User | null;
  accessToken: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  error: string | null;
}
```

### Step 2: Create Auth Store (TDD)

Create `frontend/stores/authStore.ts`:

**Store State:**
- `user: User | null` - Current authenticated user
- `accessToken: string | null` - JWT access token
- `refreshToken: string | null` - Refresh token
- `isAuthenticated: boolean` - Derived from user presence
- `isLoading: boolean` - Loading state for async operations
- `error: string | null` - Error message if any

**Store Actions:**
- `setAuth(user, tokens)` - Set user and tokens after login
- `clearAuth()` - Clear all auth state (logout)
- `setLoading(isLoading)` - Set loading state
- `setError(error)` - Set error message
- `setTokens(tokens)` - Update tokens (for refresh)

**Persist Configuration:**
- Use `persist` middleware
- Store only tokens in localStorage (not user data for security)
- Handle SSR with `skipHydration`

### Step 3: Write Unit Tests

Create `frontend/stores/authStore.test.ts`:

**Test Scenarios:**
1. Initial state is unauthenticated
2. `setAuth` sets user and tokens, marks as authenticated
3. `clearAuth` resets all state to initial
4. `setLoading` updates loading state
5. `setError` sets error message
6. `setTokens` updates tokens without affecting user
7. Persistence works correctly (mock localStorage)
8. Hydration handled for SSR

---

## Type Definitions

```typescript
interface AuthActions {
  setAuth: (user: User, tokens: AuthTokens) => void;
  clearAuth: () => void;
  setLoading: (isLoading: boolean) => void;
  setError: (error: string | null) => void;
  setTokens: (tokens: AuthTokens) => void;
}

type AuthStore = AuthState & AuthActions;
```

---

## Store Structure

```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

const initialState: AuthState = {
  user: null,
  accessToken: null,
  refreshToken: null,
  isAuthenticated: false,
  isLoading: false,
  error: null,
};

export const useAuthStore = create<AuthStore>()(
  persist(
    (set) => ({
      ...initialState,

      setAuth: (user, tokens) => set({
        user,
        accessToken: tokens.accessToken,
        refreshToken: tokens.refreshToken,
        isAuthenticated: true,
        error: null,
      }),

      clearAuth: () => set(initialState),

      setLoading: (isLoading) => set({ isLoading }),

      setError: (error) => set({ error, isLoading: false }),

      setTokens: (tokens) => set({
        accessToken: tokens.accessToken,
        refreshToken: tokens.refreshToken,
      }),
    }),
    {
      name: 'auth-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        accessToken: state.accessToken,
        refreshToken: state.refreshToken,
      }),
      skipHydration: true, // For SSR compatibility
    }
  )
);
```

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Store exports properly typed
- [x] Unit tests cover all actions
- [x] No linting errors
- [x] Build succeeds
- [x] Next.js SSR compatibility verified

---

*Ticket created: 2026-02-09*
