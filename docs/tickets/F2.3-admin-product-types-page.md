# F2.3: Implement Admin Product Types Page

**Sprint:** 2
**Type:** Frontend - Feature
**Priority:** Medium
**Status:** In Progress
**Branch:** feature/sprint2-F2.3-admin-product-types
**Created:** 2026-02-11
**Dependencies:** F2.1 (productTypeService) ✅

---

## Description

Create the first admin page in the application: a product types management page at `/admin/product-types`. This page allows ADMIN users to view, create, edit, and delete product types. Since no admin infrastructure exists yet, this task also establishes the admin layout and navigation pattern that future admin pages will follow.

The backend CRUD API is complete and tested (B2.3, B2.6). The frontend service layer exists (F2.1). This task builds the UI layer on top.

---

## Acceptance Criteria

- [x] Admin layout exists at `/admin` with a sidebar navigation
- [x] Product types page accessible at `/admin/product-types`
- [x] Page is protected by `ProtectedRoute` with `allowedRoles={['ADMIN']}`
- [x] Product types are listed in a table with columns: Name, Slug, Has Sizes, Active, Sort Order, Actions
- [x] "Create" button opens a form to create a new product type
- [x] Edit action opens a form pre-filled with existing product type data
- [x] Delete action shows a confirmation dialog before deleting
- [x] Delete shows warning if product type has associated products (productCount > 0)
- [x] Forms include fields: Name, Slug, Has Sizes (checkbox), Is Active (checkbox), Sort Order (number)
- [x] Loading states shown while fetching data
- [x] Error states with user-friendly messages and retry option
- [x] Success feedback after create/update/delete operations
- [x] Unit tests for all new components
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `app/admin/layout.tsx` | Admin layout with sidebar navigation |
| `app/admin/page.tsx` | Admin root redirect to product-types |
| `app/admin/product-types/page.tsx` | Product types page (server component wrapper) |
| `components/admin/AdminSidebar.tsx` | Sidebar navigation for admin section |
| `components/admin/product-types/ProductTypesTable.tsx` | Table listing product types with actions |
| `components/admin/product-types/ProductTypeFormDialog.tsx` | Dialog with form for create/edit |
| `components/admin/product-types/DeleteProductTypeDialog.tsx` | Confirmation dialog for delete |
| `components/ui/table.tsx` | Shadcn Table component |
| `components/ui/dialog.tsx` | Shadcn Dialog component |
| `components/ui/checkbox.tsx` | Shadcn Checkbox component |
| `components/ui/badge.tsx` | Shadcn Badge component |
| `__tests__/components/admin/AdminSidebar.test.tsx` | Tests for admin sidebar |
| `__tests__/components/admin/product-types/ProductTypesTable.test.tsx` | Tests for product types table |
| `__tests__/components/admin/product-types/ProductTypeFormDialog.test.tsx` | Tests for form dialog |
| `__tests__/components/admin/product-types/DeleteProductTypeDialog.test.tsx` | Tests for delete dialog |

---

## Implementation Steps

### Step 1: Add Missing Shadcn UI Components
1. Add Dialog component (`npx shadcn@latest add dialog`)
2. Add Table component (`npx shadcn@latest add table`)
3. Add Checkbox component (`npx shadcn@latest add checkbox`)
4. Add Badge component (`npx shadcn@latest add badge`)

### Step 2: Create Admin Layout and Navigation
1. Create `app/admin/layout.tsx` with sidebar + content area
2. Create `components/admin/AdminSidebar.tsx` with navigation links
3. Wrap content in `ProtectedRoute` with `allowedRoles={['ADMIN']}`
4. Create `app/admin/page.tsx` that redirects to `/admin/product-types`
5. Write tests for AdminSidebar

### Step 3: Build ProductTypesTable Component
1. Create table component that displays product types
2. Show columns: Name, Slug, Has Sizes, Active (badge), Sort Order, Actions
3. Handle loading state with skeleton rows
4. Handle error state with retry button
5. Handle empty state
6. Add "Create New" button in header
7. Write tests for all states and interactions

### Step 4: Build ProductTypeFormDialog Component
1. Create dialog with form fields: Name, Slug, Has Sizes, Is Active, Sort Order
2. Support both "create" and "edit" modes
3. Field validation (name required, slug required, sortOrder >= 0)
4. Send name as `{ es: value }` to API (single language for MVP, per ADR-003)
4. Handle API errors (duplicate slug → 409, validation → 400)
5. Loading state on submit button
6. Write tests for form validation, create mode, edit mode, error handling

### Step 5: Build DeleteProductTypeDialog Component
1. Create confirmation dialog for delete
2. Show warning when productCount > 0 (cannot delete)
3. Handle 409 conflict error (products still associated)
4. Write tests for confirmation, warning, and error states

### Step 6: Wire Up the Product Types Page
1. Create `app/admin/product-types/page.tsx`
2. Compose all components together
3. Manage state: list refresh after create/update/delete
4. Verify end-to-end flow works

---

## Technical Notes

- **API Types:** Use `components['schemas']['ProductType']`, `CreateProductTypeRequest`, `UpdateProductTypeRequest` from `@/lib/api/types`
- **Service:** Use `productTypeService` from `@/lib/services/productTypeService`
- **LocalizedString:** Create/Update forms must send `name: { es: "...", en: "..." }`. The GET response returns a flat `name` string (localized by Accept-Language header).
- **Auth:** Use existing `ProtectedRoute` component with `allowedRoles={['ADMIN']}`
- **ADR-003:** i18n deferred post-MVP. Forms show a single "Name" field and send it as `{ es: value }`. When i18n is implemented, add a second field for EN.
- **First admin page:** This establishes patterns for future admin pages (products, orders, users)
- **Testing:** Jest + React Testing Library. Mock `productTypeService` in tests. Use `--testPathPatterns` flag.

---

## Implementation Plan

### Sub-step 1: Install Shadcn UI Components
**Setup step — no TDD, verify build passes.**
1. Install from `frontend/`: `npx shadcn@latest add dialog table checkbox badge`
2. Verify generated files exist in `components/ui/`
3. Run `npm run build` and `npm test` — no regressions

### Sub-step 2: Create AdminSidebar Component (TDD)
**Files:** `components/admin/AdminSidebar.tsx`, `components/admin/AdminSidebar.test.tsx`

**Tests (RED):**
- Renders sidebar with "Admin" title
- Renders nav link for "Product Types" with href `/admin/product-types`
- Highlights active link when `usePathname()` matches
- Does not highlight when pathname differs
- Has accessible `<nav aria-label="Admin navigation">`

**Implementation (GREEN):**
- `'use client'` component using `usePathname()` from `next/navigation`
- `<aside>` with `<nav>`, Link items with active state comparison
- Uses `lucide-react` icons

### Sub-step 3: Create Admin Layout and Route Structure (TDD)
**Files:** `app/admin/layout.tsx`, `app/admin/layout.test.tsx`, `app/admin/page.tsx`

**Tests (RED):**
- Renders `ProtectedRoute` with `allowedRoles={['ADMIN']}`
- Renders `AdminSidebar`
- Renders children in `<main>` content area

**Implementation (GREEN):**
- `layout.tsx`: `'use client'`, wraps children in `ProtectedRoute` + flex layout with sidebar
- `page.tsx`: Server component that redirects to `/admin/product-types`

### Sub-step 4: Build ProductTypesTable Component (TDD)
**Files:** `components/admin/product-types/ProductTypesTable.tsx`, `components/admin/product-types/ProductTypesTable.test.tsx`

**Props:**
```typescript
interface ProductTypesTableProps {
  productTypes: ProductType[];
  isLoading: boolean;
  error: string | null;
  onRetry: () => void;
  onEdit: (productType: ProductType) => void;
  onDelete: (productType: ProductType) => void;
  onCreate: () => void;
}
```

**Tests (RED):**
- Loading: skeleton rows, no data shown
- Error: alert with message, retry button calls `onRetry`
- Empty: "No product types found" message, create button
- Table: headers (Name, Slug, Has Sizes, Active, Sort Order, Actions), correct data in rows
- Has Sizes: "Yes"/"No" text
- Active: Badge with "Active"/"Inactive"
- Interactions: `onCreate`, `onEdit(productType)`, `onDelete(productType)` callbacks
- Accessibility: proper table structure, aria-labels on action buttons

**Implementation (GREEN):**
- Shadcn `Table` components, `Badge`, `Button` with ghost variant
- `Pencil` and `Trash2` icons from `lucide-react`
- Skeleton rows for loading, `Alert` for errors

### Sub-step 5: Build ProductTypeFormDialog Component (TDD)
**Files:** `components/admin/product-types/ProductTypeFormDialog.tsx`, `components/admin/product-types/ProductTypeFormDialog.test.tsx`

**Props:**
```typescript
interface ProductTypeFormDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  productType?: ProductType;  // undefined = create, defined = edit
  onSuccess: () => void;
}
```

**Tests (RED):**
- Create mode: title "Create Product Type", empty fields, validation (name/slug required, sortOrder >= 0)
- Calls `productTypeService.create` with `{ name: { es: value }, slug, hasSizes, isActive, sortOrder }`
- Loading state ("Creating..."), success calls `onSuccess` + closes dialog
- 409 error: "A product type with this slug already exists"
- Edit mode: title "Edit Product Type", pre-filled fields, calls `productTypeService.update(id, data)`
- Toggle checkboxes, Cancel closes dialog

**Implementation (GREEN):**
- Shadcn `Dialog` components, controlled form with `useState`
- Mode determined by `productType` prop presence
- Sends `name: { es: value }` per ADR-003
- Error handling with `ApiException` status checks

### Sub-step 6: Build DeleteProductTypeDialog Component (TDD)
**Files:** `components/admin/product-types/DeleteProductTypeDialog.tsx`, `components/admin/product-types/DeleteProductTypeDialog.test.tsx`

**Props:**
```typescript
interface DeleteProductTypeDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  productType: ProductType | null;
  onSuccess: () => void;
}
```

**Tests (RED):**
- Shows confirmation with product type name
- Warning + disabled delete when `productCount > 0`
- Enabled delete when `productCount === 0`
- Calls `productTypeService.delete(id)` on confirm
- Loading state ("Deleting..."), success callbacks
- 409 error handling, generic error handling
- Cancel closes dialog

**Implementation (GREEN):**
- Shadcn `Dialog` with destructive Button for confirm
- Warning Alert when products are associated

### Sub-step 7: Wire Up Product Types Page (TDD)
**Files:** `app/admin/product-types/page.tsx`, `app/admin/product-types/page.test.tsx`

**Tests (RED):**
- Fetches product types on mount (calls `productTypeService.getAll()`)
- Shows loading state, then data
- Shows error state on fetch failure, retry works
- Open create dialog on "Create New" click
- Open edit dialog with data on Edit click
- Open delete dialog on Delete click
- Refreshes list after successful create/update/delete

**Implementation (GREEN):**
- `'use client'` container component
- State: `productTypes[]`, `isLoading`, `error`, `selectedProductType`, `dialogMode`, `isDeleteOpen`
- `useEffect` for initial fetch + `fetchProductTypes` function for refresh
- Composes `ProductTypesTable`, `ProductTypeFormDialog`, `DeleteProductTypeDialog`

### Sub-step 8: Final Verification
1. Run full test suite: `npm test`
2. Run linter: `npm run lint`
3. Run build: `npm run build`
4. Update ticket acceptance criteria with `[x]`

---

## Future Improvements

- **Success toast notifications** after create/update/delete operations (requires toast component)
- **Slug format validation** (e.g. `/^[a-z0-9]+(?:-[a-z0-9]+)*$/`) and auto-generation from name
- **Optimistic updates** for perceived performance on CRUD operations
- **Column sorting** on table headers (client-side or API `?sortBy=`)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards (TypeScript, no `any`, English only)
- [x] No linting errors
- [x] Build succeeds
- [x] Admin layout pattern established for future pages

---

*Ticket created: 2026-02-11*
