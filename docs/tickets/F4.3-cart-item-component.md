# F4.3: Implement CartItem Component

**Sprint:** 4
**Type:** Frontend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint4-F4.3-cart-item-component
**Created:** 2026-02-19
**Dependencies:** F4.1 (cartStore) ✅

---

## Description

Create a reusable `CartItem` component that displays a single cart item with its image, title, size, price, quantity controls (+/- buttons), and a remove button. This component will be consumed by both the CartDrawer (F4.2) and Cart Page (F4.4).

The component receives a `CartItemLocal` object and interacts with the `cartStore` for quantity updates and item removal. It should be a presentational component that accepts callbacks for actions, keeping it testable and reusable across different cart contexts.

---

## Acceptance Criteria

- [x] Displays product thumbnail image (80x80, with fallback for null image)
- [x] Shows product title as a link to the product detail page (`/products/{slug}`)
- [x] Shows size label when size is not null
- [x] Shows formatted unit price using `formatPrice()`
- [x] Shows quantity with increment (+) and decrement (-) buttons
- [x] Decrement button is disabled when quantity is 1
- [x] Increment button is disabled when quantity is at MAX_ITEM_QUANTITY (99)
- [x] Shows formatted line total (price × quantity)
- [x] Remove button removes the item from cart
- [x] Callbacks: `onUpdateQuantity(productId, size, newQuantity)` and `onRemove(productId, size)`
- [x] Accessible: buttons have aria-labels, image has alt text
- [x] Unit tests cover all interactions and edge cases
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `frontend/components/cart/CartItem.tsx` | CartItem component |
| `frontend/components/cart/CartItem.test.tsx` | Tests for CartItem |

---

## Technical Notes

- **Props pattern**: Accept `CartItemLocal` + `onUpdateQuantity` + `onRemove` callbacks (presentational component, not directly coupled to store)
- **Image**: Use Next.js `Image` with `width={80} height={80}` and `object-cover`. Fallback to `ImageOff` lucide icon when `primaryImage` is null
- **Price formatting**: Use `formatPrice()` from `lib/utils.ts` (Intl.NumberFormat, `es-ES`, EUR)
- **Product link**: `<Link href={/products/${slug}}>` for product title
- **Quantity bounds**: Min 1 (decrement disabled at 1), Max `MAX_ITEM_QUANTITY` (99, increment disabled at max)
- **Item key**: Composite `(productId, size)` — same product with different sizes = different cart items
- **Icons**: `Plus`, `Minus`, `Trash2` from `lucide-react`
- **UI primitives**: `Button` (size `icon-sm`), project `cn()` utility for class merging
- **Test fixtures**: Create `createCartItem()` fixture helper in test file

---

## Implementation Plan

### Overview

Create two files using TDD (tests first):
- `frontend/components/cart/CartItem.test.tsx` — 25 test cases
- `frontend/components/cart/CartItem.tsx` — presentational component

### Props Interface

```typescript
interface CartItemProps {
  item: CartItemLocal;
  onUpdateQuantity: (productId: string, size: string | null, newQuantity: number) => void;
  onRemove: (productId: string, size: string | null) => void;
}
```

### Step 1: Create test file with fixtures and mocks (RED)

**File:** `frontend/components/cart/CartItem.test.tsx`

**Mocks:** `next/link` (as `<a>`), `next/image` (as `<img>`), `lucide-react` icons (as `<svg data-testid>`)

**Fixture:** `createCartItem(overrides?: Partial<CartItemLocal>)` with sensible defaults (productId: 'prod-1', slug: 'funny-cat-meme-tshirt', title: 'Funny Cat Meme T-Shirt', price: 24.99, size: 'M', quantity: 2, primaryImage with url/altText)

**Test cases by group:**

**Product Image Display (3 tests)**
1. Renders product image with correct src, alt, width=80, height=80
2. Renders ImageOff fallback when primaryImage is null
3. Fallback has `aria-label="No product image"`

**Product Title and Link (2 tests)**
4. Renders product title text
5. Title links to `/products/{slug}`

**Size Display (2 tests)**
6. Shows size label when size is not null ("M")
7. Does not show size label when size is null

**Price Display (3 tests)**
8. Shows formatted unit price (`/24,99\s€/`)
9. Shows formatted line total (price × qty: `/49,98\s€/`)
10. Line total equals unit price when quantity is 1

**Quantity Controls (7 tests)**
11. Displays current quantity
12. Calls `onUpdateQuantity(productId, size, qty+1)` on + click
13. Calls `onUpdateQuantity(productId, size, qty-1)` on - click
14. Disables decrement when quantity is 1
15. Disables increment when quantity is MAX_ITEM_QUANTITY (99)
16. Does not disable decrement when quantity > 1
17. Does not disable increment when quantity < MAX_ITEM_QUANTITY

**Remove Button (2 tests)**
18. Calls `onRemove(productId, size)` on click
19. Calls `onRemove(productId, null)` when size is null

**Accessibility (4 tests)**
20. Increment button has aria-label containing "Increase"
21. Decrement button has aria-label containing "Decrease"
22. Remove button has aria-label containing "Remove"
23. Image renders alt text from primaryImage

**Edge Cases (2 tests)**
24. Handles item with null size — no size label, callbacks receive null
25. Passes correct productId and size=null for onUpdateQuantity

### Step 2: Implement CartItem component (GREEN)

**File:** `frontend/components/cart/CartItem.tsx`

**Imports:**
- `Link` from `next/link`, `Image` from `next/image`
- `{ Plus, Minus, Trash2, ImageOff }` from `lucide-react`
- `{ Button }` from `@/components/ui/button`
- `{ formatPrice }` from `@/lib/utils`
- `{ MAX_ITEM_QUANTITY }` from `@/stores/cartStore`
- `type { CartItemLocal }` from `@/stores/cartStore`

**Structure:**
- Flex row layout: image | info column | quantity controls | line total + remove
- Image: `<Image width={80} height={80} className="object-cover rounded" />` or `<ImageOff>` fallback
- Title: `<Link href={/products/${slug}}>`
- Size: conditional `{size && <span>Size: {size}</span>}`
- Price: `formatPrice(price)` for unit, `formatPrice(Math.round(price * quantity * 100) / 100)` for line total
- Buttons: `Button variant="ghost" size="icon-sm"` with appropriate aria-labels
- Decrement: `disabled={quantity <= 1}`
- Increment: `disabled={quantity >= MAX_ITEM_QUANTITY}`

### Step 3: Run tests and verify GREEN

```bash
cd frontend && npx jest --testPathPatterns components/cart/CartItem.test.tsx
```

### Step 4: Refactor

- Review Tailwind classes for consistency with ProductCard pattern
- Ensure no `any` types
- Verify component is fully presentational (no store imports besides types)

### Step 5: Full verification

```bash
cd frontend && npm test && npm run lint && npm run build
```

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-19*
