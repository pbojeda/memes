# B1.1: Create User model and migration

**Sprint:** 1
**Type:** Backend - Model
**Priority:** High
**Status:** Completed
**Branch:** feature/sprint1-B1.1-user-model
**Created:** 2026-02-05
**Completed:** 2026-02-05
**Dependencies:** None (first task of Sprint 1)

---

## Description

Create the User model with all necessary fields for authentication. This is the foundational model for Sprint 1's authentication system. The model must support:
- Basic user information (email, name, phone)
- Role-based access control (TARGET, MANAGER, ADMIN, MARKETING)
- Authentication fields (password hash, refresh tokens)
- Password reset functionality
- Soft delete capability

Design decision: Single session authentication (one refresh token per user) chosen for MVP simplicity.

---

## Acceptance Criteria

- [x] User model created in Prisma schema
- [x] UserRole enum defined (TARGET, MANAGER, ADMIN, MARKETING)
- [x] Base fields: id (UUID), email, password_hash, first_name, last_name, phone
- [x] Auth fields: email_verified_at, password_reset_token, password_reset_expires, last_login_at, refresh_token_hash
- [x] Timestamps: created_at, updated_at, deleted_at (soft delete)
- [x] Indexes on email, role, stripe_customer_id
- [x] Migration created and applied
- [x] data-model.md documentation updated
- [x] All existing tests pass
- [x] Build succeeds

---

## Files Created/Modified

| File | Purpose |
|------|---------|
| `backend/prisma/schema.prisma` | Added User model and UserRole enum |
| `backend/prisma/migrations/20260205153350_create_user_model/migration.sql` | Initial migration for users table |
| `ai-specs/specs/data-model.md` | Updated User entity documentation (sections 3.1, 5, 6) |
| `ai-specs/specs/backend-standards.mdc` | Added "Data Model Documentation" section |

---

## Implementation Steps

### Step 1: Review existing data model
1. Read `ai-specs/specs/data-model.md` for User entity design
2. Verify base fields match requirements
3. Identify additional auth fields needed

### Step 2: Define auth fields
1. email_verified_at - For email verification flow
2. password_reset_token - Hashed token for password reset
3. password_reset_expires - Token expiration
4. last_login_at - Session tracking
5. refresh_token_hash - Single session refresh token (MVP decision)

### Step 3: Update documentation
1. Update data-model.md sections 3.1, 5, and 6
2. Add Data Model Documentation section to backend-standards.mdc

### Step 4: Implement Prisma schema
1. Add UserRole enum
2. Add User model with all fields
3. Add indexes

### Step 5: Create migration
1. Run `npx prisma migrate dev --name create_user_model`
2. Verify migration SQL

### Step 6: Validate
1. Run lint
2. Run build
3. Run tests

---

## Technical Notes

- **Prisma 7**: Uses `prisma.config.ts` for DATABASE_URL, not in schema.prisma
- **UUID**: Using `@default(uuid())` for primary keys
- **Soft delete**: `deleted_at` field for data recovery
- **Single session**: Only one refresh_token_hash per user (MVP decision, can evolve to RefreshToken table later)
- **Field mapping**: camelCase in code, snake_case in database via `@map()`

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Migration created and applied
- [x] Documentation updated (data-model.md, backend-standards.mdc)
- [x] No linting errors
- [x] Build succeeds
- [x] All tests pass (52/52)

---

## Retrospective Note

This ticket was created retroactively. The workflow (sprint tracker → ticket → user review → implement) was not followed. Process corrected for remaining Sprint 1 tasks.

---

*Ticket created: 2026-02-05 (retroactive)*
