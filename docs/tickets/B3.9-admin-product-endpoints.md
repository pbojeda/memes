# B3.9: Create Admin Product Endpoints

**Sprint:** 3
**Type:** Backend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint3-B3.9-admin-product-endpoints
**Created:** 2026-02-13
**Dependencies:** B3.3 (Product service CRUD) - Completed

---

## Description

Add the remaining admin CRUD endpoints for product management. The service layer already has all methods implemented (B3.3), but the presentation layer (controller + routes) is missing endpoints for **create**, **update**, **list**, **get by ID**, **activate**, and **deactivate** products.

Currently implemented: `GET /:slug` (public detail), `DELETE /:id` (soft delete), `POST /:id/restore` (restore). This task adds the remaining endpoints defined in `api-spec.yaml`.

---

## Acceptance Criteria

- [x] `POST /api/products` — Create product (MANAGER/ADMIN), returns 201
- [x] `PATCH /api/products/:id` — Update product (MANAGER/ADMIN), returns 200
- [x] `GET /api/products` — List products with filters/pagination (public, optionalAuth for admin filters)
- [x] `GET /api/products/:id` — Get product by ID (MANAGER/ADMIN), returns 200 (merged into GET /:slug with UUID detection)
- [x] `POST /api/products/:id/activate` — Activate product (MANAGER/ADMIN), returns 200
- [x] `POST /api/products/:id/deactivate` — Deactivate product (MANAGER/ADMIN), returns 200
- [x] `handleProductError` handles `ProductSlugAlreadyExistsError` (409 Conflict)
- [x] Create endpoint passes `createdByUserId` from auth token
- [x] Update endpoint passes `changedByUserId` and `priceChangeReason` from request
- [x] List endpoint supports admin filter `includeSoftDeleted` only for MANAGER/ADMIN
- [x] Unit tests for all new controller handlers (47 controller tests, 760 total)
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `src/presentation/controllers/productController.ts` | Add createProduct, updateProduct, listProducts, getProductById, activateProduct, deactivateProduct handlers |
| `src/presentation/controllers/productController.test.ts` | Unit tests for all new handlers |
| `src/routes/productRoutes.ts` | Register new routes with auth/role middleware |

---

## Implementation Steps

### Step 1: Add `ProductSlugAlreadyExistsError` handling
1. Import `ProductSlugAlreadyExistsError` in productController
2. Add 409 Conflict mapping in `handleProductError`

### Step 2: Add `createProduct` handler
1. Extract `req.body` as input and `req.user.userId` as `createdByUserId`
2. Call `productService.createProduct({ ...input, createdByUserId })`
3. Return `created(res, product)` (201)

### Step 3: Add `updateProduct` handler
1. Extract `req.params.id`, `req.body`, `req.user.userId`
2. Extract `priceChangeReason` from body, pass rest as update input
3. Call `productService.updateProduct(id, input, userId, reason)`
4. Return `success(res, product)` (200)

### Step 4: Add `listProducts` handler
1. Extract query params: page, limit, search, productTypeId, isActive, isHot, minPrice, maxPrice, sortBy, sortDirection
2. If user has MANAGER/ADMIN role, allow `includeSoftDeleted` filter
3. Call `productService.listProducts(input)`
4. Return paginated response

### Step 5: Add `getProductById` handler
1. Extract `req.params.id`
2. Call `productService.getProductById(id, true)` (include soft-deleted for admin)
3. Return `success(res, product)` (200)

### Step 6: Add `activateProduct` / `deactivateProduct` handlers
1. Extract `req.params.id`
2. Call `productService.updateProduct(id, { isActive: true/false })`
3. Return `success(res, product)` (200)

### Step 7: Register routes
1. `POST /` — authMiddleware + requireRole([MANAGER, ADMIN]) + createProduct
2. `GET /` — optionalAuthMiddleware + listProducts
3. `GET /:id` — authMiddleware + requireRole([MANAGER, ADMIN]) + getProductById
4. `PATCH /:id` — authMiddleware + requireRole([MANAGER, ADMIN]) + updateProduct
5. `POST /:id/activate` — authMiddleware + requireRole([MANAGER, ADMIN]) + activateProduct
6. `POST /:id/deactivate` — authMiddleware + requireRole([MANAGER, ADMIN]) + deactivateProduct
7. Ensure route ordering avoids conflicts (e.g., `GET /` before `GET /:slug`)

### Step 8: Write unit tests (TDD)
1. Test each handler: success path, error paths (400, 404, 409)
2. Test `listProducts` role-aware filtering (public vs admin)
3. Test `createProduct` passes `createdByUserId`
4. Test `updateProduct` passes `changedByUserId` and `priceChangeReason`

---

## Technical Notes

- **Route ordering matters**: `GET /api/products` (list) must be registered before `GET /api/products/:slug` (detail) to avoid treating "list" as a slug parameter. Also `GET /:id` (UUID param) needs careful ordering with `GET /:slug`.
- **Strategy for /:id vs /:slug conflict**: Since `getProductById` is admin-only (auth required) and `getProductDetail` is public (no auth), we can use two approaches: (a) use a UUID regex to distinguish, or (b) route admin endpoints under a different path. The simplest approach: register `GET /` (list) first, then `GET /:slug` remains as-is since the planner will decide the best route structure.
- **Existing patterns**: Follow B3.6 (soft delete) and B3.7 (image endpoints) controller patterns exactly.
- **Response helpers**: Use `success()`, `created()`, `noContent()` from `utils/responseHelpers`.
- **Auth user type**: `req.user` is set by `authMiddleware` with `{ userId, email, role }`.
- **optionalAuthMiddleware**: Already exists, sets `req.user` if token present but doesn't require it.

---

## Implementation Plan

### Design Decision: Route Ordering for `GET /:id` vs `GET /:slug`

**Chosen approach: UUID regex constraint** on admin `:id` routes.

Use Express path parameter regex: `/:id([0-9a-f]{8}-[0-9a-f]{4}-...)` so UUID-format paths go to admin handlers and everything else falls to the slug handler. This avoids breaking the API spec contract and is consistent with existing `DELETE /:id` and `POST /:id/restore` routes.

**Route registration order:**
1. `GET /` — listProducts (exact match first)
2. `POST /` — createProduct (exact match)
3. `GET /:id(UUID)` — getProductById (admin, UUID only)
4. `PATCH /:id(UUID)` — updateProduct
5. `DELETE /:id(UUID)` — deleteProduct (existing)
6. `POST /:id(UUID)/restore` — restoreProduct (existing)
7. `POST /:id(UUID)/activate` — activateProduct
8. `POST /:id(UUID)/deactivate` — deactivateProduct
9. `GET /:slug` — getProductDetail (public, catches non-UUID)
10. Image routes (multi-segment, no ambiguity)

### Service Layer Minor Extension

The `createProduct` service does NOT currently pass `createdByUserId` to Prisma. Required changes:
1. Add `createdByUserId?: string` to `CreateProductInput` and `ValidatedCreateProductInput` in validator
2. Pass through in `validateCreateProductInput`
3. Add `createdByUserId: validated.createdByUserId ?? null` to `prisma.product.create` data

### TDD Execution Order

| # | Action | Tests |
|---|--------|-------|
| 1 | Add `ProductSlugAlreadyExistsError` → 409 in `handleProductError` | 1 |
| 2 | `createProduct` handler + service `createdByUserId` extension | 4 |
| 3 | `updateProduct` handler (extracts `priceChangeReason` from body) | 6 |
| 4 | `listProducts` handler (role-aware `includeSoftDeleted`) | 8 |
| 5 | `getProductById` handler (admin, `includeSoftDeleted=true`) | 4 |
| 6 | `activateProduct` + `deactivateProduct` handlers | 7 |
| 7 | Update `productRoutes.ts` with UUID regex + correct ordering | — |
| **Total** | | **~30** |

### Handler Signatures

- `createProduct`: Spreads `req.body` + `req.user!.userId` as `createdByUserId` → `created(res, product)` (201)
- `updateProduct`: Destructures `{ priceChangeReason, ...updateInput }` from body, passes `req.user!.userId` as `changedByUserId` → `success(res, product)` (200)
- `listProducts`: Parses query params (page/limit/search/etc), checks `req.user?.role` for `includeSoftDeleted` permission → inline JSON response with `data` + `pagination`
- `getProductById`: Calls `getProductById(id, true)` (admin sees soft-deleted) → `success(res, product)` (200)
- `activateProduct`/`deactivateProduct`: Calls `updateProduct(id, { isActive: true/false })` → `success(res, product)` (200)

### Files to Modify

| File | Changes |
|------|---------|
| `src/presentation/controllers/productController.ts` | Add 6 handlers, update `handleProductError` with 409 |
| `src/presentation/controllers/productController.test.ts` | ~30 new test cases |
| `src/routes/productRoutes.ts` | Rewrite with UUID regex routing + new endpoints |
| `src/application/validators/productValidator.ts` | Add `createdByUserId` to CreateProductInput |
| `src/application/services/productService.ts` | Pass `createdByUserId` to Prisma create |

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (47 controller tests, 760 total)
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-13*
