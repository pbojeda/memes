# B4.6: Write Cart/Checkout Integration Tests

**Sprint:** 4
**Type:** Backend - Test
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint4-B4.6-cart-checkout-integration-tests
**Created:** 2026-02-19
**Dependencies:** B4.1 (Address), B4.2 (Address service), B4.3 (Cart validation), B4.4 (Promo code), B4.5 (Order total) — all completed

---

## Description

Each cart/checkout module (address, cart, promo code, order total) already has its own route-level integration tests. B4.6 adds **cross-module checkout flow integration tests** that verify the complete user journey across multiple endpoints, ensuring the modules compose correctly end-to-end.

These tests simulate realistic checkout scenarios by calling multiple endpoints sequentially (as the frontend would), verifying that data flows correctly between cart validation, promo code application, order total calculation, and address management.

---

## Acceptance Criteria

- [x] Cross-module checkout flow test file created at `src/routes/checkoutFlow.integration.test.ts`
- [x] **Full checkout happy path**: validate cart → validate promo code → calculate order total with promo → verify address exists
- [x] **Cart-to-order-total consistency**: subtotals from `/cart/validate` match subtotals in `/cart/calculate` for same items
- [x] **Promo code flow**: validate promo standalone → then apply via calculate → discount matches
- [x] **Invalid cart propagation**: invalid items from cart validation correctly propagate to order total calculation
- [x] **Mixed scenario**: cart with some valid/invalid items + expired promo code → correct totals and errors
- [x] **Address + checkout flow**: authenticated user creates address, then public endpoints validate cart and calculate total
- [x] **FIXED_AMOUNT promo code flow**: end-to-end with fixed discount through validate → calculate
- [x] **Multiple items with discount**: multi-item cart + percentage promo → correct calculations across endpoints
- [x] All tests pass: `npm test`
- [x] Lint passes: `npm run lint`
- [x] Build succeeds: `npm run build`

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `src/routes/checkoutFlow.integration.test.ts` | Cross-module checkout flow integration tests |

---

## Technical Notes

- Follow the existing integration test pattern: `supertest` + express test app + mocked Prisma + mocked tokenService
- Re-use the same `createTestApp()` pattern from existing route integration tests
- Mock prisma with all modules needed: `product.findMany`, `promoCode.findUnique`, `address.*`, `$transaction`, `user.findUnique`
- Use factory functions (`makeProduct`, `makePromoCode`, `makeAddress`) for test data
- Each test scenario calls multiple endpoints sequentially, asserting cross-endpoint data consistency
- Public endpoints (cart validate, promo validate, cart calculate) don't need auth headers
- Address endpoints require auth setup via mocked `tokenService.verifyAccessToken`

---

## Implementation Plan

### Step 1: Create test file with boilerplate and mocks

Create `backend/src/routes/checkoutFlow.integration.test.ts` with:

- **Imports:** `supertest`, `express`, `prisma` mock, `tokenService` mock, `UserRole`, `Address` type
- **Prisma mock:** Union of all modules — `product.findMany`, `promoCode.findUnique`, `address.*` (findMany, findFirst, count, create, update, updateMany, delete), `user.findUnique`, `$transaction`, `$queryRaw`
- **Token service mock:** Same pattern as existing integration tests
- **`createTestApp()`** factory — same pattern
- **`beforeEach(() => jest.clearAllMocks())`**

### Step 2: Define test data factories and constants

- **UUIDs:** `PRODUCT_ID_1`, `PRODUCT_ID_2`, `PRODUCT_ID_3`, `USER_ID`, `ADDRESS_ID`
- **`makeProduct(overrides)`** — Complete product with `productType` (hasSizes: true), `images` array (one primary), base price `100`
- **`makePromoCode(overrides)`** — Default: PERCENTAGE, discountValue 20, isActive true, validFrom past
- **`makeAddress(overrides)`** — Complete Address with userId: USER_ID
- **`setupAuth()`** — Sets `verifyAccessToken` to return `{ userId: USER_ID, email, role: TARGET }`

### Step 3: Write test scenarios

Top-level `describe('Checkout Flow Integration')`:

#### Scenario 1: Full checkout happy path
Call: validate cart (1 item, qty 2, $100) → validate promo (SUMMER20, orderTotal 200) → calculate total with promo → list addresses (auth)
Assert: subtotal 200, discount 40 (20%), total 160, address list works with auth

#### Scenario 2: Cart-to-order-total subtotal consistency
Call: validate cart (2 products, 3 total qty, $300) → calculate total (same items, no promo)
Assert: `data.subtotal` matches across both endpoints (300), total = subtotal (no discount)

#### Scenario 3: Promo code validate-then-apply flow
Call: validate promo standalone (orderTotal 150) → calculate total (items totaling 150 + promo)
Assert: `calculatedDiscount` from promo validate matches `discountAmount` from calculate (30)

#### Scenario 4: Invalid cart propagation to order total
Call: validate cart (product not found) → calculate total (same product)
Assert: Both return `valid: false`, same error code `PRODUCT_NOT_FOUND`, subtotal/total = 0

#### Scenario 5: Mixed valid/invalid items + expired promo
Mock: PRODUCT_ID_1 found ($100), PRODUCT_ID_2 not found, promo expired
Call: validate cart (both items) → calculate total (both items + expired promo)
Assert: subtotal from valid items only (100), discount 0 (expired), promoCodeMessage set, cartErrors present

#### Scenario 6: Address + checkout flow (auth + public)
Call: create address (auth, 201) → validate cart (no auth, 200) → calculate total (no auth, 200)
Assert: Auth and public endpoints compose correctly in same flow

#### Scenario 7: FIXED_AMOUNT promo code end-to-end
Call: validate promo (SAVE15, FIXED_AMOUNT, $15 off, orderTotal 100) → calculate total (item $100 + promo)
Assert: discount 15, total 85, appliedPromoCode.discountType = FIXED_AMOUNT

#### Scenario 8: Multiple items with percentage discount
3 products ($50, $75, $120), 4 total qty → subtotal 295
Call: validate cart → validate promo (20% of 295 = 59) → calculate total
Assert: subtotal 295, discount 59, total 236 consistent across all endpoints

### Step 4: Run quality checks

1. Run `cd backend && npm test -- --testPathPatterns checkoutFlow`
2. Run `cd backend && npm run lint`
3. Run `cd backend && npm run build`
4. Update ticket acceptance criteria

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-19*
