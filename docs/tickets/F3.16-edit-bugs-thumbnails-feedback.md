# F3.16: Fix edit page product type, list thumbnails, save feedback, button text

**Sprint:** 3
**Type:** Backend + Frontend - Bugfix
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint3-F3.16-edit-bugs-thumbnails-feedback
**Created:** 2026-02-18
**Dependencies:** F3.15 (completed)

---

## Description

Four bugs found during manual testing of the admin product management flow. Two are backend issues (missing Prisma `include` relations) and two are frontend UX issues (no success feedback, wrong button text).

### Bug 1 — Product type lost on edit page (BACKEND)
`getProductById()` in `productService.ts:98` does `prisma.product.findFirst({ where })` without `include: { productType: true }`. The product type dropdown shows "Select a product type" instead of the current type.

### Bug 2 — Image thumbnail missing in product list (BACKEND)
`listProducts()` in `productService.ts:372` does `prisma.product.findMany()` without including images. `product.primaryImage` is always `undefined`, so the admin products table shows a grey square instead of the thumbnail.

### Bug 3 — No success feedback after save (FRONTEND)
On the edit page, `onSuccess` callback only calls `setProduct()` silently. No visual confirmation that changes were saved.

### Bug 4 — Button text "Save" → "Update" (FRONTEND)
In `ProductForm.tsx:433`, the button says "Save" in edit mode. Should say "Update" (and "Updating..." during submit).

---

## Acceptance Criteria

- [x] `getProductById()` includes `productType` in query result
- [x] Product type dropdown shows current type when editing a product
- [x] `listProducts()` includes primary image in query result
- [x] Admin products table shows product thumbnail when image exists
- [x] Edit page shows success feedback (e.g., Alert) after saving
- [x] Button text shows "Update" / "Updating..." in edit mode
- [x] Unit tests for backend `getProductById()` productType inclusion
- [x] Unit tests for backend `listProducts()` image inclusion
- [x] Unit tests for frontend success feedback
- [x] Unit tests for frontend button text
- [x] All existing tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/application/services/productService.ts` | Add `include: { productType: true }` to `getProductById()`, add image include to `listProducts()` |
| `backend/src/application/services/__tests__/productService.test.ts` | Tests for productType and image inclusion |
| `frontend/components/admin/products/ProductForm.tsx` | Button text "Update"/"Updating..." in edit mode |
| `frontend/components/admin/products/__tests__/ProductForm.test.tsx` | Tests for button text |
| `frontend/app/admin/products/[productId]/edit/page.tsx` | Success feedback after save |
| `frontend/app/admin/products/[productId]/edit/__tests__/page.test.tsx` | Tests for success feedback |

---

## Implementation Steps

### Step 1: Backend — Fix `getProductById()` (Bug 1)
1. Add `include: { productType: true }` to the `findFirst` call at line 98
2. Write test verifying productType is included in result

### Step 2: Backend — Fix `listProducts()` (Bug 2)
1. Add image include to the `findMany` call at line 372
2. Map primary image to response format
3. Write test verifying primary image is included in list results

### Step 3: Frontend — Fix button text (Bug 4)
1. Change `'Save'` → `'Update'` and `'Saving...'` → `'Updating...'` in ProductForm
2. Write test verifying correct button text in edit mode

### Step 4: Frontend — Add success feedback (Bug 3)
1. Add success state and Alert component to edit page
2. Show "Product updated successfully" after successful save
3. Auto-dismiss after a few seconds
4. Write test verifying success feedback appears

---

## Technical Notes

- Backend: `getProductBySlug()` at line 117 may have the same issue — check if it also needs `include: { productType: true }`
- Backend: For `listProducts()`, use `include: { images: { where: { isPrimary: true }, take: 1 } }` and map to `primaryImage` field
- Frontend: Use existing `Alert` UI component for success feedback
- Frontend: Success feedback should auto-dismiss (setTimeout) to avoid stale messages

---

## Implementation Plan

### Backend Implementation Plan

#### Bug 1: `getProductById()` missing productType include

**Root cause:** `getProductById()` (line 98) calls `prisma.product.findFirst({ where })` without an `include` clause. The Product model has a `productType` relation but without `include: { productType: true }`, the returned object has no `productType` property. The frontend edit form reads `product.productType?.id` to pre-populate the dropdown, which shows "Select a product type" instead of the actual type.

**Also fix:** `getProductBySlug()` (line 117) has the same issue — add `include: { productType: true }` for consistency.

**Test changes (TDD — write first):**

File: `backend/src/application/services/productService.test.ts`

1. Update all existing `getProductById` tests that assert `findFirst` call args (lines 300-303, 311-313, 326-328) to expect `include: { productType: true }` in the call.
2. Update all existing `getProductBySlug` tests that assert `findFirst` call args (lines 374-376, 385-387) to expect `include: { productType: true }`.

**Code changes:**

1. `productService.ts:98-100` — Add `include: { productType: true }` to `getProductById()` findFirst call
2. `productService.ts:117-122` — Add `include: { productType: true }` to `getProductBySlug()` findFirst call

---

#### Bug 2: `listProducts()` missing image include

**Root cause:** `listProducts()` (line 372) calls `prisma.product.findMany()` without `include`. The API spec defines `Product` with a `primaryImage` field, but the backend never populates it. The frontend admin table checks `product.primaryImage` for the thumbnail column.

**Approach:** Include primary image in Prisma query using `include: { images: { where: { isPrimary: true }, take: 1 }, productType: true }`, then map results to add a top-level `primaryImage` field.

**Test changes (TDD — write first):**

File: `backend/src/application/services/__tests__/productService.listProducts.test.ts`

1. Update all existing tests that assert `findMany` call args to expect the new `include` clause.
2. New test: "should map primary image to primaryImage field" — verify that when Prisma returns products with `images: [{ ... }]`, the service maps `images[0]` to `primaryImage`.
3. New test: "should set primaryImage to undefined when no primary image" — when `images` is empty array, `primaryImage` should be `undefined`.

**Code changes:**

1. `productService.ts` — Add `ProductWithPrimaryImage` interface extending `Product` with optional `primaryImage` and `productType` fields. Update `ListProductsResult` to use it.
2. `productService.ts:372-377` — Add `include: { images: { where: { isPrimary: true }, take: 1 }, productType: true }` to findMany.
3. `productService.ts` (after findMany) — Map products to extract `images[0]` into `primaryImage` field and remove `images` array.

---

### Frontend Implementation Plan

#### Bug 4: Button text "Save" → "Update" (simpler, do first)

**Root cause:** In `ProductForm.tsx:427-435`, the button text ternary uses `'Save'` and `'Saving...'` for edit mode.

**Test changes (TDD — write first):**

File: `frontend/components/admin/products/ProductForm.test.tsx`

1. Add new test in edit mode describe block: `'should show "Update" as button text in edit mode'`
2. Update existing test at line ~487: rename from "Saving..." to "Updating...", change assertion to match `/updating/i`
3. Update existing test at line ~472 that uses `screen.getByRole('button', { name: /save/i })` to use `/update/i`

**Code changes:**

File: `frontend/components/admin/products/ProductForm.tsx`
- Line 430: `'Saving...'` → `'Updating...'`
- Line 433: `'Save'` → `'Update'`

---

#### Bug 3: No success feedback after save

**Root cause:** In the edit page (line 67), `onSuccess={setProduct}` silently updates state with no visual confirmation.

**Design:** Add `successMessage` state to the edit page. When `onSuccess` fires, set it to "Product updated successfully". Render an `Alert` (default variant with green styling) above the form. Auto-dismiss after 5 seconds via `setTimeout`.

Success feedback lives in the **edit page** (not ProductForm) because:
- ProductForm is reusable (create + edit)
- Create page redirects on success (no message needed)
- Edit page stays — needs explicit feedback

**Test changes (TDD — write first):**

File: `frontend/app/admin/products/[productId]/edit/page.test.tsx`

1. New test: `'should show success message after onSuccess is called'` — trigger the mock form's save button, assert "Product updated successfully" appears.
2. New test: `'should auto-dismiss success message after timeout'` — use `jest.useFakeTimers()`, advance 5s, assert message disappears.

**Code changes:**

File: `frontend/app/admin/products/[productId]/edit/page.tsx`

1. Add `useRef` to React imports
2. Add `successMessage` state and `successTimerRef` ref
3. Add cleanup effect for the timer
4. Create `handleSuccess` callback that sets product, sets success message, starts 5s timer
5. Render `Alert` with `AlertDescription` above `ProductForm` when `successMessage` is set
6. Change `onSuccess={setProduct}` to `onSuccess={handleSuccess}`

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-18*
