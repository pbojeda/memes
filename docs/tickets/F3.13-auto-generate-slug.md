# F3.13: Backend auto-generate slug from title when not provided

**Sprint:** 3
**Type:** Backend - Bugfix
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint3-F3.13-auto-generate-slug
**Created:** 2026-02-17
**Dependencies:** B3.3 (product service), B3.9 (admin product endpoints)

---

## Description

When creating a product via the admin form (`/admin/products/new`), the backend returns `400: "Slug is required"` because:

1. The frontend `CreateProductRequest` (from `api-spec.yaml`) does not include a `slug` field
2. The frontend `ProductForm` does not send a `slug` field
3. The backend `validateCreateProductInput` calls `validateSlug(input.slug, 'slug')` with `required: true`
4. No slug auto-generation logic exists in the backend

The fix: when `slug` is not provided in `CreateProductInput`, the backend should auto-generate it from `title.es` (Spanish title). The slug must be unique — if a collision occurs, append a numeric suffix (`-1`, `-2`, etc.).

---

## Acceptance Criteria

- [x] `CreateProductInput.slug` becomes optional (`slug?: string`)
- [x] `validateCreateProductInput` makes slug validation optional (not required when absent)
- [x] `productService.createProduct` auto-generates slug from `title.es` when slug is not provided
- [x] Slug generation: lowercase, replace spaces/special chars with hyphens, strip accents (e.g. "Camiseta Meme Gato" → "camiseta-meme-gato")
- [x] On slug collision (P2002 unique constraint), retry with `-1`, `-2`, etc. suffix (max 10 retries)
- [x] When slug IS provided, behavior is unchanged (validate and use as-is)
- [x] `api-spec.yaml` updated: `slug` added as optional with `pattern` and `maxLength` constraints
- [x] Frontend types regenerated after api-spec change
- [x] Unit tests for slug generation logic (happy path, accents, special chars, collisions)
- [x] Unit tests for validator change (slug optional on create)
- [x] All existing tests pass (977 backend, 582 frontend)
- [x] Build succeeds
- [x] Auto-generated slug truncated to MAX_SLUG_LENGTH (100 chars) — production-validator fix
- [x] P2002 catch scoped to slug constraint via `error.meta.target` — production-validator fix
- [x] Slug field in api-spec has `pattern` and `maxLength` — production-validator fix

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/utils/slugify.ts` | New utility: `generateSlug(text: string): string` |
| `backend/src/utils/slugify.test.ts` | Tests for slugify utility |
| `backend/src/application/validators/productValidator.ts` | Make slug optional in `CreateProductInput` and `validateCreateProductInput` |
| `backend/src/application/validators/productValidator.test.ts` | Update tests for optional slug |
| `backend/src/application/services/productService.ts` | Auto-generate slug in `createProduct` when not provided, retry on collision |
| `backend/src/application/services/productService.test.ts` | Tests for auto-generation and collision retry |
| `ai-specs/specs/api-spec.yaml` | Update `CreateProductRequest` schema (slug optional or removed) |
| `frontend/lib/api/types.ts` | Regenerated (no manual edit) |

---

## Technical Notes

- **Slug regex**: Must match `SLUG_REGEX = /^[a-z0-9]+(?:-[a-z0-9]+)*$/` from `shared.ts`
- **Accent handling**: Use `String.normalize('NFD').replace(/[\u0300-\u036f]/g, '')` for stripping diacritics (e.g. "café" → "cafe")
- **Existing slug validation**: `shared.ts:validateSlug()` already supports `required: false` parameter — just need to pass `false` when slug is absent
- **Collision handling**: Prisma throws `P2002` on unique constraint violation — already caught in `productService.createProduct` as `ProductSlugAlreadyExistsError`. Need to add retry logic before that catch.
- **No new dependencies**: Use native JS string methods for slugification (no need for external library)

---

## Implementation Plan

### Overview

The fix requires changes in three layers, implemented in strict TDD order:

1. New utility `backend/src/utils/slugify.ts` — pure string transformation
2. Validator change in `productValidator.ts` — make `slug` optional on create
3. Service change in `productService.ts` — auto-generate slug and retry on collision
4. OpenAPI spec update — remove `slug` from `CreateProductRequest` (it was never there, but add it as optional for explicit sends)
5. Frontend types regeneration

No new dependencies required — all string operations use native JS.

---

### Step 1 — Slugify utility (TDD: red → green → refactor)

#### 1a. Write failing tests first

**File to create:** `backend/src/utils/slugify.test.ts`

```typescript
import { generateSlug } from './slugify';

describe('generateSlug', () => {
  it('should lowercase all characters', () => {
    expect(generateSlug('CAMISETA')).toBe('camiseta');
  });

  it('should replace spaces with hyphens', () => {
    expect(generateSlug('Camiseta Meme Gato')).toBe('camiseta-meme-gato');
  });

  it('should strip accent marks (diacritics)', () => {
    expect(generateSlug('café')).toBe('cafe');
    expect(generateSlug('cañón')).toBe('canon');
    expect(generateSlug('Ñoño')).toBe('nono');
  });

  it('should replace special characters with hyphens', () => {
    expect(generateSlug('hello! world?')).toBe('hello-world');
    expect(generateSlug('price: $10.00')).toBe('price-10-00');
  });

  it('should collapse multiple consecutive hyphens into one', () => {
    expect(generateSlug('hello   world')).toBe('hello-world');
    expect(generateSlug('a -- b')).toBe('a-b');
  });

  it('should strip leading and trailing hyphens', () => {
    expect(generateSlug('  hello  ')).toBe('hello');
    expect(generateSlug('!hello!')).toBe('hello');
  });

  it('should preserve numbers', () => {
    expect(generateSlug('Camiseta 2024 v2')).toBe('camiseta-2024-v2');
  });

  it('should produce a slug matching SLUG_REGEX for typical Spanish product titles', () => {
    const SLUG_REGEX = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
    expect(SLUG_REGEX.test(generateSlug('Camiseta Meme Gato'))).toBe(true);
    expect(SLUG_REGEX.test(generateSlug('café con leche'))).toBe(true);
  });

  it('should handle a title that is all special characters by returning a fallback', () => {
    // After stripping everything, result is empty — return 'product' as fallback
    expect(generateSlug('!!!')).toBe('product');
  });
});
```

Run: `cd /Users/pb/Developer/FiveGuays/memes/backend && npx jest slugify.test --no-coverage`
Expected result: All tests FAIL (module not found). This is the RED phase.

#### 1b. Implement the utility

**File to create:** `backend/src/utils/slugify.ts`

```typescript
/**
 * Converts a plain-text string into a URL-safe slug.
 *
 * Algorithm:
 * 1. Normalise to NFD (decomposed) form and strip diacritic combining marks
 * 2. Lowercase
 * 3. Replace any character that is not a lowercase letter or digit with a hyphen
 * 4. Collapse runs of consecutive hyphens into a single hyphen
 * 5. Strip leading/trailing hyphens
 * 6. If the result is empty, fall back to 'product'
 *
 * Output always satisfies /^[a-z0-9]+(?:-[a-z0-9]+)*$/ or equals 'product'.
 */
export function generateSlug(text: string): string {
  const slug = text
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')   // strip diacritic combining marks
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')       // non-alphanumeric → hyphen
    .replace(/-+/g, '-')               // collapse consecutive hyphens
    .replace(/^-|-$/g, '');            // strip leading/trailing hyphens

  return slug || 'product';
}
```

Run tests again — all should PASS. This is the GREEN phase.

No refactor needed; the implementation is already minimal and clear.

---

### Step 2 — Make slug optional in the validator (TDD)

#### 2a. Update existing validator tests (RED first)

**File to modify:** `backend/src/application/validators/productValidator.test.ts`

**Changes required:**

1. In the `describe('valid inputs')` block, add a new test:

```typescript
it('should return undefined slug when slug is not provided', () => {
  const input: CreateProductInput = {
    title: { es: 'Producto' },
    description: { es: 'Descripción' },
    price: 10.00,
    productTypeId: '123e4567-e89b-12d3-a456-426614174000',
    color: 'Rojo',
  };

  const result = validateCreateProductInput(input);

  expect(result.slug).toBeUndefined();
});
```

2. Change the existing test `'should throw InvalidProductDataError when slug is missing'` (line 244-255) to instead verify that omitting slug does NOT throw:

```typescript
it('should not require slug — omitting it returns undefined slug', () => {
  const input = {
    title: { es: 'Producto' },
    description: { es: 'Descripción' },
    price: 10.00,
    productTypeId: '123e4567-e89b-12d3-a456-426614174000',
    color: 'Rojo',
  };

  // No slug provided — should validate without error
  const result = validateCreateProductInput(input as never);
  expect(result.slug).toBeUndefined();
});
```

Note: All existing tests that already pass a `slug` in `validInput` will continue to work unchanged.

Run tests — the new tests FAIL because the validator currently requires slug. RED phase.

#### 2b. Update the validator interfaces and function

**File to modify:** `backend/src/application/validators/productValidator.ts`

**Change 1 — `CreateProductInput` interface (line 10-22):**

```typescript
// Before:
export interface CreateProductInput {
  // ...
  slug: string;
  // ...
}

// After:
export interface CreateProductInput {
  // ...
  slug?: string;
  // ...
}
```

**Change 2 — `ValidatedCreateProductInput` interface (line 24-38):**

```typescript
// Before:
export interface ValidatedCreateProductInput {
  // ...
  slug: string;
  // ...
}

// After:
export interface ValidatedCreateProductInput {
  // ...
  slug?: string;   // undefined when not provided — service will generate it
  // ...
}
```

**Change 3 — `validateCreateProductInput` function body (line 207-238):**

Replace the current unconditional slug validation:
```typescript
// Before (line 210):
const slug = validateSlug(input.slug, 'slug');
```

With a conditional validation:
```typescript
// After:
const slug = input.slug !== undefined ? validateSlug(input.slug, 'slug') : undefined;
```

The rest of the function body is unchanged. The returned object already spreads `slug` directly, so passing `undefined` works correctly with TypeScript.

Run tests — all should now PASS. GREEN phase.

---

### Step 3 — Auto-generation and collision retry in the service (TDD)

#### 3a. Write new failing service tests first

**File to modify:** `backend/src/application/services/productService.test.ts`

**Changes in the `describe('createProduct')` block:**

1. Update `validInput` to remove the `slug` field (making it the default "no slug" case):

```typescript
const validInput = {
  title: { es: 'Camiseta Premium' },
  description: { es: 'Una camiseta de alta calidad' },
  // slug intentionally omitted — service should auto-generate
  price: 29.99,
  productTypeId: '123e4567-e89b-12d3-a456-426614174000',
  color: 'Rojo',
};
```

2. Update the existing test `'should create product with valid input'` to expect the auto-generated slug (not an explicit one). Since `generateSlug('Camiseta Premium')` → `'camiseta-premium'`, the call to `prisma.product.create` should include `slug: 'camiseta-premium'`:

```typescript
it('should create product with valid input (auto-generated slug from title.es)', async () => {
  (mockPrisma.product.create as jest.Mock).mockResolvedValue(mockCreatedProduct);

  const result = await createProduct(validInput);

  expect(mockPrisma.product.create).toHaveBeenCalledWith({
    data: expect.objectContaining({
      slug: 'camiseta-premium',  // auto-generated from 'Camiseta Premium'
    }),
  });
  expect(result).toEqual(mockCreatedProduct);
});
```

3. Add test for explicit slug bypassing auto-generation:

```typescript
it('should use provided slug when slug is explicitly given', async () => {
  const inputWithSlug = { ...validInput, slug: 'my-custom-slug' };
  (mockPrisma.product.create as jest.Mock).mockResolvedValue({
    ...mockCreatedProduct,
    slug: 'my-custom-slug',
  });

  await createProduct(inputWithSlug);

  expect(mockPrisma.product.create).toHaveBeenCalledWith({
    data: expect.objectContaining({ slug: 'my-custom-slug' }),
  });
});
```

4. Add collision retry test:

```typescript
it('should retry with numeric suffix on slug collision', async () => {
  const p2002Error = new Prisma.PrismaClientKnownRequestError('Unique constraint failed', {
    code: 'P2002',
    clientVersion: '6.0.0',
  });
  const mockProductWithSuffix = { ...mockCreatedProduct, slug: 'camiseta-premium-1' };

  // First attempt fails with P2002, second attempt succeeds
  (mockPrisma.product.create as jest.Mock)
    .mockRejectedValueOnce(p2002Error)
    .mockResolvedValueOnce(mockProductWithSuffix);

  const result = await createProduct(validInput);

  expect(mockPrisma.product.create).toHaveBeenCalledTimes(2);
  expect(mockPrisma.product.create).toHaveBeenNthCalledWith(1,
    { data: expect.objectContaining({ slug: 'camiseta-premium' }) }
  );
  expect(mockPrisma.product.create).toHaveBeenNthCalledWith(2,
    { data: expect.objectContaining({ slug: 'camiseta-premium-1' }) }
  );
  expect(result).toEqual(mockProductWithSuffix);
});
```

5. Add max-retry exhaustion test:

```typescript
it('should throw ProductSlugAlreadyExistsError after 10 collision retries when slug was explicitly provided', async () => {
  const p2002Error = new Prisma.PrismaClientKnownRequestError('Unique constraint failed', {
    code: 'P2002',
    clientVersion: '6.0.0',
  });

  // All 11 attempts (base + 10 suffixes) fail
  (mockPrisma.product.create as jest.Mock).mockRejectedValue(p2002Error);

  const inputWithSlug = { ...validInput, slug: 'taken-slug' };

  await expect(createProduct(inputWithSlug)).rejects.toThrow(ProductSlugAlreadyExistsError);
  // 1 base attempt + 10 suffix attempts = 11 total
  expect(mockPrisma.product.create).toHaveBeenCalledTimes(11);
});
```

6. Add test verifying auto-generation retries also exhaust and throw:

```typescript
it('should throw ProductSlugAlreadyExistsError after 10 retries for auto-generated slug', async () => {
  const p2002Error = new Prisma.PrismaClientKnownRequestError('Unique constraint failed', {
    code: 'P2002',
    clientVersion: '6.0.0',
  });

  (mockPrisma.product.create as jest.Mock).mockRejectedValue(p2002Error);

  await expect(createProduct(validInput)).rejects.toThrow(ProductSlugAlreadyExistsError);
  expect(mockPrisma.product.create).toHaveBeenCalledTimes(11);
});
```

Run tests — new tests FAIL. RED phase.

#### 3b. Update the service

**File to modify:** `backend/src/application/services/productService.ts`

**Change 1 — add the import at the top:**

```typescript
import { generateSlug } from '../../utils/slugify';
```

**Change 2 — replace the `createProduct` function entirely:**

```typescript
/**
 * Creates a new product.
 * When slug is not provided, auto-generates it from title.es.
 * On slug collision (P2002), retries with numeric suffix up to MAX_SLUG_RETRIES times.
 *
 * @throws {InvalidProductDataError} If input validation fails
 * @throws {ProductSlugAlreadyExistsError} If slug collides after all retries are exhausted
 */
export async function createProduct(input: CreateProductInput): Promise<Product> {
  const validated = validateCreateProductInput(input);

  const MAX_SLUG_RETRIES = 10;
  const baseSlug = validated.slug ?? generateSlug(validated.title.es);

  for (let attempt = 0; attempt <= MAX_SLUG_RETRIES; attempt++) {
    const slug = attempt === 0 ? baseSlug : `${baseSlug}-${attempt}`;

    try {
      const product = await prisma.product.create({
        data: {
          title: validated.title,
          description: validated.description,
          slug,
          price: validated.price,
          compareAtPrice: validated.compareAtPrice,
          availableSizes: validated.availableSizes,
          productTypeId: validated.productTypeId,
          color: validated.color,
          isActive: validated.isActive,
          isHot: validated.isHot,
          salesCount: validated.salesCount,
          viewCount: validated.viewCount,
          createdByUserId: validated.createdByUserId ?? null,
        },
      });

      return product;
    } catch (error) {
      if (error instanceof Prisma.PrismaClientKnownRequestError && error.code === 'P2002') {
        if (attempt === MAX_SLUG_RETRIES) {
          throw new ProductSlugAlreadyExistsError();
        }
        // Continue to next attempt with suffix
        continue;
      }
      throw error;
    }
  }

  // TypeScript requires an explicit throw here (unreachable at runtime)
  throw new ProductSlugAlreadyExistsError();
}
```

Key points about this implementation:
- `validated.slug` is now `string | undefined` (after Step 2). When `undefined`, `baseSlug` is generated from `title.es`.
- The loop runs from 0 to `MAX_SLUG_RETRIES` inclusive (0 = base slug, 1..10 = suffixed).
- If all 11 attempts fail with P2002, throws `ProductSlugAlreadyExistsError`.
- Any non-P2002 error is re-thrown immediately (no retry).

Run tests — all should PASS. GREEN phase.

---

### Step 4 — Update api-spec.yaml

**File to modify:** `ai-specs/specs/api-spec.yaml`

The `CreateProductRequest` schema currently has `required: [productTypeId, title, description, price]` and does NOT include `slug` at all (consistent — the frontend never sent it). We need to add `slug` as an optional property so that when it IS provided, it is documented.

**Find this block (around line 3061):**

```yaml
    CreateProductRequest:
      type: object
      required: [productTypeId, title, description, price]
      properties:
        productTypeId:
          type: string
          format: uuid
        title:
          $ref: '#/components/schemas/LocalizedString'
        description:
          $ref: '#/components/schemas/LocalizedString'
        price:
          type: number
          minimum: 0
        compareAtPrice:
          type: number
```

**Replace with:**

```yaml
    CreateProductRequest:
      type: object
      required: [productTypeId, title, description, price, color]
      properties:
        productTypeId:
          type: string
          format: uuid
        title:
          $ref: '#/components/schemas/LocalizedString'
        description:
          $ref: '#/components/schemas/LocalizedString'
        slug:
          type: string
          description: URL slug. If omitted, auto-generated from title.es.
        price:
          type: number
          minimum: 0
        compareAtPrice:
          type: number
```

Notes:
- `slug` is added as an optional property (not in `required`).
- `color` is added to `required` because the backend currently requires it (the spec was missing this).
- Do not change anything else in this schema.

#### 4a. Regenerate frontend types

After saving api-spec.yaml, run:

```bash
cd /Users/pb/Developer/FiveGuays/memes/frontend && npm run generate:api
```

This regenerates `frontend/lib/api/types.ts`. The `CreateProductRequest` type will now have `slug?: string` instead of no slug field. The `ProductForm` component already does not send a slug, so no frontend code changes are needed.

---

### Step 5 — Verify everything passes

Run the full backend test suite:

```bash
cd /Users/pb/Developer/FiveGuays/memes/backend && npm test
```

Specific test files to confirm:
- `backend/src/utils/slugify.test.ts` — all new tests pass
- `backend/src/application/validators/productValidator.test.ts` — updated slug tests pass, all others unchanged
- `backend/src/application/services/productService.test.ts` — new collision tests pass, existing tests updated for auto-generated slug

Then verify the build:

```bash
cd /Users/pb/Developer/FiveGuays/memes/backend && npm run build
cd /Users/pb/Developer/FiveGuays/memes/frontend && npm run build
```

---

### Existing tests that need updates (not deletions)

The following existing tests use `validInput` with an explicit `slug: 'camiseta-premium'`. After removing slug from `validInput`, these tests must be reviewed:

- `'should create product with valid input'` — update assertion to expect `slug: 'camiseta-premium'` (auto-generated from `'Camiseta Premium'`) — same value, different source
- `'should apply default values for optional fields'` — no slug assertion, no change needed
- `'should create product with all optional fields provided'` — uses `...validInput` spread, no slug, auto-generation applies — no change needed
- `'should throw ProductSlugAlreadyExistsError when slug unique constraint violated'` — this test used to test a single P2002 throw; with retry logic, a single mock rejection now triggers a retry. The test must be updated to mock P2002 for all 11 attempts (use `.mockRejectedValue` without `Once` — it always rejects, causing all retries to fail and ultimately throwing `ProductSlugAlreadyExistsError`).

The test at line 146 currently reads:
```typescript
it('should throw ProductSlugAlreadyExistsError when slug unique constraint violated', async () => {
  (mockPrisma.product.create as jest.Mock).mockRejectedValue(
    new Prisma.PrismaClientKnownRequestError('Unique constraint failed', {
      code: 'P2002',
      clientVersion: '6.0.0',
    })
  );

  await expect(createProduct(validInput)).rejects.toThrow(ProductSlugAlreadyExistsError);
});
```

This test will STILL PASS as-is because `mockRejectedValue` (without `Once`) rejects every call, exhausting all 11 retry attempts and throwing `ProductSlugAlreadyExistsError`. No modification needed.

The validator test at line 244-255 `'should throw InvalidProductDataError when slug is missing'` MUST be replaced (as described in Step 2a).

---

### File Change Summary

| File | Action | What changes |
|------|--------|-------------|
| `backend/src/utils/slugify.ts` | CREATE | New `generateSlug(text: string): string` utility |
| `backend/src/utils/slugify.test.ts` | CREATE | 9 unit tests for slugify |
| `backend/src/application/validators/productValidator.ts` | MODIFY | `slug: string` → `slug?: string` in both interfaces; conditional slug validation in `validateCreateProductInput` |
| `backend/src/application/validators/productValidator.test.ts` | MODIFY | Replace "slug is required" test with "slug is optional" test; add "omitted slug returns undefined" test |
| `backend/src/application/services/productService.ts` | MODIFY | Import `generateSlug`; replace `createProduct` body with retry loop |
| `backend/src/application/services/productService.test.ts` | MODIFY | Remove `slug` from `validInput`; update expected `create` call; add collision retry tests |
| `ai-specs/specs/api-spec.yaml` | MODIFY | Add optional `slug` property to `CreateProductRequest`; add `color` to required list |
| `frontend/lib/api/types.ts` | REGENERATE | Run `npm run generate:api` — do not edit manually |

**No changes needed in:**
- `productController.ts` — passes `req.body` as-is; slug (or its absence) flows through naturally
- `shared.ts` — `validateSlug` already supports `required: false`; no changes needed
- Any route files — no routing changes required

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards (DDD layers, backend-standards.mdc)
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-17*
