# B1.2: Implement Auth Service (Register, Login, Logout)

**Sprint:** 1
**Type:** Backend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-B1.2-auth-service
**Created:** 2026-02-05
**Dependencies:** B1.1 (User model) - Completed

---

## Description

Implement the core authentication service layer following DDD layered architecture. This service will handle user registration, login (with password verification), and logout functionality. The service will use bcrypt for password hashing and prepare the foundation for JWT token handling (which will be implemented in B1.3).

Key features:
- User registration with email uniqueness validation
- Login with email/password verification
- Logout with refresh token invalidation
- Password hashing using bcrypt
- Single session design (per ADR-001)

---

## Acceptance Criteria

- [x] `register` function creates a new user with hashed password
- [x] `register` validates email format and uniqueness
- [x] `register` returns user data without password hash
- [x] `login` function validates credentials against stored hash
- [x] `login` updates `lastLoginAt` timestamp on success
- [x] `login` throws appropriate error for invalid credentials
- [x] `login` throws error for inactive/deleted users
- [x] `logout` function clears `refreshTokenHash` for the user
- [x] All functions have proper TypeScript types
- [x] Unit tests cover happy path and error scenarios
- [x] Unit tests achieve 90% coverage for new code
- [x] All tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/application/services/authService.ts` | Auth service with register, login, logout functions |
| `backend/src/application/services/authService.test.ts` | Unit tests for auth service |
| `backend/src/domain/errors/AuthError.ts` | Domain-specific auth errors |
| `backend/src/application/validators/authValidator.ts` | Input validation for auth operations |
| `backend/src/application/validators/authValidator.test.ts` | Tests for auth validators |
| `backend/package.json` | Add bcrypt dependency |

---

## Implementation Steps

### Step 1: Install Dependencies

1. Install bcrypt and its types:
   ```bash
   cd backend && npm install bcrypt && npm install -D @types/bcrypt
   ```

### Step 2: Create Domain Errors

Create `backend/src/domain/errors/AuthError.ts`:

1. Create base `AuthError` class extending `Error`
2. Create specific error classes:
   - `InvalidCredentialsError` - wrong email/password
   - `EmailAlreadyExistsError` - duplicate registration
   - `UserNotActiveError` - account disabled or deleted
   - `UserNotFoundError` - user doesn't exist

Example structure:
```typescript
export class AuthError extends Error {
  constructor(message: string, public code: string) {
    super(message);
    this.name = 'AuthError';
  }
}

export class InvalidCredentialsError extends AuthError {
  constructor() {
    super('Invalid email or password', 'INVALID_CREDENTIALS');
  }
}
// ... other error classes
```

### Step 3: Create Auth Validators

Create `backend/src/application/validators/authValidator.ts`:

1. `validateRegisterInput(data)` - validates registration data:
   - `email`: required, valid email format
   - `password`: required, minimum 8 characters
   - `firstName`: optional, max 100 chars
   - `lastName`: optional, max 100 chars

2. `validateLoginInput(data)` - validates login data:
   - `email`: required, valid email format
   - `password`: required

Return validated/sanitized data or throw validation error.

### Step 4: Write Auth Service Tests (TDD - Red Phase)

Create `backend/src/application/services/authService.test.ts`:

**Test categories:**

1. **register tests:**
   - should create user with hashed password when valid data provided
   - should throw EmailAlreadyExistsError when email exists
   - should return user without passwordHash field
   - should set default role to TARGET
   - should validate email format

2. **login tests:**
   - should return user when credentials are valid
   - should update lastLoginAt on successful login
   - should throw InvalidCredentialsError when email not found
   - should throw InvalidCredentialsError when password is wrong
   - should throw UserNotActiveError when user is inactive
   - should throw UserNotActiveError when user is soft-deleted

3. **logout tests:**
   - should clear refreshTokenHash for the user
   - should throw UserNotFoundError when user doesn't exist

**Mock requirements:**
- Mock Prisma client (`prisma.user.findUnique`, `prisma.user.create`, `prisma.user.update`)
- Mock bcrypt (`hash`, `compare`)

### Step 5: Implement Auth Service (TDD - Green Phase)

Create `backend/src/application/services/authService.ts`:

```typescript
// Types
export interface RegisterInput {
  email: string;
  password: string;
  firstName?: string;
  lastName?: string;
}

export interface LoginInput {
  email: string;
  password: string;
}

export interface AuthUser {
  id: string;
  email: string;
  firstName: string | null;
  lastName: string | null;
  role: UserRole;
  isActive: boolean;
  emailVerifiedAt: Date | null;
  lastLoginAt: Date | null;
  createdAt: Date;
}

// Functions
export async function register(input: RegisterInput): Promise<AuthUser>
export async function login(input: LoginInput): Promise<AuthUser>
export async function logout(userId: string): Promise<void>
```

**Implementation details:**

1. **register:**
   - Validate input using `validateRegisterInput`
   - Check email uniqueness with `prisma.user.findUnique`
   - Hash password with `bcrypt.hash` (salt rounds: 12)
   - Create user with `prisma.user.create`
   - Return user without `passwordHash`

2. **login:**
   - Validate input using `validateLoginInput`
   - Find user by email (include soft-deleted check)
   - Verify password with `bcrypt.compare`
   - Check `isActive` and `deletedAt`
   - Update `lastLoginAt` timestamp
   - Return user without `passwordHash`

3. **logout:**
   - Update user to set `refreshTokenHash = null`
   - If user not found, throw `UserNotFoundError`

### Step 6: Refactor (TDD - Refactor Phase)

1. Extract common user transformation to helper function:
   ```typescript
   function toAuthUser(user: User): AuthUser
   ```
2. Ensure consistent error handling
3. Add JSDoc comments for public functions

### Step 7: Write Validator Tests

Create `backend/src/application/validators/authValidator.test.ts`:

1. Test valid inputs pass validation
2. Test missing required fields throw error
3. Test invalid email format throws error
4. Test password length validation
5. Test field length limits

---

## Technical Notes

### Password Hashing
- Use bcrypt with 12 salt rounds (good balance of security/performance)
- Never log or return password hashes
- Use constant-time comparison (bcrypt.compare handles this)

### Error Handling
- Use domain-specific errors for auth failures
- Don't reveal whether email exists in login errors (security)
- Both "email not found" and "wrong password" should return same `InvalidCredentialsError`

### Security Considerations
- Validate email format to prevent injection
- Trim and normalize email (lowercase)
- No timing attacks on password verification (bcrypt handles this)

### DDD Layer Compliance
- Service functions are in Application layer
- Domain errors are in Domain layer
- Prisma access is from Application layer (simplified DDD for MVP)
- No HTTP concerns in service layer

### Single Session Design (ADR-001)
- `refreshTokenHash` in User table stores single refresh token
- Logout clears this token, invalidating the session
- New login will issue new token (old sessions invalidated)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Test coverage >= 90% for new files (100% achieved)
- [x] Code follows project standards (DDD layers, TypeScript)
- [x] No linting errors
- [x] Build succeeds
- [x] Dependencies installed (bcrypt, @types/bcrypt)

---

*Ticket created: 2026-02-05*
