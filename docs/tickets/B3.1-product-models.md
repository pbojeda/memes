# B3.1: Create Product, ProductImage, ProductReview models

**Sprint:** 3
**Type:** Backend - Model
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint3-B3.1-product-models
**Created:** 2026-02-11
**Dependencies:** B2.1 (ProductType model) — completed

---

## Description

Add the `Product`, `ProductImage`, and `ProductReview` models to the Prisma schema and create the database migration. This is the foundation for Sprint 3's product management feature.

Key additions:
- **Product**: Catalog items with localized title/description, pricing, sizes, Printful refs, meme metadata, soft delete (20+ fields)
- **ProductImage**: Product photos/mockups with CDN URLs, primary flag, sort order
- **ProductReview**: Reviews with star ratings, AI-generated flag, visibility toggle
- **Relations**: ProductType → Product[] (fulfills ADR-002), User → Product[] (createdBy), Product → ProductImage[], Product → ProductReview[]

The schema is fully defined in `ai-specs/specs/data-model.md` (sections 3.4, 3.5, 3.6).

**Note:** PriceHistory model is a separate task (B3.2).

---

## Acceptance Criteria

- [x] Product model added to `backend/prisma/schema.prisma` matching data-model.md §3.4
- [x] ProductImage model added matching data-model.md §3.5
- [x] ProductReview model added matching data-model.md §3.6
- [x] ProductType → Product[] relation added (fulfills ADR-002)
- [x] User → Product[] relation added (createdBy / "ProductCreator")
- [x] All indexes defined per data-model.md
- [x] Migration created and applied successfully (`20260211141713_add_product_models`)
- [x] Prisma Client regenerated with new types available
- [x] Domain error classes created for Product domain
- [x] Domain error classes created for ProductImage domain
- [x] Domain error classes created for ProductReview domain
- [x] Unit tests for all domain errors (13 tests)
- [x] All existing tests still pass (416 total)
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/prisma/schema.prisma` | Add Product, ProductImage, ProductReview models + relations |
| `backend/src/domain/errors/ProductError.ts` | Domain errors for product operations |
| `backend/src/domain/errors/ProductError.test.ts` | Tests for product domain errors |
| `backend/src/domain/errors/ProductImageError.ts` | Domain errors for product image operations |
| `backend/src/domain/errors/ProductImageError.test.ts` | Tests for product image domain errors |
| `backend/src/domain/errors/ProductReviewError.ts` | Domain errors for product review operations |
| `backend/src/domain/errors/ProductReviewError.test.ts` | Tests for product review domain errors |

---

## Implementation Steps

### Step 1: Update Prisma schema

Add to `backend/prisma/schema.prisma`:

**Product model** (from data-model.md §3.4):
- 20+ fields: id, productTypeId, title (Json), description (Json), slug, price, compareAtPrice, availableSizes (Json), color, isActive, isHot, printfulProductId, printfulSyncVariantId, memeSourceUrl, memeIsOriginal, salesCount, viewCount, createdByUserId, createdAt, updatedAt, deletedAt
- Relations: productType, createdBy (User), images (ProductImage[]), reviews (ProductReview[])
- Indexes: slug, productTypeId, isActive, isHot, createdAt, salesCount
- Soft delete via `deletedAt`

**ProductImage model** (from data-model.md §3.5):
- Fields: id, productId, url, altText (Json), isPrimary, sortOrder, createdAt
- Relation: product (cascade delete)
- Index: productId

**ProductReview model** (from data-model.md §3.6):
- Fields: id, productId, authorName, rating (SmallInt, 1-5), comment, isAiGenerated, isVisible, createdAt
- Relation: product (cascade delete)
- Indexes: productId, isVisible

**Update existing models:**
- ProductType: Replace ADR-002 comment with `products Product[]` relation
- User: Add `createdProducts Product[] @relation("ProductCreator")` relation

### Step 2: Create and apply migration

```bash
cd backend && npx prisma migrate dev --name add_product_models
```

### Step 3: Verify Prisma Client generation

Confirm generated types include Product, ProductImage, ProductReview.

### Step 4: Create domain error classes

**ProductError.ts** (following ProductTypeError pattern):
- `ProductError` (base, extends Error, with `code`)
- `ProductNotFoundError` (code: `PRODUCT_NOT_FOUND`)
- `ProductSlugAlreadyExistsError` (code: `PRODUCT_SLUG_ALREADY_EXISTS`)
- `InvalidProductDataError` (code: `INVALID_PRODUCT_DATA`, optional `field`)

**ProductImageError.ts**:
- `ProductImageError` (base)
- `ProductImageNotFoundError` (code: `PRODUCT_IMAGE_NOT_FOUND`)
- `InvalidProductImageDataError` (code: `INVALID_PRODUCT_IMAGE_DATA`, optional `field`)

**ProductReviewError.ts**:
- `ProductReviewError` (base)
- `ProductReviewNotFoundError` (code: `PRODUCT_REVIEW_NOT_FOUND`)
- `InvalidProductReviewDataError` (code: `INVALID_PRODUCT_REVIEW_DATA`, optional `field`)

### Step 5: Write tests for domain errors (TDD)

For each error file, test:
- Base error: message, code, name, instanceof Error
- Each subclass: default message, code, name, instanceof base, instanceof Error
- InvalidData variants: optional field parameter

---

## Technical Notes

- **Schema source of truth**: `ai-specs/specs/data-model.md` sections 3.4, 3.5, 3.6
- **ADR-002 fulfillment**: The ProductType → Product relation deferred from Sprint 2 is added here
- **ADR-003**: Localized fields (title, description, altText) use JSON `{es: "...", en: "..."}` — frontend uses `es` key for MVP
- **Soft delete**: Product uses `deletedAt` (like User); ProductImage and ProductReview do NOT have soft delete (cascade delete with parent)
- **Pattern to follow**: Existing `ProductTypeError.ts` domain error pattern
- **PriceHistory excluded**: Separate task (B3.2), will add `priceHistory PriceHistory[]` relation to Product later
- **OrderItem excluded**: Will be added in Sprint 5 when Order model is created

---

## Implementation Plan

### Execution Order

1. **Modify schema** — Update `backend/prisma/schema.prisma`: add Product, ProductImage, ProductReview models + relations to User and ProductType
2. **Run migration** — `cd backend && npx prisma migrate dev --name add_product_models`
3. **Write error tests (RED)** — Create test files for ProductError, ProductImageError, ProductReviewError
4. **Run tests to confirm RED** — `cd backend && npm test -- --testPathPatterns="ProductError|ProductImageError|ProductReviewError"`
5. **Implement error classes (GREEN)** — Create ProductError.ts, ProductImageError.ts, ProductReviewError.ts
6. **Run error tests (GREEN)** — 13 tests across 3 suites should pass
7. **Run full test suite** — `cd backend && npm test`
8. **Lint + build** — `cd backend && npm run lint && npm run build`
9. **Update ticket** — Mark acceptance criteria as `[x]`

### Schema Changes

**User model** — Add relation: `createdProducts Product[] @relation("ProductCreator")`

**ProductType model** — Replace ADR-002 comment with: `products Product[]`

**Product model** — 20+ fields matching data-model.md §3.4:
- id, productTypeId, title (Json), description (Json), slug (unique), price (Decimal 10,2), compareAtPrice, availableSizes (Json), color, isActive, isHot, printfulProductId, printfulSyncVariantId, memeSourceUrl, memeIsOriginal, salesCount, viewCount, createdByUserId, createdAt, updatedAt, deletedAt
- Relations: productType (ProductType), createdBy (User, "ProductCreator"), images (ProductImage[]), reviews (ProductReview[])
- Deferred relations: priceHistory (B3.2), orderItems (Sprint 5)
- Indexes: slug, productTypeId, isActive, isHot, createdAt, salesCount

**ProductImage model** — matching data-model.md §3.5:
- id, productId, url, altText (Json), isPrimary, sortOrder, createdAt
- Relation: product (cascade delete)
- Index: productId

**ProductReview model** — matching data-model.md §3.6:
- id, productId, authorName, rating (SmallInt), comment, isAiGenerated, isVisible, createdAt
- Relation: product (cascade delete)
- Indexes: productId, isVisible

### Domain Error Classes (13 tests total)

**ProductError.ts** (5 tests): ProductError (base), ProductNotFoundError, ProductSlugAlreadyExistsError, InvalidProductDataError (with optional field)

**ProductImageError.ts** (4 tests): ProductImageError (base), ProductImageNotFoundError, InvalidProductImageDataError (with optional field)

**ProductReviewError.ts** (4 tests): ProductReviewError (base), ProductReviewNotFoundError, InvalidProductReviewDataError (with optional field)

### Key Design Decisions

- Cascade deletes on ProductImage/ProductReview (child entities)
- No cascade on Product→User (deleting user should not delete their products)
- No cascade on Product→ProductType (Prisma default `Restrict` — must delete products first)
- Deferred relations documented with comments (same pattern as ADR-002)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (13 new, 416 total)
- [x] No linting errors
- [x] Build succeeds
- [x] Existing tests unaffected

---

*Ticket created: 2026-02-11*
