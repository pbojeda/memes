# B4.1: Create Address model and migration

**Sprint:** 4
**Type:** Backend - Model
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint4-B4.1-address-model
**Created:** 2026-02-18
**Dependencies:** B1.1 (User model) — completed

---

## Description

Add the `Address` model to `backend/prisma/schema.prisma` and create the database migration. The Address model stores saved shipping addresses for registered users, enabling address reuse during checkout (Sprint 4–5).

The schema is fully defined in `ai-specs/specs/data-model.md` section 3.2.

Key fields: id (UUID PK), userId (FK → User), label, firstName, lastName, streetLine1, streetLine2, city, state, postalCode, countryCode (ISO 3166-1 alpha-2), phone, isDefault, createdAt, updatedAt.

Relations: User → Address[] (add `addresses Address[]` to User model). Use `onDelete: Cascade`.

---

## Acceptance Criteria

- [x] Address model added to `backend/prisma/schema.prisma` matching data-model.md §3.2
- [x] User → Address[] relation added to User model
- [x] Index defined on `userId` per data-model.md
- [x] `onDelete: Cascade` on User relation
- [x] Migration created and applied successfully
- [x] Prisma Client regenerated with new Address type available
- [x] Domain error classes created: AddressError (base), AddressNotFoundError, AddressLimitExceededError, DefaultAddressCannotBeDeletedError
- [x] Unit tests for all domain errors
- [x] All existing tests still pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/prisma/schema.prisma` | Add Address model + User → Address[] relation |
| `backend/prisma/migrations/[timestamp]_add_address_model/migration.sql` | Auto-generated migration |
| `backend/src/domain/errors/AddressError.ts` | Address domain error classes |
| `backend/src/domain/errors/AddressError.test.ts` | Domain error tests |

---

## Technical Notes

- Follow the same pattern as `ProductError.ts` for domain errors: base class with `code` property, specific subclasses
- `countryCode` is VARCHAR(2) — ISO 3166-1 alpha-2 (e.g., "ES", "FR", "DE")
- `isDefault` defaults to `false` — business logic for toggling defaults is in B4.2
- The User model currently has `createdProducts` and `priceChanges` relations — add `addresses Address[]`
- No API endpoints in this task — those come in B4.2
- Domain errors:
  - `AddressError` (base, extends Error, with `code`)
  - `AddressNotFoundError` (code: `ADDRESS_NOT_FOUND`)
  - `AddressLimitExceededError` (code: `ADDRESS_LIMIT_EXCEEDED`)
  - `DefaultAddressCannotBeDeletedError` (code: `DEFAULT_ADDRESS_CANNOT_BE_DELETED`)

---

## Implementation Plan

### Step 1: Add Address model to Prisma schema

Modify `backend/prisma/schema.prisma`:

**1a. Add the Address model** (after User model, before ProductType):

```prisma
model Address {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  label       String?  @db.VarChar(50)
  firstName   String   @map("first_name") @db.VarChar(100)
  lastName    String   @map("last_name") @db.VarChar(100)
  streetLine1 String   @map("street_line_1") @db.VarChar(255)
  streetLine2 String?  @map("street_line_2") @db.VarChar(255)
  city        String   @db.VarChar(100)
  state       String?  @db.VarChar(100)
  postalCode  String   @map("postal_code") @db.VarChar(20)
  countryCode String   @map("country_code") @db.VarChar(2)
  phone       String?  @db.VarChar(20)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}
```

**1b. Add `addresses Address[]` to User model** relations block:

```prisma
  // Relations
  createdProducts Product[]      @relation("ProductCreator")
  priceChanges    PriceHistory[]
  addresses       Address[]
```

Notes:
- `@db.VarChar(N)` annotations match data-model.md §3.2 constraints. `countryCode` VARCHAR(2) is critical for ISO 3166-1 alpha-2 compliance. Consistent with `PriceHistory.reason` which already uses `@db.VarChar(255)`.
- `onDelete: Cascade` — deleting a User cascades to their addresses.

### Step 2: Create and apply migration

```bash
cd backend && npx prisma migrate dev --name add_address_model
```

Verify generated SQL contains: `CREATE TABLE "addresses"`, FK on `user_id` with `ON DELETE CASCADE`, index on `user_id`.

### Step 3: Create domain error tests (TDD — Red phase)

Create `backend/src/domain/errors/AddressError.test.ts` with tests for:
- `AddressError` base: message, code, name, instanceof Error
- `AddressNotFoundError`: message="Address not found", code="ADDRESS_NOT_FOUND"
- `AddressLimitExceededError`: message="Address limit exceeded", code="ADDRESS_LIMIT_EXCEEDED"
- `DefaultAddressCannotBeDeletedError`: message="Default address cannot be deleted", code="DEFAULT_ADDRESS_CANNOT_BE_DELETED"

All subclasses: instanceof AddressError, instanceof Error.

Run tests — confirm they **fail**.

### Step 4: Create domain error implementation (TDD — Green phase)

Create `backend/src/domain/errors/AddressError.ts` following `ProductError.ts` pattern:
- `AddressError` base class with `message` and `code`
- 3 specific subclasses with hardcoded messages and codes

Run tests — confirm they **pass**.

### Step 5: Verify all existing tests pass

```bash
cd backend && npm test
```

### Step 6: Verify lint and build

```bash
cd backend && npm run lint && npm run build
```

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards (DDD error patterns)
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-18*
