# B1.6: Create Auth Controller and Routes

**Sprint:** 1
**Type:** Backend - Controller
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-B1.6-auth-controller
**Created:** 2026-02-06
**Dependencies:** B1.2 (Auth service), B1.3 (Token service), B1.4 (Auth middleware) - All Completed

---

## Description

Create the authentication controller and routes to expose the auth API endpoints. This includes registration, login, logout, and token refresh endpoints. The controller will use the existing authService, tokenService, and authMiddleware.

**Endpoints:**
- `POST /api/auth/register` - User registration
- `POST /api/auth/login` - User login (returns tokens)
- `POST /api/auth/logout` - User logout (requires auth)
- `POST /api/auth/refresh` - Refresh access token

---

## Acceptance Criteria

- [x] `POST /api/auth/register` creates user and returns user data (no tokens)
- [x] `POST /api/auth/login` returns access token, refresh token, and user data
- [x] `POST /api/auth/logout` clears refresh token (requires authentication)
- [x] `POST /api/auth/refresh` returns new token pair
- [x] Validation errors return 400 with field-specific messages
- [x] Auth errors return 401 with appropriate error codes
- [x] All endpoints follow project response format
- [x] Routes registered at `/api/auth/*`
- [x] Unit tests cover happy path and error scenarios (21 tests)
- [x] Unit tests achieve 90% coverage for new code (100%)
- [x] All tests pass (147 total)
- [x] Build succeeds
- [x] Lint passes
- [x] Production validator issues fixed (defensive checks, input validation)

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/presentation/controllers/authController.ts` | Auth request handlers |
| `backend/src/presentation/controllers/authController.test.ts` | Controller unit tests |
| `backend/src/routes/authRoutes.ts` | Auth route definitions |
| `backend/src/routes/index.ts` | Register auth routes |

---

## Implementation Steps

### Step 1: Write Auth Controller Tests (TDD - Red Phase)

Create `backend/src/presentation/controllers/authController.test.ts`:

**Test categories:**

1. **register tests:**
   - should return 201 with user data on successful registration
   - should return 400 when validation fails (missing email)
   - should return 400 when validation fails (weak password)
   - should return 409 when email already exists
   - should call next(error) for unexpected errors

2. **login tests:**
   - should return 200 with tokens and user data on successful login
   - should return 400 when validation fails
   - should return 401 when credentials are invalid
   - should return 401 when user is not active
   - should call next(error) for unexpected errors

3. **logout tests:**
   - should return 200 on successful logout
   - should use userId from req.user (from authMiddleware)
   - should return 404 when user not found
   - should call next(error) for unexpected errors

4. **refresh tests:**
   - should return 200 with new tokens on successful refresh
   - should return 400 when refresh token missing in body
   - should return 401 when refresh token is invalid
   - should call next(error) for unexpected errors

### Step 2: Implement Auth Controller (TDD - Green Phase)

Create `backend/src/presentation/controllers/authController.ts`:

```typescript
import { Request, Response, NextFunction } from 'express';
import * as authService from '../../application/services/authService';
import * as tokenService from '../../application/services/tokenService';
import { validateRegisterInput, validateLoginInput } from '../../application/validators/authValidator';
import {
  InvalidCredentialsError,
  EmailAlreadyExistsError,
  UserNotActiveError,
  UserNotFoundError,
  ValidationError,
  InvalidTokenError,
} from '../../domain/errors/AuthError';

export async function register(req: Request, res: Response, next: NextFunction): Promise<void>
export async function login(req: Request, res: Response, next: NextFunction): Promise<void>
export async function logout(req: Request, res: Response, next: NextFunction): Promise<void>
export async function refresh(req: Request, res: Response, next: NextFunction): Promise<void>
```

**Implementation details:**

1. **register:**
   - Validate input with validateRegisterInput()
   - Call authService.register()
   - Return 201 with user data (exclude passwordHash)
   - Catch ValidationError → 400
   - Catch EmailAlreadyExistsError → 409

2. **login:**
   - Validate input with validateLoginInput()
   - Call authService.login()
   - Generate access token with tokenService.generateAccessToken()
   - Generate refresh token with tokenService.generateRefreshToken()
   - Return 200 with { user, accessToken, refreshToken }
   - Catch ValidationError → 400
   - Catch InvalidCredentialsError → 401
   - Catch UserNotActiveError → 401

3. **logout:**
   - Get userId from req.user (set by authMiddleware)
   - Call authService.logout(userId)
   - Return 200 with success message
   - Catch UserNotFoundError → 404

4. **refresh:**
   - Get refreshToken from req.body
   - Get userId from req.body (client must send it)
   - Call tokenService.refreshTokens()
   - Return 200 with new token pair
   - Catch InvalidTokenError → 401

### Step 3: Create Auth Routes

Create `backend/src/routes/authRoutes.ts`:

```typescript
import { Router } from 'express';
import { register, login, logout, refresh } from '../presentation/controllers/authController';
import { authMiddleware } from '../middleware/authMiddleware';

const router = Router();

router.post('/register', register);
router.post('/login', login);
router.post('/logout', authMiddleware, logout);
router.post('/refresh', refresh);

export default router;
```

### Step 4: Register Routes

Update `backend/src/routes/index.ts`:

```typescript
import authRoutes from './authRoutes';

router.use('/auth', authRoutes);
```

### Step 5: Refactor

1. Ensure consistent error handling
2. Add JSDoc comments
3. Verify response format consistency

---

## API Specification

### POST /api/auth/register

**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "firstName": "John",
  "lastName": "Doe"
}
```

**Response (201):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "email": "user@example.com",
    "firstName": "John",
    "lastName": "Doe",
    "role": "TARGET",
    "isActive": true,
    "createdAt": "2026-02-06T..."
  }
}
```

### POST /api/auth/login

**Request:**
```json
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "user": { ... },
    "accessToken": "eyJ...",
    "refreshToken": "abc123..."
  }
}
```

### POST /api/auth/logout

**Headers:** `Authorization: Bearer <accessToken>`

**Response (200):**
```json
{
  "success": true,
  "data": {
    "message": "Logged out successfully"
  }
}
```

### POST /api/auth/refresh

**Request:**
```json
{
  "refreshToken": "abc123...",
  "userId": "uuid"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJ...",
    "refreshToken": "newtoken..."
  }
}
```

---

## Error Responses

| Scenario | Status | Code |
|----------|--------|------|
| Validation failed | 400 | VALIDATION_ERROR |
| Email already exists | 409 | EMAIL_ALREADY_EXISTS |
| Invalid credentials | 401 | INVALID_CREDENTIALS |
| User not active | 401 | USER_NOT_ACTIVE |
| Invalid token | 401 | INVALID_TOKEN |
| Token expired | 401 | TOKEN_EXPIRED |
| User not found | 404 | USER_NOT_FOUND |

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (21 new tests)
- [x] Test coverage >= 90% for new files (100%)
- [x] Code follows project standards (DDD layers, TypeScript)
- [x] No linting errors
- [x] Build succeeds
- [x] API matches specification above
- [x] Production validator issues addressed

---

*Ticket created: 2026-02-06*
