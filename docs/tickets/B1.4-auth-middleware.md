# B1.4: Create Auth Middleware

**Sprint:** 1
**Type:** Backend - Middleware
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-B1.4-auth-middleware
**Created:** 2026-02-06
**Dependencies:** B1.3 (JWT token service) - Completed

---

## Description

Create Express middleware for JWT authentication. The middleware will extract the Bearer token from the Authorization header, verify it using the token service, and attach the decoded user payload to the request object. This middleware is essential for protecting routes that require authentication.

Key features:
- Extract Bearer token from Authorization header
- Verify JWT using tokenService.verifyAccessToken()
- Attach decoded payload to req.user
- Return 401 for missing/invalid/expired tokens
- TypeScript support with extended Request interface

---

## Acceptance Criteria

- [x] Middleware extracts Bearer token from Authorization header
- [x] Middleware verifies token using verifyAccessToken()
- [x] Middleware attaches decoded payload to req.user
- [x] Returns 401 Unauthorized for missing Authorization header
- [x] Returns 401 Unauthorized for malformed Authorization header (not Bearer)
- [x] Returns 401 Unauthorized for invalid token (InvalidTokenError)
- [x] Returns 401 Unauthorized for expired token (TokenExpiredError)
- [x] Request interface is extended to include user property
- [x] All functions have proper TypeScript types
- [x] Unit tests cover happy path and error scenarios
- [x] Unit tests achieve 90% coverage for new code (95.83%)
- [x] All tests pass (126 tests)
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/middleware/authMiddleware.ts` | JWT authentication middleware |
| `backend/src/middleware/authMiddleware.test.ts` | Unit tests for auth middleware |
| `backend/src/types/express.d.ts` | Extend Express Request interface |

---

## Implementation Steps

### Step 1: Create Express Type Extension

Create `backend/src/types/express.d.ts`:

```typescript
import { TokenPayload } from '../application/services/tokenService';

declare global {
  namespace Express {
    interface Request {
      user?: TokenPayload;
    }
  }
}
```

Update `backend/tsconfig.json` to include the types directory if needed.

### Step 2: Write Auth Middleware Tests (TDD - Red Phase)

Create `backend/src/middleware/authMiddleware.test.ts`:

**Test categories:**

1. **Happy path tests:**
   - should call next() when valid token provided
   - should attach decoded payload to req.user
   - should extract token from Bearer authorization

2. **Missing token tests:**
   - should return 401 when Authorization header is missing
   - should return 401 when Authorization header is empty

3. **Malformed header tests:**
   - should return 401 when Authorization is not Bearer type
   - should return 401 when Bearer token is missing after "Bearer "

4. **Invalid token tests:**
   - should return 401 when token verification fails (InvalidTokenError)
   - should return 401 when token is expired (TokenExpiredError)

5. **Error propagation tests:**
   - should call next(error) for unexpected errors

### Step 3: Implement Auth Middleware (TDD - Green Phase)

Create `backend/src/middleware/authMiddleware.ts`:

```typescript
import { Request, Response, NextFunction } from 'express';
import { verifyAccessToken } from '../application/services/tokenService';
import { TokenExpiredError, InvalidTokenError } from '../domain/errors/AuthError';
import { UnauthorizedError } from './errorHandler';

/**
 * Express middleware for JWT authentication.
 * Extracts Bearer token from Authorization header and verifies it.
 * Attaches decoded payload to req.user on success.
 */
export function authMiddleware(
  req: Request,
  res: Response,
  next: NextFunction
): void {
  try {
    const authHeader = req.headers.authorization;

    if (!authHeader) {
      throw new UnauthorizedError('Authorization header is required');
    }

    const parts = authHeader.split(' ');

    if (parts.length !== 2 || parts[0] !== 'Bearer') {
      throw new UnauthorizedError('Invalid authorization format. Use: Bearer <token>');
    }

    const token = parts[1];

    if (!token) {
      throw new UnauthorizedError('Token is required');
    }

    const payload = verifyAccessToken(token);
    req.user = payload;

    next();
  } catch (error) {
    if (error instanceof TokenExpiredError) {
      next(new UnauthorizedError('Token has expired'));
    } else if (error instanceof InvalidTokenError) {
      next(new UnauthorizedError('Invalid token'));
    } else if (error instanceof UnauthorizedError) {
      next(error);
    } else {
      next(error);
    }
  }
}
```

### Step 4: Refactor

1. Ensure consistent error messages
2. Add JSDoc comments
3. Consider extracting token extraction logic if reusable

---

## Technical Notes

### Authorization Header Format

```
Authorization: Bearer <jwt_token>
```

### Request.user Structure

After successful authentication, `req.user` contains:

```typescript
interface TokenPayload {
  userId: string;
  email: string;
  role: UserRole;
}
```

### Error Handling

| Error Type | HTTP Status | Message |
|------------|-------------|---------|
| Missing header | 401 | Authorization header is required |
| Invalid format | 401 | Invalid authorization format |
| Invalid token | 401 | Invalid token |
| Expired token | 401 | Token has expired |

### Integration with Token Service

The middleware uses `verifyAccessToken()` from tokenService which:
- Validates JWT signature
- Checks token expiration
- Returns decoded payload with runtime validation (Zod)
- Throws `TokenExpiredError` or `InvalidTokenError` on failure

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (11 new tests)
- [x] Test coverage >= 90% for new files (95.83%)
- [x] Code follows project standards (DDD layers, TypeScript)
- [x] No linting errors
- [x] Build succeeds
- [x] Type extension properly configured
- [x] Production-code-validator approved

---

*Ticket created: 2026-02-06*
