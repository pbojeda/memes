# F1.5: Create Auth Service (API Calls)

**Sprint:** 1
**Type:** Frontend - Service
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-F1.5-auth-service
**Created:** 2026-02-09
**Dependencies:** F1.1 (authStore), F0.11 (OpenAPI types)

---

## Description

Create an auth service module that handles all authentication-related API calls. The service uses generated OpenAPI types for type safety and integrates with the Zustand authStore for state management.

**Endpoints to implement:**
- `POST /auth/register` - Register new user
- `POST /auth/login` - Login and get tokens
- `POST /auth/logout` - Logout (invalidate refresh token)
- `POST /auth/refresh` - Refresh access token
- `POST /auth/forgot-password` - Request password reset
- `POST /auth/reset-password` - Reset password with token

---

## Acceptance Criteria

- [x] Auth service created at `frontend/lib/services/authService.ts`
- [x] All 6 auth endpoints implemented with proper types
- [x] Uses generated types from `lib/api/types.ts`
- [x] Integrates with authStore (setAuth, clearAuth, setTokens)
- [x] Proper error handling with ApiException
- [x] Unit tests for all service functions
- [x] All tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `frontend/lib/services/authService.ts` | Create | Auth API service |
| `frontend/lib/services/authService.test.ts` | Create | Service unit tests |
| `frontend/lib/services/index.ts` | Create | Service exports |

---

## Implementation Steps

### Step 1: Create Service Directory Structure

Create `frontend/lib/services/` directory.

### Step 2: Define Service Interface (TDD - Write Tests First)

Create `authService.test.ts` with test cases for:

**Login:**
- Should call login endpoint with credentials
- Should update authStore on success
- Should throw ApiException on invalid credentials

**Register:**
- Should call register endpoint with user data
- Should return user data (no tokens)
- Should throw ApiException on duplicate email

**Logout:**
- Should call logout endpoint with auth header
- Should clear authStore on success

**Refresh:**
- Should call refresh endpoint with refresh token
- Should update tokens in authStore on success
- Should clear auth and throw on invalid refresh token

**Forgot Password:**
- Should call forgot-password endpoint
- Should return success message

**Reset Password:**
- Should call reset-password endpoint with token and new password
- Should return success message

### Step 3: Implement Auth Service

```typescript
// frontend/lib/services/authService.ts
import { apiClient } from '../api/client';
import { ApiException } from '../api/exceptions';
import type { components } from '../api/types';
import { useAuthStore } from '../../stores/authStore';

// Types from OpenAPI
type LoginRequest = components['schemas']['LoginRequest'];
type RegisterRequest = components['schemas']['RegisterRequest'];
type AuthResponse = components['schemas']['AuthResponse'];
type RegisterResponse = components['schemas']['RegisterResponse'];
type RefreshRequest = components['schemas']['RefreshRequest'];
type RefreshResponse = components['schemas']['RefreshResponse'];
type ForgotPasswordRequest = components['schemas']['ForgotPasswordRequest'];
type ResetPasswordRequest = components['schemas']['ResetPasswordRequest'];
type MessageResponse = components['schemas']['MessageResponse'];

export const authService = {
  async login(credentials: LoginRequest): Promise<void> {
    const { setAuth, setLoading, setError } = useAuthStore.getState();
    setLoading(true);
    try {
      const response = await apiClient.post<AuthResponse>('/auth/login', credentials);
      const { user, accessToken, refreshToken } = response.data.data!;
      setAuth(user!, { accessToken: accessToken!, refreshToken: refreshToken! });
    } catch (error) {
      if (error instanceof ApiException) {
        setError(error.message);
      }
      throw error;
    }
  },

  async register(data: RegisterRequest): Promise<components['schemas']['AuthUser']> {
    const response = await apiClient.post<RegisterResponse>('/auth/register', data);
    return response.data.data!;
  },

  async logout(): Promise<void> {
    const { clearAuth } = useAuthStore.getState();
    try {
      await apiClient.post('/auth/logout');
    } finally {
      clearAuth();
    }
  },

  async refresh(): Promise<void> {
    const { refreshToken, setTokens, clearAuth } = useAuthStore.getState();
    if (!refreshToken) {
      clearAuth();
      throw new ApiException('NO_REFRESH_TOKEN', 'No refresh token available', 401);
    }
    try {
      const response = await apiClient.post<RefreshResponse>('/auth/refresh', {
        refreshToken,
      });
      const { accessToken, refreshToken: newRefreshToken } = response.data.data!;
      setTokens({ accessToken: accessToken!, refreshToken: newRefreshToken! });
    } catch (error) {
      clearAuth();
      throw error;
    }
  },

  async forgotPassword(email: string): Promise<string> {
    const response = await apiClient.post<MessageResponse>('/auth/forgot-password', { email });
    return response.data.message || 'Password reset email sent';
  },

  async resetPassword(token: string, newPassword: string): Promise<string> {
    const response = await apiClient.post<MessageResponse>('/auth/reset-password', {
      token,
      newPassword,
    });
    return response.data.message || 'Password reset successful';
  },
};
```

### Step 4: Create Index Export

```typescript
// frontend/lib/services/index.ts
export { authService } from './authService';
```

### Step 5: Run Tests and Verify

```bash
npm test -- authService
npm run lint
npm run build
```

---

## Type Mapping (OpenAPI â†’ Service)

| Endpoint | Request Type | Response Type |
|----------|--------------|---------------|
| POST /auth/login | `LoginRequest` | `AuthResponse` |
| POST /auth/register | `RegisterRequest` | `RegisterResponse` |
| POST /auth/logout | - | `MessageResponse` |
| POST /auth/refresh | `RefreshRequest` | `RefreshResponse` |
| POST /auth/forgot-password | `ForgotPasswordRequest` | `MessageResponse` |
| POST /auth/reset-password | `ResetPasswordRequest` | `MessageResponse` |

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Service functions properly typed
- [x] Unit tests cover success and error cases
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-09*
