# B3.6: Implement soft delete endpoints for products

**Sprint:** 3
**Type:** Backend - Feature
**Priority:** Medium
**Status:** In Progress
**Branch:** feature/sprint3-B3.6-soft-delete-endpoints
**Created:** 2026-02-12
**Dependencies:** B3.3 (completed), B3.5 (completed)

---

## Description

Expose the existing `softDeleteProduct` and `restoreProduct` service functions as REST endpoints. The service layer already handles the business logic (B3.3). This task adds:

1. **DELETE `/api/products/:id`** — Soft delete a product (staff only: MANAGER/ADMIN)
2. **POST `/api/products/:id/restore`** — Restore a soft-deleted product (staff only: MANAGER/ADMIN)

Both endpoints require authentication and MANAGER/ADMIN role authorization. The API spec already defines the DELETE endpoint at `/products/{productId}` returning 204 on success. The restore endpoint is not in the spec yet and must be added.

Additionally, verify that all existing public queries consistently exclude soft-deleted products (`deletedAt: null` filter).

---

## Acceptance Criteria

- [x] DELETE `/api/products/:id` endpoint calls `softDeleteProduct` service and returns 204
- [x] DELETE endpoint requires auth + MANAGER/ADMIN role
- [x] DELETE endpoint returns 400 for invalid UUID
- [x] DELETE endpoint returns 404 for non-existent or already-deleted product
- [x] POST `/api/products/:id/restore` endpoint calls `restoreProduct` service and returns 200 with product data
- [x] Restore endpoint requires auth + MANAGER/ADMIN role
- [x] Restore endpoint returns 400 for invalid UUID
- [x] Restore endpoint returns 404 for non-existent or non-deleted product
- [x] `api-spec.yaml` updated with restore endpoint
- [x] Controller tests cover happy path and error cases for both endpoints
- [x] All existing tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/presentation/controllers/productController.ts` | Add `deleteProduct` and `restoreProduct` controller functions |
| `backend/src/routes/productRoutes.ts` | Register DELETE `/:id` and POST `/:id/restore` routes with auth + role middleware |
| `backend/src/presentation/controllers/__tests__/productController.test.ts` | Controller tests for both endpoints |
| `ai-specs/specs/api-spec.yaml` | Add restore endpoint spec |

---

## Implementation Steps

### Step 1: Update API spec
1. Add `POST /products/{productId}/restore` endpoint to `api-spec.yaml`
2. Regenerate frontend types

### Step 2: Add controller functions
1. Add `deleteProduct` controller — validates `:id` param, calls `softDeleteProduct`, returns 204 via `noContent(res)`
2. Add `restoreProduct` controller — validates `:id` param, calls `restoreProduct`, returns 200 with product via `success(res, product)`
3. Reuse existing `handleProductError` for error mapping

### Step 3: Register routes
1. Import auth and role middleware
2. Add `DELETE /:id` route with `authenticate` + `requireRole(['MANAGER', 'ADMIN'])`
3. Add `POST /:id/restore` route with `authenticate` + `requireRole(['MANAGER', 'ADMIN'])`

### Step 4: Write controller tests
1. Test happy path for DELETE (204)
2. Test happy path for restore (200 with product)
3. Test invalid UUID → 400
4. Test not found → 404
5. Test already deleted → 404 for DELETE
6. Test not deleted → 404 for restore

---

## Technical Notes

- **Service layer**: `softDeleteProduct` and `restoreProduct` already exist in `productService.ts` (from B3.3)
- **Error handling**: Reuse `handleProductError` in `productController.ts` — maps `InvalidProductDataError` → 400, `ProductNotFoundError` → 404
- **Auth middleware**: Use `authenticate` from `authMiddleware.ts` + `requireRole` from `roleMiddleware.ts`
- **Response helpers**: Use `noContent(res)` for 204, `success(res, data)` for 200
- **Pattern**: Follow existing `getProductDetail` controller pattern

---

## Implementation Plan

### Step 1: Update API spec with restore endpoint

**File:** `ai-specs/specs/api-spec.yaml`

- Add `POST /products/{productId}/restore` endpoint (staff only, returns 200 with ProductResponse)
- Add `400` response to the existing `DELETE /products/{productId}` endpoint (for invalid UUID)
- Regenerate frontend types: `cd frontend && npm run generate:api`

### Step 2: Write controller tests (RED phase)

**File:** `backend/src/presentation/controllers/productController.test.ts`

Add 8 test cases across 2 new `describe` blocks:

**`describe('deleteProduct')`:**
1. Should return 204 when product is soft-deleted successfully
2. Should return 400 for invalid UUID (InvalidProductDataError)
3. Should return 404 when not found or already deleted (ProductNotFoundError)
4. Should call next(error) for unexpected errors

**`describe('restoreProduct')`:**
5. Should return 200 with restored product data
6. Should return 400 for invalid UUID (InvalidProductDataError)
7. Should return 404 when not found or not deleted (ProductNotFoundError)
8. Should call next(error) for unexpected errors

Tests should fail (RED) because functions don't exist yet.

### Step 3: Implement controller functions (GREEN phase)

**File:** `backend/src/presentation/controllers/productController.ts`

- Add `noContent` to import from `../../utils/responseHelpers`
- Add `deleteProduct` controller: extract `id` from `req.params.id`, call `softDeleteProduct(id)`, return `noContent(res)` (204)
- Add `restoreProduct` controller: extract `id` from `req.params.id`, call service `restoreProduct(id)`, return `success(res, product)` (200)
- Reuse existing `handleProductError` for error mapping (no changes needed)
- Pattern: follow existing `getProductDetail` and `deleteProductType` controller patterns

### Step 4: Register routes

**File:** `backend/src/routes/productRoutes.ts`

- Import `deleteProduct`, `restoreProduct` from controller
- Import `authMiddleware` from `../middleware/authMiddleware`
- Import `requireRole` from `../middleware/roleMiddleware`
- Add: `router.delete('/:id', authMiddleware, requireRole([...]), deleteProduct)`
- Add: `router.post('/:id/restore', authMiddleware, requireRole([...]), restoreProduct)`
- Roles: MANAGER, ADMIN

### Step 5: Run full validation

- All controller tests pass
- All backend tests pass (`npm test`)
- Lint passes (`npm run lint`)
- Build succeeds (`npm run build`)

### Summary of file changes

| File | Action | Details |
|------|--------|---------|
| `ai-specs/specs/api-spec.yaml` | Modify | Add restore endpoint; add 400 to delete |
| `backend/src/presentation/controllers/productController.ts` | Modify | Add `deleteProduct`, `restoreProduct` functions |
| `backend/src/presentation/controllers/productController.test.ts` | Modify | Add 8 test cases |
| `backend/src/routes/productRoutes.ts` | Modify | Register DELETE and POST routes with auth |
| `frontend/lib/api/types.ts` | Auto-generated | Regenerated from api-spec.yaml |

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code follows project standards
- [ ] No linting errors
- [ ] Build succeeds

---

*Ticket created: 2026-02-12*
