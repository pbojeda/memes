# F3.15: Fix admin product form bugs (object Object, upload, create-mode UX)

**Sprint:** 3
**Type:** Frontend - Bugfix
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint3-F3.15-admin-form-bugs
**Created:** 2026-02-17
**Dependencies:** F3.9, F3.14 (both completed)

---

## Description

Three bugs were found during manual testing of the admin product creation and editing flow (`/admin/products/new` and `/admin/products/[productId]/edit`):

**Bug A — [object Object] in title/description fields:**
After creating a product and being redirected to the edit page, the title and description input fields display `[object Object]` instead of the actual text. The backend returns `title`/`description` as JSONB `{es: "...", en: "..."}`, but `getInitialFormState()` assigns the object directly to `titleEs`/`descriptionEs` string fields.

**Bug B — "No file provided" error on image upload:**
Selecting a file and clicking "Upload File" fails with "No file provided". The axios client has a default `Content-Type: application/json` header that overrides FormData auto-detection. Multer receives the wrong content type, skips parsing, and `req.file` is `undefined`.

**Bug C — No guidance for images on create form:**
On the create page, the ProductImageManager is hidden (requires `productId`), but there's no message explaining that images can be added after creation. The user sees no image section and is confused.

---

## Acceptance Criteria

- [x] **Bug A**: Product edit form correctly populates title (es/en) and description (es/en) from the localized JSONB object
- [x] **Bug A**: Form pre-fills both Spanish and English fields when both values exist
- [x] **Bug B**: File upload via ProductImageManager successfully sends multipart/form-data to the backend
- [x] **Bug B**: The fix is global (applies to all FormData requests through apiClient, not just this endpoint)
- [x] **Bug C**: Create form shows an informational message in the images section indicating images can be added after creation
- [x] Unit tests for Bug A (getInitialFormState with localized objects — 3 tests + 5 utility tests)
- [x] Unit tests for Bug B (axios interceptor strips Content-Type for FormData — 2 tests)
- [x] Unit tests for Bug C (create mode shows guidance message — 2 tests)
- [x] All existing tests pass (603 total, +11 new)
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `frontend/components/admin/products/ProductForm.tsx` | Bug A: Fix `getInitialFormState()` to extract es/en from localized objects. Bug C: Add image guidance message in create mode |
| `frontend/components/admin/products/ProductForm.test.tsx` | Tests for Bug A and Bug C |
| `frontend/lib/api/client.ts` | Bug B: Add interceptor logic to remove Content-Type for FormData requests |
| `frontend/lib/api/client.test.ts` | Tests for Bug B (interceptor behavior) |

---

## Implementation Steps

See Implementation Plan below.

---

## Technical Notes

- `product.title` and `product.description` are typed as `string` in the generated API types (`Product` schema), but the backend actually returns the raw Prisma JSONB object `{es: "...", en: "..."}` for admin endpoints. The type mismatch is at the API spec level — the spec describes the public response (localized string), not the admin response (raw object).
- The existing `getLocalizedName()` utility in `frontend/lib/utils.ts` returns the *first* value from a localized object. For the edit form we need a *locale-specific* extractor since there are separate fields for `es` and `en`. New utility: `getLocalizedField(value, locale, fallback)`.
- For Bug B, the axios request interceptor already exists (for auth token injection). The FormData detection should be added there.
- The backend multer config uses `upload.single('file')` and the FormData field name is already `'file'` — the only issue is Content-Type.
- For Bug C, follow the existing pattern of conditional rendering in ProductForm (see the `{isEditMode && ...}` block for the image manager).

---

## Implementation Plan

### Execution Order (TDD)

1. Bug A, Step A1: Create `utils.test.ts` with `getLocalizedField` tests → RED
2. Bug A, Step A1: Add `getLocalizedField()` to `utils.ts` → GREEN
3. Bug A, Step A2: Add localized-object tests to `ProductForm.test.tsx` → RED
4. Bug A, Step A3: Fix `getInitialFormState()` in `ProductForm.tsx` → GREEN
5. Bug A, Step A4: Run all ProductForm tests → verify all pass
6. Bug B, Step B1: Add FormData interceptor tests to `client.test.ts` → RED
7. Bug B, Step B2: Add FormData detection to request interceptor in `client.ts` → GREEN
8. Bug B, Step B3: Run all client tests → verify all pass
9. Bug C, Step C1: Add create-mode guidance tests to `ProductForm.test.tsx` → RED
10. Bug C, Step C2: Add Alert message in `ProductForm.tsx` → GREEN
11. Bug C, Step C3: Run all ProductForm tests → verify all pass
12. Final: Run full test suite, lint, build

---

### Bug A — [object Object] in title/description fields

#### Step A1: Add `getLocalizedField` utility (with tests)

**File:** `frontend/lib/utils.test.ts` (NEW)

```
describe('getLocalizedField', () => {
  it('returns the value for the requested locale key')
    // {es: 'Hola', en: 'Hello'}, 'es' → 'Hola'
  it('returns fallback when value is undefined')
    // undefined, 'es' → ''
  it('returns the string directly when value is a plain string')
    // 'Hello', 'es' → 'Hello'
  it('returns fallback when the locale key does not exist')
    // {es: 'Hola'}, 'en' → ''
  it('returns custom fallback when provided')
    // undefined, 'es', 'N/A' → 'N/A'
```

**File:** `frontend/lib/utils.ts` — Add:

```typescript
export function getLocalizedField(
  value: string | Record<string, string> | undefined,
  locale: string,
  fallback = ''
): string {
  if (!value) return fallback;
  if (typeof value === 'string') return value;
  return value[locale] ?? fallback;
}
```

#### Step A2: Add tests for localized form state

**File:** `frontend/components/admin/products/ProductForm.test.tsx`

Add `mockProductWithLocalizedFields` with `title: {es: 'Gato Gracioso', en: 'Funny Cat'}` (cast as `unknown as string` for TS compat). New tests in `describe('edit mode')`:

```
it('extracts es/en from localized title object')
  // expect titleEs input = 'Gato Gracioso', titleEn input = 'Funny Cat'
it('extracts es/en from localized description object')
  // expect descriptionEs input = 'Un meme de gato', descriptionEn input = 'A cat meme'
it('handles product with string title (backward compat)')
  // existing mockProduct with string title still works
```

#### Step A3: Fix `getInitialFormState` in ProductForm.tsx

Import `getLocalizedField` and change lines 64-67:

```typescript
// Before:
titleEs: product.title ?? '',
titleEn: '',
descriptionEs: product.description ?? '',
descriptionEn: '',

// After:
titleEs: getLocalizedField(product.title as string | Record<string, string> | undefined, 'es'),
titleEn: getLocalizedField(product.title as string | Record<string, string> | undefined, 'en'),
descriptionEs: getLocalizedField(product.description as string | Record<string, string> | undefined, 'es'),
descriptionEn: getLocalizedField(product.description as string | Record<string, string> | undefined, 'en'),
```

---

### Bug B — "No file provided" on image upload

#### Step B1: Add tests for FormData Content-Type stripping

**File:** `frontend/lib/api/client.test.ts`

Add tests inside `describe('Request Interceptor')`:

```
it('removes Content-Type header when request data is FormData')
  // FormData body → config.headers['Content-Type'] is undefined
  // Auth header should still be set
it('keeps Content-Type header for non-FormData requests')
  // JSON body → config.headers['Content-Type'] is 'application/json'
```

#### Step B2: Implement FormData detection in interceptor

**File:** `frontend/lib/api/client.ts`

Add after the auth token logic in the request interceptor:

```typescript
// Let axios auto-set Content-Type for FormData (multipart/form-data with boundary)
if (config.data instanceof FormData && config.headers) {
  delete config.headers['Content-Type'];
}
```

---

### Bug C — No guidance for images on create form

#### Step C1: Add tests for create-mode image guidance

**File:** `frontend/components/admin/products/ProductForm.test.tsx`

In `describe('create mode')`:
```
it('shows informational message about images in create mode')
  // expect text /images can be added after/i to be present
```

In `describe('edit mode')`:
```
it('does not show create-mode image guidance in edit mode')
  // expect text /images can be added after/i NOT to be present
```

#### Step C2: Add Alert message in ProductForm.tsx

Replace the images conditional block (lines 438-448):

```tsx
{/* Images section */}
<div className="mt-8">
  <h2 className="mb-4 text-xl font-semibold">Images</h2>
  {isEditMode && product?.id ? (
    <ProductImageManager productId={product.id} images={images} onImagesChange={setImages} />
  ) : (
    <Alert>
      <AlertDescription>Images can be added after the product is created.</AlertDescription>
    </Alert>
  )}
</div>
```

---

### Files Summary

| File | Action | Bug |
|------|--------|-----|
| `frontend/lib/utils.test.ts` | CREATE | A |
| `frontend/lib/utils.ts` | MODIFY (add `getLocalizedField`) | A |
| `frontend/components/admin/products/ProductForm.test.tsx` | MODIFY (add tests) | A, C |
| `frontend/components/admin/products/ProductForm.tsx` | MODIFY (fix form state, add image guidance) | A, C |
| `frontend/lib/api/client.test.ts` | MODIFY (add FormData tests) | B |
| `frontend/lib/api/client.ts` | MODIFY (add FormData detection) | B |

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-17*
