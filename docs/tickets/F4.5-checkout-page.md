# F4.5: Implement Checkout Page (Multi-Step)

**Sprint:** 4
**Type:** Frontend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint4-F4.5-checkout-page
**Created:** 2026-02-19
**Dependencies:** F4.1 (cartStore) ✅, F4.6 (AddressForm) ✅, F4.7 (PromoCodeInput) ✅, F4.8 (OrderSummary) ✅

---

## Description

Implement the checkout page at `/checkout` that integrates all Sprint 4 components into a multi-step checkout flow. The page supports both guest and registered user checkout (UC-CHK-01, UC-CHK-02).

**Guest flow:** Enter email + phone → fill shipping address → (optional) apply promo code → review order summary → place order → redirect to Stripe.

**Registered user flow:** Select saved address (or add new) → (optional) apply promo code → review order summary → place order → redirect to Stripe.

The backend `POST /orders` endpoint does not exist yet (Sprint 5+). The checkout page will call it via a service, but order submission will produce an API error until the backend is built. All other functionality (cart validation via `/cart/calculate`, address management, promo code validation) uses existing backend endpoints.

---

## Acceptance Criteria

- [x] Checkout page at `/checkout` renders with proper metadata
- [x] Empty cart redirects to `/cart` with appropriate message
- [x] Guest checkout: shows email, phone inputs and inline address form for shipping address
- [x] Registered checkout: fetches and displays saved addresses with selection
- [x] Registered checkout: "Add new address" option opens AddressForm
- [x] PromoCodeInput is integrated and passes current subtotal
- [x] OrderSummary displays backend-calculated totals from `/cart/calculate`
- [x] Totals recalculate when promo code is applied/removed
- [x] Cart validation errors from backend are displayed
- [x] "Place Order" button is disabled until shipping address is complete
- [x] "Place Order" calls `orderService.create()` with correct payload (successUrl, cancelUrl, shippingAddress, email/phone for guest)
- [x] Loading states shown during API calls (calculate totals, place order)
- [x] Error handling for API failures with user-friendly messages
- [x] Responsive layout (two-column on desktop, stacked on mobile)
- [x] Unit tests for CheckoutPageContent component
- [x] All tests pass, lint passes, build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `app/checkout/page.tsx` | Server component with metadata |
| `components/checkout/CheckoutPageContent.tsx` | Main client component with checkout logic |
| `components/checkout/CheckoutPageContent.test.tsx` | Tests for CheckoutPageContent |
| `components/checkout/AddressSelector.tsx` | Address list + selection for registered users |
| `components/checkout/AddressSelector.test.tsx` | Tests for AddressSelector |
| `lib/services/orderService.ts` | Service for `POST /orders` |
| `lib/services/orderService.test.ts` | Tests for orderService |

---

## Technical Notes

### Existing components to integrate
- **AddressForm** (`components/address/AddressForm.tsx`) — create/edit mode, blur validation, `onSuccess(address)` callback
- **PromoCodeInput** (`components/promo-code/PromoCodeInput.tsx`) — apply/remove, `onApply(result)` / `onRemove()` callbacks, needs `orderTotal` prop
- **OrderSummary** (`components/checkout/OrderSummary.tsx`) — presentational, needs backend-calculated totals
- **checkoutService** (`lib/services/checkoutService.ts`) — `calculateTotals(items, promoCode?)`
- **addressService** (`lib/services/addressService.ts`) — `list()`, `create()` for registered users
- **cartStore** (`lib/stores/cartStore.ts`) — `items`, `subtotal`, `clearCart()`, `skipHydration: true`

### Authentication detection
- Use `useAuthStore` to check if user is authenticated
- Auth store also uses `skipHydration: true` — must call `rehydrate()` on mount

### API: POST /orders (CreateOrderRequest)
```typescript
{
  shippingAddress: CreateAddressRequest,  // required
  billingAddress?: CreateAddressRequest,  // optional, omit for MVP
  email?: string,           // required for guest
  phone?: string,           // required for guest
  saveAddress?: boolean,    // for registered users
  successUrl: string,       // redirect after payment
  cancelUrl: string,        // redirect if cancelled
}
```
Response: `{ data: { orderId, orderNumber, checkoutUrl } }`

### Layout pattern
- Two-column responsive: left column (forms), right column (OrderSummary sticky sidebar)
- Mobile: stacked (forms first, summary below)
- Follow cart page responsive pattern

### Business rules
- Email required for guest (BR-1), phone required for guest (BR-2)
- Cart must have items (redirect to `/cart` if empty)
- Backend calculates all totals — never trust frontend cart math
- Shipping/tax = 0 for MVP
- ADR-009: handle case where registered user has no default address (prompt selection)

---

## Implementation Plan

### Phase 1: orderService (service layer for POST /orders)

**Goal:** Create a thin service wrapping `POST /orders` following `checkoutService`/`addressService` patterns.

#### 1a: Tests (RED)

**File:** `lib/services/orderService.test.ts`

Mock `../api/client` (same pattern as `addressService.test.ts`). Tests:
1. `create` calls `POST /orders` with the request body
2. `create` returns the unwrapped `CreateOrderResponse` data (`{ orderId, orderNumber, checkoutUrl }`)
3. `create` propagates `ApiException` on 400
4. `create` propagates `ApiException` on network error

#### 1b: Implementation (GREEN)

**File:** `lib/services/orderService.ts`

- `apiClient.post<CreateOrderResponse>('/orders', data)` + envelope unwrap (`response.data.data!`)
- Export `OrderCreateResult` type for consumers

---

### Phase 2: AddressSelector component

**Goal:** Component for registered users to select from saved addresses or add a new one.

#### 2a: Test fixtures update

**File:** `components/checkout/testing/fixtures.ts` — add `createAddress()` factory

#### 2b: Tests (RED)

**File:** `components/checkout/AddressSelector.test.tsx`

Mocks: `addressService.list` (relative path), `AddressForm` (simplified mock).

**Props:** `onSelect: (address: Address) => void`

Test groups:
- **A: Loading** — shows loading indicator while fetching
- **B: Addresses loaded** — renders address cards, pre-selects default, clicking selects address
- **C: Empty list** — shows "Add new address" prompt
- **D: Add new flow** — clicking "Add new" reveals AddressForm, `onSuccess` adds + selects, cancel hides form
- **E: Error** — shows error message + retry button
- **F: Accessibility** — address options have appropriate roles

#### 2c: Implementation (GREEN)

**File:** `components/checkout/AddressSelector.tsx`

- State: `addresses`, `selectedId`, `isLoading`, `error`, `showForm`
- `useEffect` → `addressService.list()` on mount
- Auto-select default address, call `onSelect`
- Card-based UI with highlight for selected
- "Add new address" button → shows AddressForm

---

### Phase 3: CheckoutPageContent (main orchestrator)

**Goal:** Compose all checkout components with guest/registered flows.

#### 3a: Tests (RED)

**File:** `components/checkout/CheckoutPageContent.test.tsx`

Mocks (all relative paths): `cartStore`, `authStore`, `checkoutService`, `orderService`, `OrderSummary`, `AddressSelector`, `AddressForm`, `PromoCodeInput`, `next/navigation`, `next/link`.

Store mock pattern: selector-based (same as `CartPageContent.test.tsx`), with `persist.rehydrate` attached.

Test groups:
- **A: Hydration** — rehydrates both stores on mount
- **B: Empty cart** — redirects to `/cart`
- **C: Guest rendering** — email/phone inputs + AddressForm (not AddressSelector)
- **D: Registered rendering** — AddressSelector (not email/phone/inline AddressForm)
- **E: PromoCodeInput** — renders with current subtotal
- **F: OrderSummary + calculateTotals** — calls `calculateTotals` on mount, passes totals/errors/loading to OrderSummary
- **G: Promo code recalculation** — re-calls `calculateTotals` on apply/remove
- **H: Place Order button** — disabled without address/email/phone; enabled when complete; loading state during submit
- **I: Place Order submission** — correct payload for guest vs registered, redirects to `checkoutUrl`
- **J: Error handling** — displays errors from `calculateTotals` and `orderService.create`
- **K: Guest contact validation** — email/phone blur validation
- **L: Layout** — two-column responsive grid

#### 3b: Implementation (GREEN)

**File:** `components/checkout/CheckoutPageContent.tsx`

**Key architectural decisions:**

1. **Guest address form:** Do NOT reuse `AddressForm` for guests (it calls `addressService.create()` which requires auth). Instead, inline a lightweight address form that uses `validateAddressForm()` for validation but stores data locally. `AddressForm` is only used inside `AddressSelector` for registered users adding new addresses.

2. **Promo code flow:** `PromoCodeInput` is self-contained (calls `promoCodeService.validate()` internally). Checkout page captures the code string from `onApply`, passes it to `calculateTotals`, clears on `onRemove`. OrderSummary gets promo display data from `calculateTotals` response, NOT from PromoCodeInput.

3. **calculateTotals timing:** Called on mount + whenever promo code changes. Cart items come from `cartStore` and shouldn't change during checkout.

4. **Guest phone validation:** Phone is required for guests (BR-2) — inline check since `validatePhone()` treats empty as valid.

**Layout:** Two-column responsive (`lg:grid-cols-3`, left `lg:col-span-2` forms, right `lg:col-span-1` sticky OrderSummary + Place Order button).

**Helper:** `addressToCreateRequest(addr: Address): CreateAddressRequest` to extract address fields.

---

### Phase 4: page.tsx (server component)

**File:** `app/checkout/page.tsx`

```typescript
import type { Metadata } from 'next';
import { CheckoutPageContent } from '@/components/checkout/CheckoutPageContent';

export const metadata: Metadata = {
  title: 'Checkout | MemeStore',
};

export default function CheckoutPage() {
  return <CheckoutPageContent />;
}
```

Trivial wrapper — no separate test needed (component tests cover all logic).

---

### Phase 5: Final verification

1. Run all tests: `cd frontend && npm test`
2. Run lint: `cd frontend && npm run lint`
3. Run build: `cd frontend && npm run build`
4. Run `production-code-validator` agent

---

### Files summary

| File | Action | Purpose |
|------|--------|---------|
| `lib/services/orderService.test.ts` | Create | Tests for order service |
| `lib/services/orderService.ts` | Create | Service wrapping POST /orders |
| `components/checkout/testing/fixtures.ts` | Modify | Add `createAddress` factory |
| `components/checkout/AddressSelector.test.tsx` | Create | Tests for address selector |
| `components/checkout/AddressSelector.tsx` | Create | Address selection for registered users |
| `components/checkout/CheckoutPageContent.test.tsx` | Create | Tests for checkout orchestrator |
| `components/checkout/CheckoutPageContent.tsx` | Create | Main checkout client component |
| `app/checkout/page.tsx` | Create | Server component with metadata |

### TDD sequence

1. `orderService.test.ts` → `orderService.ts`
2. Update `testing/fixtures.ts` with `createAddress`
3. `AddressSelector.test.tsx` → `AddressSelector.tsx`
4. `CheckoutPageContent.test.tsx` → `CheckoutPageContent.tsx`
5. `app/checkout/page.tsx`
6. Full verification

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (47 new tests, 884 total)
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-19*
