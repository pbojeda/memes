# B3.5: Implement Product Detail Endpoint

**Sprint:** 3
**Type:** Backend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint3-B3.5-product-detail-endpoint
**Created:** 2026-02-12
**Dependencies:** B3.1 (models), B3.3 (product service CRUD), B3.4 (product listing)

---

## Description

Implement the public product detail endpoint (`GET /products/:slug`) that returns a product with its associated images and reviews. This is the endpoint used by the product detail page to display full product information including the image gallery and customer reviews.

The endpoint must:
- Fetch a product by slug (public, no auth required)
- Include related images (sorted by `sortOrder`) and visible reviews (sorted by `createdAt` desc)
- Exclude soft-deleted products
- Increment the product's `viewCount` (fire-and-forget, non-blocking)
- Follow the existing controller/route/service patterns established in productType

---

## Acceptance Criteria

- [x] `getProductDetailBySlug` service function returns product with images and visible reviews
- [x] Reviews are filtered by `isVisible: true` (only visible reviews returned)
- [x] Images are sorted by `sortOrder` ASC, then `createdAt` ASC
- [x] Reviews are sorted by `createdAt` DESC
- [x] `viewCount` is incremented asynchronously (non-blocking, no await)
- [x] Soft-deleted products are excluded (`deletedAt: null`)
- [x] Product controller `getProductDetail` handles request/response
- [x] Controller maps domain errors to proper HTTP status codes (404, 400)
- [x] Route `GET /api/products/:slug` is registered (public, no auth)
- [x] Routes index updated to mount product routes at `/products`
- [x] Unit tests for service function (happy path, not found, soft-deleted, images/reviews inclusion)
- [x] Unit tests for controller (success, 404, 400)
- [x] All existing tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/application/services/productService.ts` | Add `getProductDetailBySlug` function |
| `backend/src/presentation/controllers/productController.ts` | **NEW** — Product controller with `getProductDetail` handler |
| `backend/src/presentation/controllers/productController.test.ts` | **NEW** — Controller tests |
| `backend/src/routes/productRoutes.ts` | **NEW** — Product routes |
| `backend/src/routes/index.ts` | Register product routes |
| `backend/src/application/services/__tests__/productService.test.ts` | Add tests for `getProductDetailBySlug` |

---

## Implementation Steps

### Step 1: Add `getProductDetailBySlug` to productService
1. Create a new function that validates slug, queries product with `include: { images, reviews }`
2. Filter reviews by `isVisible: true`, sort images by `sortOrder`, reviews by `createdAt` desc
3. Exclude soft-deleted products (`deletedAt: null`)
4. Increment `viewCount` non-blocking (fire-and-forget)
5. Return product with images and reviews

### Step 2: Create productController
1. Follow `productTypeController` pattern
2. `getProductDetail` handler: extract `:slug` param, call service, return `success(res, product)`
3. `handleProductError` helper: map `ProductNotFoundError` → 404, `InvalidProductDataError` → 400

### Step 3: Create productRoutes
1. Follow `productTypeRoutes` pattern
2. Register `GET /:slug` → `getProductDetail` (public, no auth)

### Step 4: Register routes
1. Add `import productRoutes` to routes/index.ts
2. Mount at `/products`

### Step 5: Write Tests (TDD — tests first)
1. Service tests: happy path, not found, soft-deleted excluded, images sorted, reviews filtered/sorted, viewCount increment
2. Controller tests: success response, 404, 400, error delegation to next()

---

## Technical Notes

- **Existing patterns**: Follow `productTypeController.ts` and `productTypeRoutes.ts` for controller/route structure
- **Response helpers**: Use `success()` from `utils/responseHelpers.ts`
- **Domain errors**: Reuse `ProductNotFoundError`, `InvalidProductDataError` from `domain/errors/ProductError.ts`
- **Validator**: Reuse `validateSlug` from `application/validators/shared.ts`
- **API spec**: `GET /products/{slug}` already defined in `api-spec.yaml` — response schema is `ProductDetailResponse` containing `ProductDetail` (Product + images[] + reviews[])
- **viewCount**: Use fire-and-forget pattern (`prisma.product.update(...)` without await) to avoid slowing down the response
- **ProductDetail type**: The service return type should include `images: ProductImage[]` and `reviews: ProductReview[]` alongside product fields

---

## Implementation Plan

### Existing Code to Reuse

**Domain Errors** (`backend/src/domain/errors/ProductError.ts`)
- `ProductNotFoundError` - For 404 responses when product not found
- `InvalidProductDataError` - For 400 responses when slug validation fails

**Validators** (`backend/src/application/validators/`)
- `validateSlug()` from `productValidator.ts` - Already validates slug format (wraps shared validator)

**Utilities** (`backend/src/utils/responseHelpers.ts`)
- `success()` - For 200 responses with data

**Existing Service** (`backend/src/application/services/productService.ts`)
- `getProductBySlug()` - Base function to fetch product by slug (excludes soft-deleted)
- Pattern for Prisma queries with `include` for related data
- Pattern for excluding soft-deleted products with `deletedAt: null`

**Existing Patterns**
- Controller pattern from `productTypeController.ts` - Error handling helper function
- Route pattern from `productTypeRoutes.ts` - Route registration
- Test pattern from `productService.test.ts` and `productTypeController.test.ts` - Mock setup and AAA pattern

### Files to Create

1. **`backend/src/presentation/controllers/productController.ts`**
   - Product controller with `getProductDetail` handler
   - Private `handleProductError` helper for error-to-HTTP mapping
   - Follows `productTypeController.ts` pattern exactly

2. **`backend/src/presentation/controllers/productController.test.ts`**
   - Controller tests for `getProductDetail`
   - Mock Express req/res/next
   - Test success (200), not found (404), invalid slug (400), unexpected errors

3. **`backend/src/routes/productRoutes.ts`**
   - Product routes module
   - Register `GET /:slug` route (public, no auth)
   - Follows `productTypeRoutes.ts` pattern

### Files to Modify

1. **`backend/src/application/services/productService.ts`**
   - Add new function: `getProductDetailBySlug(slug: string)`
   - Returns product with `include: { images: {...}, reviews: {...} }`
   - Images sorted by `sortOrder ASC, createdAt ASC`
   - Reviews filtered by `isVisible: true`, sorted by `createdAt DESC`
   - Fire-and-forget viewCount increment (no await)

2. **`backend/src/application/services/productService.test.ts`**
   - Add test suite for `getProductDetailBySlug`
   - Tests: happy path with images/reviews, not found, soft-deleted excluded, viewCount incremented, images sorted, reviews filtered/sorted

3. **`backend/src/routes/index.ts`**
   - Import `productRoutes`
   - Mount at `/products` with `router.use('/products', productRoutes)`

### Implementation Order

**1. Application Layer - Service Function**
- File: `backend/src/application/services/productService.ts`
- Add `getProductDetailBySlug(slug: string)` function
- Validate slug using `validateSlug()`
- Query product with `prisma.product.findFirst()`:
  - Where: `slug` + `deletedAt: null`
  - Include:
    - `images: { orderBy: [{ sortOrder: 'asc' }, { createdAt: 'asc' }] }`
    - `reviews: { where: { isVisible: true }, orderBy: { createdAt: 'desc' } }`
- Throw `ProductNotFoundError` if not found
- Increment viewCount (fire-and-forget): `prisma.product.update({ where: { id: product.id }, data: { viewCount: { increment: 1 } } })` without await
- Return product with images and reviews

**2. Application Layer - Service Tests**
- File: `backend/src/application/services/productService.test.ts`
- Add `describe('getProductDetailBySlug', ...)` block
- Test cases:
  - Should return product with images and reviews when found
  - Should throw ProductNotFoundError when product not found
  - Should exclude soft-deleted products
  - Should include images sorted by sortOrder ASC, then createdAt ASC
  - Should include only visible reviews sorted by createdAt DESC
  - Should increment viewCount asynchronously
  - Should throw InvalidProductDataError for invalid slug

**3. Presentation Layer - Controller**
- File: `backend/src/presentation/controllers/productController.ts`
- Import service, errors, response helpers
- Implement `getProductDetail(req, res, next)`:
  - Extract slug from `req.params.slug`
  - Call `productService.getProductDetailBySlug(slug)`
  - Return `success(res, product)`
  - Catch errors with `handleProductError(error, res, next)`
- Implement `handleProductError(error, res, next)`:
  - Map `InvalidProductDataError` → 400
  - Map `ProductNotFoundError` → 404
  - Delegate other errors to `next(error)`

**4. Presentation Layer - Controller Tests**
- File: `backend/src/presentation/controllers/productController.test.ts`
- Mock `productService.getProductDetailBySlug`
- Test cases:
  - Should return 200 with product detail when found
  - Should return 404 when ProductNotFoundError thrown
  - Should return 400 when InvalidProductDataError thrown
  - Should call next(error) for unexpected errors

**5. Presentation Layer - Routes**
- File: `backend/src/routes/productRoutes.ts`
- Import Router, controller
- Register `GET /:slug` → `getProductDetail` (public, no middleware)
- Export router

**6. Presentation Layer - Routes Index**
- File: `backend/src/routes/index.ts`
- Import `productRoutes`
- Add `router.use('/products', productRoutes)` after product-types

### Testing Strategy

**Service Tests** (`productService.test.ts`)
- Mock `prisma.product.findFirst` to return product with images/reviews
- Mock `prisma.product.update` for viewCount increment
- Verify:
  - Query includes `images` and `reviews` with correct ordering/filtering
  - `deletedAt: null` is in where clause
  - `validateSlug()` is called
  - `ProductNotFoundError` thrown when null returned
  - `viewCount` update called without await (fire-and-forget)

**Controller Tests** (`productController.test.ts`)
- Mock Express `req`, `res`, `next`
- Mock `productService.getProductDetailBySlug`
- Verify:
  - `req.params.slug` extracted correctly
  - Service called with slug
  - `success()` helper called with product
  - Error mapping (400, 404) works correctly
  - Unexpected errors delegated to `next()`

**Integration Verification**
- Manual testing: `GET /api/products/:slug` returns product with images/reviews
- Verify API spec alignment: Response matches `ProductDetailResponse` schema

### Key Patterns to Follow

**1. Service Function Pattern** (from `getProductBySlug`)
```typescript
export async function getProductDetailBySlug(slug: string): Promise<ProductWithDetails> {
  const validatedSlug = validateSlug(slug, 'slug');

  const product = await prisma.product.findFirst({
    where: { slug: validatedSlug, deletedAt: null },
    include: {
      images: { orderBy: [{ sortOrder: 'asc' }, { createdAt: 'asc' }] },
      reviews: { where: { isVisible: true }, orderBy: { createdAt: 'desc' } }
    }
  });

  if (!product) {
    throw new ProductNotFoundError();
  }

  // Fire-and-forget viewCount increment (non-blocking)
  prisma.product.update({
    where: { id: product.id },
    data: { viewCount: { increment: 1 } }
  }).catch(() => {}); // Silently catch errors

  return product;
}
```

**2. Controller Error Handling Pattern** (from `productTypeController.ts`)
```typescript
function handleProductError(error: unknown, res: Response, next: NextFunction): void {
  if (error instanceof InvalidProductDataError) {
    res.status(400).json({ success: false, error: { message: error.message, code: error.code, field: error.field } });
    return;
  }
  if (error instanceof ProductNotFoundError) {
    res.status(404).json({ success: false, error: { message: error.message, code: error.code } });
    return;
  }
  next(error);
}
```

**3. Route Pattern** (from `productTypeRoutes.ts`)
```typescript
import { Router } from 'express';
import { getProductDetail } from '../presentation/controllers/productController';

const router = Router();

// GET /api/products/:slug - Get product detail (public, no auth)
router.get('/:slug', getProductDetail);

export default router;
```

**4. Test Mock Pattern** (from `productService.test.ts`)
```typescript
jest.mock('../../lib/prisma', () => ({
  __esModule: true,
  default: {
    product: {
      findFirst: jest.fn(),
      update: jest.fn()
    }
  }
}));
```

**5. Fire-and-Forget Pattern** (viewCount increment)
- Do NOT await the update promise
- Catch errors silently with `.catch(() => {})`
- This prevents blocking the response while still incrementing the counter

### Important Notes

1. **Slug Validation**: Use existing `validateSlug()` from `productValidator.ts` - it wraps the shared validator and throws `InvalidProductDataError`

2. **Fire-and-Forget viewCount**: The `prisma.product.update()` for viewCount MUST NOT be awaited. Add `.catch(() => {})` to silently handle errors without crashing the request.

3. **Image Sorting**: Use multiple `orderBy` clauses in Prisma: `orderBy: [{ sortOrder: 'asc' }, { createdAt: 'asc' }]`

4. **Review Filtering**: Use nested `where` clause in include: `reviews: { where: { isVisible: true }, orderBy: { createdAt: 'desc' } }`

5. **Soft-Delete Exclusion**: Always include `deletedAt: null` in the where clause (pattern from existing `getProductBySlug`)

6. **Type Safety**: The return type should be `Product & { images: ProductImage[], reviews: ProductReview[] }` or define a new type `ProductWithDetails`

7. **API Spec Alignment**: The response schema `ProductDetailResponse` is already defined in `api-spec.yaml` - ensure the service return matches this structure

8. **No Auth Required**: This is a public endpoint - do NOT add `authMiddleware` or `requireRole` to the route

9. **Test Coverage**: Ensure 90% coverage threshold is met - test all error paths, edge cases, and the fire-and-forget viewCount increment

10. **Controller Pattern**: Follow `productTypeController.ts` exactly - use the same error handling helper pattern with `handleProductError` function

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code follows project standards (DDD layers, error handling, TypeScript strict)
- [ ] No linting errors
- [ ] Build succeeds

---

*Ticket created: 2026-02-12*
