# B0.8: Setup global error handling middleware

**Sprint:** 0
**Type:** Backend - Setup
**Priority:** High
**Status:** Completed
**Branch:** feature/sprint0-B0.8-error-handling
**Created:** 2026-02-03
**Completed:** 2026-02-03
**Dependencies:** B0.5 (Jest setup)

---

## Description

Implement a global error handling middleware for Express that provides consistent error responses, proper logging, and environment-aware error details (stack traces in development only).

---

## Acceptance Criteria

- [x] AppError base class with statusCode and isOperational flags
- [x] Specialized error classes (NotFoundError, ValidationError, UnauthorizedError)
- [x] Global error handler middleware
- [x] Consistent JSON error response format
- [x] Stack traces in development, hidden in production
- [x] Errors logged via Pino logger
- [x] Integrated into Express app

---

## Files Created/Modified

| File | Purpose |
|------|---------|
| `backend/src/middleware/errorHandler.ts` | Error classes and middleware |
| `backend/src/middleware/errorHandler.test.ts` | Tests for error handling |
| `backend/src/app.ts` | Integration of error handler |

---

## Test Specifications (TDD)

```typescript
describe('Error Handler Middleware', () => {
  describe('AppError', () => {
    it('should create an AppError with message and status code');
    it('should default to status 500 if not provided');
  });

  describe('NotFoundError', () => {
    it('should create a NotFoundError with 404 status');
  });

  describe('Error Handler', () => {
    it('should return JSON error response for AppError');
    it('should return 500 for unknown errors');
    it('should return 404 for NotFoundError');
    it('should include stack trace in development mode');
    it('should not include stack trace in production mode');
  });
});
```

---

## Error Classes

| Class | Status Code | Use Case |
|-------|-------------|----------|
| `AppError` | configurable (default 500) | Base class for operational errors |
| `NotFoundError` | 404 | Resource not found |
| `ValidationError` | 400 | Input validation failures |
| `UnauthorizedError` | 401 | Authentication failures |

---

## Response Format

```typescript
interface ErrorResponse {
  error: {
    message: string;
    statusCode: number;
    stack?: string; // Only in development
  };
}
```

---

## Definition of Done

- [x] All tests pass (8 new tests, 25 total)
- [x] TypeScript compiles without errors
- [x] Error handler integrated into app.ts
- [x] Operational vs unexpected errors distinguished
- [x] Code validated by production-code-validator

---

## Notes

### Implementation Notes (2026-02-03)
- `isOperational` flag distinguishes expected errors from unexpected crashes
- Unexpected errors return generic "Internal Server Error" message
- All errors logged: warn for operational, error for unexpected
- Error handler must be registered last in middleware chain

---

*Ticket created: 2026-02-03*
