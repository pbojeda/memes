# B3.8: Implement Product Review Management

**Sprint:** 3
**Type:** Backend - Feature
**Priority:** Medium
**Status:** In Progress
**Branch:** feature/sprint3-B3.8-product-review-management
**Created:** 2026-02-13
**Dependencies:** B3.1 (Product models - completed)

---

## Description

Implement the product review management service, validators, controller, and routes following the DDD layered architecture. Reviews are staff-managed (MANAGER/ADMIN only for write operations) with public read access. Key features include:

- **CRUD operations**: Create, list, update, and delete reviews
- **Rating validation**: 1-5 star constraint enforced at validator/service level (Prisma doesn't support DB CHECK constraints)
- **AI-generated flag**: Track whether a review was AI-generated
- **Visibility toggle**: Dedicated endpoint to show/hide reviews
- **Review analytics**: Average rating and rating distribution in list response

Reviews are not tied to authenticated users — they use an `authorName` string field, as reviews are staff-curated content (real customer reviews and AI-generated ones).

---

## Acceptance Criteria

- [x] Review validator validates all fields (authorName, rating 1-5, comment minLength 10, isAiGenerated, isVisible)
- [x] Review service implements: createReview, listReviews, updateReview, deleteReview, toggleVisibility
- [x] Rating constraint (1-5) enforced at validator level with clear error message
- [x] List reviews returns pagination meta + averageRating + ratingDistribution
- [x] List reviews (public) only returns visible reviews (`isVisible: true`)
- [x] Create review verifies product exists before creating
- [x] Update review supports partial updates (authorName, rating, comment, isVisible)
- [x] Delete review permanently removes the review
- [x] Toggle visibility endpoint accepts `{ isVisible: boolean }` body
- [x] Controller maps domain errors to HTTP status codes (400, 404)
- [x] Routes: GET/POST `/products/:productId/reviews`, PATCH/DELETE `/reviews/:reviewId`, PATCH `/reviews/:reviewId/visibility`
- [x] All write endpoints require MANAGER/ADMIN role
- [x] GET endpoint is public (no auth required)
- [x] Unit tests for validator, service, and controller
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `src/application/validators/productReviewValidator.ts` | Input validation (rating 1-5, required fields) |
| `src/application/validators/productReviewValidator.test.ts` | Validator tests |
| `src/application/services/productReviewService.ts` | Business logic (CRUD + toggle + analytics) |
| `src/application/services/productReviewService.test.ts` | Service tests |
| `src/presentation/controllers/productReviewController.ts` | HTTP handling, error mapping |
| `src/presentation/controllers/productReviewController.test.ts` | Controller tests |
| `src/routes/productRoutes.ts` | Add review routes under `/products/:productId/reviews` |
| `src/routes/reviewRoutes.ts` | Review-specific routes (`/reviews/:reviewId`, `/reviews/:reviewId/visibility`) |
| `src/routes/index.ts` | Register review routes |

---

## Technical Notes

- **Rating CHECK constraint**: Prisma doesn't support DB CHECK constraints. Enforce rating 1-5 at validator level (from B3.1 code review note).
- **Existing domain errors**: `ProductReviewError`, `ProductReviewNotFoundError`, `InvalidProductReviewDataError` already exist in `src/domain/errors/ProductReviewError.ts` with tests.
- **Product existence check**: Use `prisma.product.findFirst()` before creating a review. Reuse `ProductNotFoundError` from product domain.
- **Analytics calculation**: `averageRating` and `ratingDistribution` computed from DB aggregation queries.
- **Route structure**: Reviews have two route prefixes:
  - `/products/:productId/reviews` — scoped to a product (list + create)
  - `/reviews/:reviewId` — direct review access (update, delete, toggle visibility)
- **Follow existing patterns**: Mirror `productImageController.ts` / `productImageService.ts` patterns for consistency.

---

## Implementation Plan

### TDD Implementation Order

| Step | Action | File |
|------|--------|------|
| 1 | Write tests | `src/application/validators/productReviewValidator.test.ts` |
| 2 | Implement | `src/application/validators/productReviewValidator.ts` |
| 3 | Write tests | `src/application/services/productReviewService.test.ts` |
| 4 | Implement | `src/application/services/productReviewService.ts` |
| 5 | Write tests | `src/presentation/controllers/productReviewController.test.ts` |
| 6 | Implement | `src/presentation/controllers/productReviewController.ts` |
| 7 | Create routes | `src/routes/reviewRoutes.ts` + modify `productRoutes.ts` + `index.ts` |
| 8 | Full suite | Run all tests, lint, build |

### Step 1-2: Validator Layer (`productReviewValidator.ts`)

**Types:**
- `CreateReviewInput` / `ValidatedCreateReviewInput` — authorName, rating, comment, isAiGenerated?, isVisible?
- `UpdateReviewInput` / `ValidatedUpdateReviewInput` — all optional (authorName, rating, comment, isVisible). No `isAiGenerated` (immutable after create)
- `ToggleVisibilityInput` — `{ isVisible: boolean }` required
- `ListReviewsInput` / `ValidatedListReviewsInput` — page/limit with defaults

**Validation functions:**
1. `validateCreateReviewInput` — authorName (required, string, trimmed, max 100), rating (required, integer, 1-5), comment (required, string, min 10, max 2000), defaults: isAiGenerated=false, isVisible=true
2. `validateUpdateReviewInput` — partial, same type checks but no comment minLength on update (per API spec)
3. `validateToggleVisibilityInput` — isVisible required boolean
4. `validateListReviewsInput` — page default 1, limit default 20, max 100

**Constants:** MAX_AUTHOR_NAME_LENGTH=100, MIN_COMMENT_LENGTH=10, MAX_COMMENT_LENGTH=2000, MIN_RATING=1, MAX_RATING=5

### Step 3-4: Service Layer (`productReviewService.ts`)

**Functions:**
1. `listProductReviews(productId, input)` — Paginated visible reviews + averageRating + ratingDistribution. Analytics computed from ALL reviews (visible + hidden) for accurate product metrics. Uses Prisma `aggregate` for avg and `groupBy` for distribution.
2. `createReview(productId, input)` — Validate product exists (not soft-deleted), create review
3. `updateReview(reviewId, input)` — Find review or throw NotFound, partial update
4. `deleteReview(reviewId)` — Find review or throw NotFound, permanent delete
5. `toggleReviewVisibility(reviewId, input)` — Find review or throw NotFound, update isVisible

**Key patterns:**
- UUID validation on all IDs via shared `validateUUID`
- Product existence check uses `productService.getProductById(id, false)` (excludes soft-deleted)
- `groupBy` result transformed to `{ '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 }` shape, filling zeros for missing ratings
- `averageRating` defaults to 0 when no reviews exist (Prisma returns `null`)

### Step 5-6: Controller Layer (`productReviewController.ts`)

**Handlers:**
1. `listReviews` — GET, custom JSON response with `meta` (not `paginated()` helper) to include averageRating/ratingDistribution
2. `createReview` — POST, uses `created()` helper
3. `updateReview` — PATCH, uses `success()` helper
4. `deleteReview` — DELETE, uses `noContent()` helper
5. `toggleVisibility` — PATCH, uses `success()` helper

**Error mapping (`handleReviewError`):**
- `InvalidProductReviewDataError` → 400
- `ProductReviewNotFoundError` → 404
- `ProductNotFoundError` → 404
- Unknown → `next(error)`

### Step 7: Routes

**Product-scoped** (in `productRoutes.ts`, before `/:slug` catch-all):
- `GET /:productId/reviews` — public (no auth)
- `POST /:productId/reviews` — MANAGER/ADMIN

**Review-specific** (new `reviewRoutes.ts`, mounted at `/reviews`):
- `PATCH /:reviewId/visibility` — MANAGER/ADMIN (before `/:reviewId` to avoid conflict)
- `PATCH /:reviewId` — MANAGER/ADMIN
- `DELETE /:reviewId` — MANAGER/ADMIN

### Design Decisions

1. **Analytics from ALL reviews** (not just visible) — accurate product metrics for admins
2. **Comment minLength only on create** — API spec omits minLength from UpdateReviewRequest
3. **isAiGenerated immutable** — only settable at creation, not in UpdateReviewRequest
4. **No product check on update/delete/toggle** — review ID is sufficient, product FK is already set
5. **Route separation** — product-scoped routes in productRoutes.ts, review-specific in reviewRoutes.ts

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards (DDD layers, TypeScript strict)
- [x] No linting errors
- [x] Build succeeds

---

*Ticket created: 2026-02-13*
