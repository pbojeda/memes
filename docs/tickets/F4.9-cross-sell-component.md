# F4.9: Implement Cross-Sell Component

**Sprint:** 4
**Type:** Frontend - Feature
**Priority:** Medium
**Status:** In Progress
**Branch:** feature/sprint4-F4.9-cross-sell-component
**Created:** 2026-02-20
**Dependencies:** None (independent task)

---

## Description

Implement a cross-sell section that displays related products on the cart page. This fulfills business requirements RF-T10 ("Ver oferta de venta cruzada antes de finalizar compra") and RF-S06 ("Sistema de venta cruzada con productos relacionados"), as well as use case UC-CART-04 ("View Cross-Sell Recommendations").

The component fetches related products from the backend endpoint `GET /products/{productId}/related` (already defined in `api-spec.yaml`, already implemented in backend). It displays them using the existing `ProductGrid` component.

**Key design decisions:**
- The cross-sell section appears on the cart page, below the cart items list (full width)
- It uses the first item in the cart to determine related products
- It reuses existing `ProductGrid` and `ProductCard` components
- It is a self-contained client component that fetches its own data
- When the cart is empty, no cross-sell is shown (the empty cart state handles this)

---

## Acceptance Criteria

- [x] `CrossSellSection` component renders a "You May Also Like" section heading
- [x] Component fetches related products via `productService.getRelated(productId, limit)`
- [x] Displays products using the existing `ProductGrid` component
- [x] Shows loading skeletons while fetching (via `ProductGrid`'s loading state)
- [x] Renders nothing (returns `null`) when no related products are found
- [x] Renders nothing when fetch fails (graceful degradation — cross-sell is not critical)
- [x] `productService.getRelated()` method added to call `GET /products/{productId}/related`
- [x] `CrossSellSection` integrated into `CartPageContent` below the cart items list
- [x] Unit tests for `CrossSellSection` component (loading, populated, empty, error states)
- [x] Unit tests for `productService.getRelated()` method
- [x] All tests pass
- [x] Build succeeds

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `frontend/components/product/CrossSellSection.tsx` | New cross-sell component |
| `frontend/components/product/CrossSellSection.test.tsx` | Tests for CrossSellSection |
| `frontend/lib/services/productService.ts` | Add `getRelated()` method |
| `frontend/lib/services/productService.test.ts` | Add tests for `getRelated()` |
| `frontend/components/cart/CartPageContent.tsx` | Integrate CrossSellSection |
| `frontend/components/cart/CartPageContent.test.tsx` | Update tests for cross-sell integration |

---

## Technical Notes

### API Endpoint

```
GET /products/{productId}/related?limit=4
→ ProductListResponse { data: Product[], meta: PaginationMeta }
```

The endpoint is public (no auth required). Types already exist in `lib/api/types.ts` via `operations['getRelatedProducts']`.

### Component Design

```tsx
interface CrossSellSectionProps {
  productId: string;   // Product ID to get related products for
  limit?: number;      // Max products to show (default: 4)
  className?: string;  // Optional styling
}
```

- Self-contained: fetches data on mount via `useEffect` + `useState`
- Uses `ProductGrid` with custom `columns` prop for a tighter 4-column layout
- Graceful degradation: renders `null` on error or empty results (cross-sell is enhancement, not critical)
- No "Add to Cart" button on cross-sell cards — they link to the product detail page (existing `ProductCard` behavior)

### Integration in CartPageContent

The `CrossSellSection` should appear below the cart items list, outside the 2-column grid, spanning full width. Uses the `productId` from the first cart item.

### Existing Reusable Components

- `ProductGrid` — handles loading skeletons, empty state, responsive grid
- `ProductCard` — displays product image, title, price, rating
- `productService` — already has `list()` and `getBySlug()`; add `getRelated()`

### Test Patterns

- Mock `productService` with `jest.mock()` using relative path
- Use `createProducts()` fixture from `components/product/testing/fixtures.ts`
- Test states: loading → populated, loading → empty, loading → error
- For CartPageContent integration: mock `CrossSellSection` to avoid nested service calls

---

## Implementation Plan

### Step 1: Add `getRelated()` to `productService` (TDD)

**File:** `frontend/lib/services/productService.test.ts`

**Red** — Add a new `describe('getRelated', ...)` block. Follow the existing mock pattern (`mockApiClient.get`). Write these tests:

1. `should call GET /products/{productId}/related with limit param` — call `productService.getRelated('prod-123', 4)`, assert `mockApiClient.get` called with `'/products/prod-123/related'` and `{ params: { limit: 4 } }`.
2. `should use default limit when not provided` — call `productService.getRelated('prod-123')`, assert params use `{ limit: 4 }`.
3. `should return ProductListResponse data` — mock response, assert return value.
4. `should propagate errors from apiClient` — mock rejected `ApiException`, assert `rejects.toThrow`.

**Green** — Add method to `productService.ts`:

```ts
async getRelated(productId: string, limit: number = 4): Promise<ProductListResponse> {
  const response = await apiClient.get<ProductListResponse>(
    `/products/${productId}/related`,
    { params: { limit } }
  );
  return response.data;
},
```

---

### Step 2: Create `CrossSellSection` component (TDD)

**Files:** `frontend/components/product/CrossSellSection.test.tsx` (create), `frontend/components/product/CrossSellSection.tsx` (create)

**Mocks needed** (relative paths):
- `jest.mock('../../lib/services/productService')` — mock `getRelated`
- `jest.mock('./ProductGrid')` — render as `<div data-testid="product-grid" data-loading={...} data-product-count={...} />`

**Red** — Write tests across 6 groups:

**Group A: Loading state**
1. Renders `ProductGrid` with `loading=true` initially (never-resolving promise)
2. Renders heading "You May Also Like"
3. Passes `skeletonCount=4` and columns to `ProductGrid`

**Group B: Populated state**
4. Renders `ProductGrid` with fetched products after load
5. Calls `productService.getRelated(productId, 4)`
6. Passes custom `limit` when provided

**Group C: Empty state**
7. Renders nothing when API returns empty array

**Group D: Error state**
8. Renders nothing when fetch fails

**Group E: Re-fetch**
9. Re-fetches when `productId` prop changes

**Group F: className**
10. Applies `className` to wrapper `<section>`

**Green** — Create `CrossSellSection.tsx`:
- `'use client'` component with `useEffect` + `useState`
- `cancelled` flag in effect cleanup to prevent stale state updates
- Returns `null` when `!loading && products.length === 0`
- Uses `ProductGrid` with `columns="grid-cols-2 md:grid-cols-4"` and `skeletonCount={limit}`
- `<section>` wrapper with `<h2>You May Also Like</h2>`

---

### Step 3: Integrate into `CartPageContent` (TDD)

**Files:** `frontend/components/cart/CartPageContent.test.tsx`, `frontend/components/cart/CartPageContent.tsx`

**Red** — Add mock for CrossSellSection (`jest.mock('../product/CrossSellSection')`), then write 3 tests:

1. Renders `CrossSellSection` with first item's `productId` when cart has items
2. Does not render `CrossSellSection` when cart is empty
3. Uses first cart item's `productId`, not others

**Green** — In `CartPageContent.tsx`:
- Import `CrossSellSection`
- Add `<CrossSellSection productId={items[0].productId} className="mt-12" />` after the grid container, inside the populated cart branch

---

### Step 4: Final verification

1. Run tests: `cd frontend && npm test -- --testPathPatterns="productService|CrossSellSection|CartPageContent"`
2. Run lint: `cd frontend && npm run lint`
3. Run build: `cd frontend && npm run build`
4. Update ticket acceptance criteria

---

### Summary of files

| Order | File | Action |
|-------|------|--------|
| 1a | `frontend/lib/services/productService.test.ts` | Add `describe('getRelated')` with 4 tests |
| 1b | `frontend/lib/services/productService.ts` | Add `getRelated()` method |
| 2a | `frontend/components/product/CrossSellSection.test.tsx` | **Create** with ~10 tests |
| 2b | `frontend/components/product/CrossSellSection.tsx` | **Create** component (~50 lines) |
| 3a | `frontend/components/cart/CartPageContent.test.tsx` | Add mock + 3 tests |
| 3b | `frontend/components/cart/CartPageContent.tsx` | Add CrossSellSection integration |

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Unit tests written and passing
- [ ] Code follows project standards
- [ ] No linting errors
- [ ] Build succeeds

---

*Ticket created: 2026-02-20*
