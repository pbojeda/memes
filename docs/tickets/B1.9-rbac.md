# B1.9: Implement Role-Based Access Control (RBAC)

**Sprint:** 1
**Type:** Backend - Middleware
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-B1.9-rbac
**Created:** 2026-02-09
**Dependencies:** B1.4 (Auth middleware) - Completed

---

## Description

Implement a role-based access control middleware that restricts endpoint access based on user roles. The middleware should work in conjunction with the existing `authMiddleware` to check if the authenticated user has the required role(s) to access a resource.

**Available Roles (from schema):**
- `TARGET` - Regular customer (default)
- `MANAGER` - Store manager
- `ADMIN` - Full system access
- `MARKETING` - Marketing team member

**Existing Infrastructure:**
- `authMiddleware` already attaches `req.user` with `TokenPayload` containing `role`
- `TokenPayload` interface includes `role: UserRole`

---

## Acceptance Criteria

- [x] `requireRole()` middleware factory accepts single role or array of roles
- [x] Returns 403 Forbidden when user lacks required role
- [x] Works after `authMiddleware` (requires `req.user` to be set)
- [x] Returns 401 if `req.user` is missing (defensive check)
- [x] Error response follows project format with appropriate code
- [x] ForbiddenError class added to error handler
- [x] Unit tests cover all scenarios
- [x] All tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `backend/src/middleware/errorHandler.ts` | Modify | Add ForbiddenError class |
| `backend/src/middleware/roleMiddleware.ts` | Create | RBAC middleware |
| `backend/src/middleware/roleMiddleware.test.ts` | Create | Middleware tests |

---

## Implementation Steps

### Step 1: Add ForbiddenError to Error Handler

Add to `backend/src/middleware/errorHandler.ts`:

```typescript
export class ForbiddenError extends AppError {
  constructor(message = 'Access denied') {
    super(message, 403);
  }
}
```

### Step 2: Create Role Middleware (TDD)

Create `backend/src/middleware/roleMiddleware.ts`:

**requireRole(allowedRoles: UserRole | UserRole[]):**
1. Return middleware function
2. Check if `req.user` exists (defensive - should be set by authMiddleware)
3. If not, return 401 Unauthorized
4. Normalize `allowedRoles` to array
5. Check if `req.user.role` is in allowed roles
6. If not, throw ForbiddenError
7. Call `next()` if authorized

**Function Signature:**
```typescript
export function requireRole(
  allowedRoles: UserRole | UserRole[]
): (req: Request, res: Response, next: NextFunction) => void
```

### Step 3: Write Tests

Test scenarios for `roleMiddleware.test.ts`:

**Successful Access:**
- Should call next() when user has exact required role
- Should call next() when user has one of multiple allowed roles
- Should work with single role parameter
- Should work with array of roles parameter

**Access Denied:**
- Should return 403 when user role not in allowed roles
- Should return 403 for single role mismatch
- Should include proper error message and code

**Edge Cases:**
- Should return 401 when req.user is undefined (defensive)
- Should handle empty roles array gracefully

---

## API Error Response

**403 Forbidden:**
```json
{
  "success": false,
  "error": {
    "message": "Access denied",
    "code": "FORBIDDEN"
  }
}
```

---

## Usage Example

```typescript
import { authMiddleware } from '../middleware/authMiddleware';
import { requireRole } from '../middleware/roleMiddleware';
import { UserRole } from '../generated/prisma/enums';

// Single role
router.get('/admin/users', authMiddleware, requireRole(UserRole.ADMIN), getUsers);

// Multiple roles
router.get('/dashboard', authMiddleware, requireRole([UserRole.ADMIN, UserRole.MANAGER]), getDashboard);
```

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Code follows project standards
- [x] No linting errors
- [x] Build succeeds
- [x] Middleware can be used with auth routes

---

*Ticket created: 2026-02-09*
