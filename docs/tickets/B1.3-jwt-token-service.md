# B1.3: Implement JWT Token Service

**Sprint:** 1
**Type:** Backend - Feature
**Priority:** High
**Status:** In Progress
**Branch:** feature/sprint1-B1.3-jwt-token-service
**Created:** 2026-02-06
**Dependencies:** B1.2 (Auth service) - Completed

---

## Description

Implement JWT token service for authentication following the single-session design (ADR-001). The service will generate access tokens (short-lived) and refresh tokens (long-lived, stored hashed in DB). This service will be used by the auth controller to issue tokens on login and refresh them when expired.

Key features:
- Generate signed JWT access tokens with user payload
- Generate refresh tokens and store hash in User.refreshTokenHash
- Verify and decode access tokens
- Refresh token rotation (issue new tokens, invalidate old refresh token)
- Configurable expiration via environment variables

---

## Acceptance Criteria

- [x] `generateAccessToken(user)` returns a signed JWT with user id, email, role
- [x] `generateRefreshToken(userId)` returns token and stores hash in DB
- [x] `verifyAccessToken(token)` returns decoded payload or throws error
- [x] `refreshTokens(refreshToken)` validates and returns new token pair
- [x] `refreshTokens` invalidates old refresh token (rotation)
- [x] JWT_SECRET is required in production environment
- [x] Expiration times are configurable via env vars
- [x] Access token expiration defaults to 15 minutes
- [x] Refresh tokens stored hashed in DB (no JWT expiration, session-based)
- [x] All functions have proper TypeScript types
- [x] Unit tests cover happy path and error scenarios
- [x] Unit tests achieve 90% coverage for new code
- [x] All tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Purpose |
|------|---------|
| `backend/src/application/services/tokenService.ts` | JWT token generation, verification, refresh |
| `backend/src/application/services/tokenService.test.ts` | Unit tests for token service |
| `backend/src/domain/errors/AuthError.ts` | Add TokenExpiredError, InvalidTokenError |
| `backend/src/config/env.ts` | Make JWT_SECRET required in production |
| `backend/package.json` | Add jsonwebtoken dependency |

---

## Implementation Steps

### Step 1: Install Dependencies

```bash
cd backend && npm install jsonwebtoken && npm install -D @types/jsonwebtoken
```

### Step 2: Update Domain Errors

Add to `backend/src/domain/errors/AuthError.ts`:

```typescript
export class TokenExpiredError extends AuthError {
  constructor() {
    super('Token has expired', 'TOKEN_EXPIRED');
    this.name = 'TokenExpiredError';
  }
}

export class InvalidTokenError extends AuthError {
  constructor() {
    super('Invalid token', 'INVALID_TOKEN');
    this.name = 'InvalidTokenError';
  }
}
```

### Step 3: Update Environment Config

Modify `backend/src/config/env.ts`:
- Make JWT_SECRET required when NODE_ENV is 'production'
- Add default values for expiration times
- Parse expiration strings to support formats like "15m", "7d"

```typescript
JWT_SECRET: z.string().min(32).optional()
  .refine((val) => process.env.NODE_ENV !== 'production' || val, {
    message: 'JWT_SECRET is required in production',
  }),
JWT_ACCESS_EXPIRATION: z.string().default('15m'),
JWT_REFRESH_EXPIRATION: z.string().default('7d'),
```

### Step 4: Write Token Service Tests (TDD - Red Phase)

Create `backend/src/application/services/tokenService.test.ts`:

**Test categories:**

1. **generateAccessToken tests:**
   - should return a valid JWT string
   - should include user id, email, role in payload
   - should set correct expiration time
   - should throw if JWT_SECRET not configured

2. **generateRefreshToken tests:**
   - should return a refresh token string
   - should store hashed token in database
   - should throw UserNotFoundError if user doesn't exist

3. **verifyAccessToken tests:**
   - should return decoded payload for valid token
   - should throw TokenExpiredError for expired token
   - should throw InvalidTokenError for malformed token
   - should throw InvalidTokenError for wrong signature

4. **refreshTokens tests:**
   - should return new access and refresh tokens
   - should invalidate old refresh token (update hash in DB)
   - should throw InvalidTokenError for invalid refresh token
   - should throw InvalidTokenError if stored hash doesn't match
   - should throw UserNotFoundError if user doesn't exist

### Step 5: Implement Token Service (TDD - Green Phase)

Create `backend/src/application/services/tokenService.ts`:

```typescript
// Types
export interface TokenPayload {
  userId: string;
  email: string;
  role: UserRole;
}

export interface TokenPair {
  accessToken: string;
  refreshToken: string;
}

// Functions
export function generateAccessToken(user: AuthUser): string
export async function generateRefreshToken(userId: string): Promise<string>
export function verifyAccessToken(token: string): TokenPayload
export async function refreshTokens(refreshToken: string, userId: string): Promise<TokenPair>
```

**Implementation details:**

1. **generateAccessToken:**
   - Sign JWT with payload { userId, email, role }
   - Use env.JWT_SECRET for signing
   - Set expiresIn from env.JWT_ACCESS_EXPIRATION
   - Throw if JWT_SECRET not configured

2. **generateRefreshToken:**
   - Generate random token (crypto.randomBytes)
   - Hash token with bcrypt
   - Store hash in User.refreshTokenHash
   - Return plain token to client

3. **verifyAccessToken:**
   - Verify JWT signature with JWT_SECRET
   - Return decoded payload
   - Catch jwt errors and map to domain errors

4. **refreshTokens:**
   - Find user by userId
   - Compare provided refresh token with stored hash
   - Generate new token pair
   - Update refreshTokenHash in DB (rotation)
   - Return new tokens

### Step 6: Refactor

1. Extract token generation helpers if needed
2. Ensure consistent error handling
3. Add JSDoc comments for public functions

---

## Technical Notes

### JWT Structure

**Access Token Payload:**
```json
{
  "userId": "uuid",
  "email": "user@example.com",
  "role": "TARGET",
  "iat": 1234567890,
  "exp": 1234568790
}
```

### Security Considerations

- JWT_SECRET must be at least 32 characters
- Refresh tokens are stored hashed (bcrypt) in DB, not plain
- Refresh token rotation prevents token reuse
- Access tokens are stateless (no DB lookup required)
- Single session design: new login invalidates previous session

### Single Session Design (ADR-001)

- Only one refresh token per user at a time
- Stored in User.refreshTokenHash
- New login issues new tokens, invalidating old session
- Logout clears refreshTokenHash

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| JWT_SECRET | (required in prod) | Secret for signing JWTs |
| JWT_ACCESS_EXPIRATION | 15m | Access token lifetime |
| JWT_REFRESH_EXPIRATION | 7d | Refresh token lifetime |

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (17 new tests)
- [x] Test coverage >= 90% for new files
- [x] Code follows project standards (DDD layers, TypeScript)
- [x] No linting errors
- [x] Build succeeds
- [x] Dependencies installed (jsonwebtoken, @types/jsonwebtoken)
- [x] Production validator issues addressed (JWT_SECRET validation, runtime payload validation)

---

*Ticket created: 2026-02-06*
