# B1.7: Implement Password Reset Flow

**Sprint:** 1
**Type:** Backend - Feature
**Priority:** Medium
**Status:** Awaiting Commit Approval
**Branch:** feature/sprint1-B1.7-password-reset
**Created:** 2026-02-06
**Dependencies:** B1.2 (Auth service), B1.6 (Auth controller) - All Completed

---

## Description

Implement the password reset flow allowing users to reset their password via a secure token. The flow consists of two endpoints:

1. **Request Reset** - User submits email, system generates token and stores it
2. **Reset Password** - User submits token + new password, system validates and updates

**Note:** Email sending is out of scope for this ticket. The token will be logged to console in development (simulating email).

**Existing Schema Fields:**
- `passwordResetToken` - Stores hashed reset token
- `passwordResetExpires` - Token expiration timestamp

---

## Acceptance Criteria

- [x] `POST /api/auth/forgot-password` accepts email and generates reset token
- [x] Token is hashed before storing in database (like refresh tokens)
- [x] Token expires after 1 hour
- [x] `POST /api/auth/reset-password` accepts token and new password
- [x] Token validation checks: exists, not expired, matches hash
- [x] Password is validated with same rules as registration
- [x] After successful reset, token is cleared from database
- [x] Returns appropriate errors (user not found, invalid token, expired token)
- [x] Validation errors follow project format
- [x] Unit tests cover all scenarios
- [x] Test coverage >= 90%
- [x] All tests pass
- [x] Build succeeds
- [x] Lint passes

---

## Files to Create/Modify

| File | Action | Purpose |
|------|--------|---------|
| `backend/src/domain/errors/AuthError.ts` | Modify | Add PasswordResetTokenExpiredError, PasswordResetTokenInvalidError |
| `backend/src/application/services/authService.ts` | Modify | Add requestPasswordReset(), resetPassword() |
| `backend/src/application/services/authService.test.ts` | Modify | Add tests for new methods |
| `backend/src/application/validators/authValidator.ts` | Modify | Add validateForgotPasswordInput(), validateResetPasswordInput() |
| `backend/src/application/validators/authValidator.test.ts` | Modify | Add validator tests |
| `backend/src/presentation/controllers/authController.ts` | Modify | Add forgotPassword(), resetPassword() handlers |
| `backend/src/presentation/controllers/authController.test.ts` | Modify | Add controller tests |
| `backend/src/routes/authRoutes.ts` | Modify | Add routes |

---

## Implementation Steps

### Step 1: Add Domain Errors

Add to `backend/src/domain/errors/AuthError.ts`:

```typescript
export class PasswordResetTokenExpiredError extends Error {
  code = 'PASSWORD_RESET_TOKEN_EXPIRED';
  constructor() {
    super('Password reset token has expired');
  }
}

export class PasswordResetTokenInvalidError extends Error {
  code = 'PASSWORD_RESET_TOKEN_INVALID';
  constructor() {
    super('Invalid password reset token');
  }
}
```

### Step 2: Add Validators (TDD)

Add to `authValidator.ts`:

**validateForgotPasswordInput:**
- email: required, valid format

**validateResetPasswordInput:**
- token: required, string, min length 32
- newPassword: required, same complexity rules as registration

### Step 3: Add Service Methods (TDD)

Add to `authService.ts`:

**requestPasswordReset(email: string):**
1. Find user by email (normalized to lowercase)
2. If not found, return silently (security: don't reveal if email exists)
3. Generate random token (32 bytes hex)
4. Hash token with bcrypt
5. Store hash + expiration (now + 1 hour) in user record
6. Log token to console (simulating email)
7. Return void

**resetPassword(token: string, newPassword: string):**
1. Find user with non-null passwordResetToken and valid expiration
2. Compare provided token with stored hash
3. If invalid, throw PasswordResetTokenInvalidError
4. If expired, throw PasswordResetTokenExpiredError
5. Hash new password
6. Update user: passwordHash = new hash, clear reset token fields
7. Return void

### Step 4: Add Controller Handlers (TDD)

**forgotPassword:**
- Validate input
- Call authService.requestPasswordReset()
- Return 200 with generic message (always same response for security)

**resetPassword:**
- Validate input
- Call authService.resetPassword()
- Return 200 with success message
- Handle PasswordResetTokenInvalidError → 400
- Handle PasswordResetTokenExpiredError → 400
- Handle ValidationError → 400

### Step 5: Add Routes

```typescript
router.post('/forgot-password', forgotPassword);
router.post('/reset-password', resetPassword);
```

---

## API Specification

### POST /api/auth/forgot-password

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Response (200):** Always returns success (security)
```json
{
  "success": true,
  "data": {
    "message": "If an account exists with this email, a password reset link has been sent"
  }
}
```

### POST /api/auth/reset-password

**Request:**
```json
{
  "token": "abc123...",
  "newPassword": "NewSecurePass123!"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "message": "Password has been reset successfully"
  }
}
```

**Error Response (400):**
```json
{
  "success": false,
  "error": {
    "message": "Invalid password reset token",
    "code": "PASSWORD_RESET_TOKEN_INVALID"
  }
}
```

---

## Error Responses

| Scenario | Status | Code |
|----------|--------|------|
| Validation failed | 400 | VALIDATION_ERROR |
| Invalid token | 400 | PASSWORD_RESET_TOKEN_INVALID |
| Expired token | 400 | PASSWORD_RESET_TOKEN_EXPIRED |

---

## Security Considerations

1. **Timing attacks**: Always return same response for forgot-password (don't reveal if email exists)
2. **Token security**: Hash tokens before storing (like refresh tokens)
3. **Token expiration**: 1 hour maximum validity
4. **Single use**: Clear token after successful reset
5. **Password validation**: Same complexity rules as registration

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Test coverage >= 90% for new code
- [x] Code follows project standards (DDD layers)
- [x] No linting errors
- [x] Build succeeds
- [x] Security considerations implemented

---

*Ticket created: 2026-02-06*
